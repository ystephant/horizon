<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#020d1a" />
  <title>Horizon â€” Ce qui est devant vous</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --cyan: #00e5ff;
      --cyan-dim: rgba(0,229,255,0.15);
      --cyan-border: rgba(0,229,255,0.35);
      --gold: #fbbf24;
      --bg: #020d1a;
      --surface: rgba(2,18,34,0.82);
      --text: #e0f4ff;
      --muted: rgba(180,220,240,0.5);
      --red: #ff4d6d;
      --green: #22d3a0;
      --fov: 70; /* degrees horizontal FOV */
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Syne', sans-serif;
      overflow: hidden;
      height: 100dvh;
      width: 100dvw;
      user-select: none;
    }

    /* â”€â”€ CAMERA â”€â”€ */
    #camera-feed {
      position: fixed;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 0;
    }

    /* â”€â”€ OVERLAY GLOBAL â”€â”€ */
    #ar-overlay {
      position: fixed;
      inset: 0;
      z-index: 10;
      pointer-events: none;
    }

    /* â”€â”€ VIGNETTE â”€â”€ */
    .vignette {
      position: fixed;
      inset: 0;
      z-index: 5;
      background: radial-gradient(ellipse at center, transparent 45%, rgba(2,13,26,0.6) 100%);
      pointer-events: none;
    }

    /* â”€â”€ HORIZON LINE â”€â”€ */
    .horizon-line {
      position: absolute;
      left: 0; right: 0;
      top: 50%;
      height: 1px;
      background: linear-gradient(to right, transparent, var(--cyan-border), transparent);
      transform: translateY(-50%);
    }

    .horizon-tick {
      position: absolute;
      top: 50%;
      transform: translate(-50%, -50%);
      width: 1px;
      height: 10px;
      background: var(--cyan-border);
    }

    /* â”€â”€ COMPASS BAR â”€â”€ */
    #compass-bar {
      position: fixed;
      top: 0;
      left: 0; right: 0;
      z-index: 20;
      padding: 0;
      height: 52px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(to bottom, rgba(2,13,26,0.9), transparent);
      pointer-events: none;
      overflow: hidden;
    }

    #compass-track {
      position: relative;
      width: 100%;
      height: 52px;
      display: flex;
      align-items: center;
      overflow: hidden;
    }

    .compass-label {
      position: absolute;
      top: 50%;
      transform: translateX(-50%) translateY(-50%);
      font-family: 'Space Mono', monospace;
      font-size: 10px;
      color: var(--muted);
      letter-spacing: 0.05em;
      transition: color 0.2s;
    }
    .compass-label.cardinal {
      font-size: 12px;
      font-weight: 700;
      color: var(--cyan);
    }
    .compass-label.center-highlight {
      color: white;
    }

    /* Center reticle on compass */
    #compass-center {
      position: absolute;
      left: 50%;
      top: 0; bottom: 0;
      width: 1px;
      background: var(--cyan);
      transform: translateX(-50%);
      z-index: 2;
    }
    #compass-center::before {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 5px; height: 5px;
      background: var(--cyan);
      border-radius: 50%;
    }

    /* â”€â”€ HEADING DISPLAY â”€â”€ */
    #heading-display {
      position: fixed;
      top: 56px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 20;
      font-family: 'Space Mono', monospace;
      font-size: 13px;
      color: var(--cyan);
      background: var(--surface);
      border: 1px solid var(--cyan-border);
      border-radius: 20px;
      padding: 4px 14px;
      letter-spacing: 0.1em;
      backdrop-filter: blur(8px);
      pointer-events: none;
    }

    /* â”€â”€ POI LABELS â”€â”€ */
    .poi-label {
      position: absolute;
      top: 38%;
      transform: translateX(-50%) translateY(-50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      pointer-events: auto;
      cursor: pointer;
      transition: opacity 0.4s, transform 0.3s;
    }

    .poi-label:hover .poi-card { border-color: var(--cyan); }

    .poi-connector {
      width: 1px;
      height: 40px;
      background: linear-gradient(to bottom, var(--cyan-border), transparent);
      margin-bottom: 4px;
    }

    .poi-dot {
      width: 6px; height: 6px;
      border-radius: 50%;
      background: var(--cyan);
      box-shadow: 0 0 8px var(--cyan), 0 0 16px rgba(0,229,255,0.3);
      position: absolute;
      top: 38%;
      transform: translate(-50%, -50%);
    }

    .poi-card {
      background: var(--surface);
      border: 1px solid var(--cyan-border);
      border-radius: 10px;
      padding: 8px 12px;
      backdrop-filter: blur(12px);
      min-width: 90px;
      max-width: 140px;
      text-align: center;
      transition: border-color 0.2s;
    }

    .poi-type-icon {
      font-size: 14px;
      margin-bottom: 2px;
      display: block;
    }

    .poi-name {
      font-family: 'Syne', sans-serif;
      font-weight: 600;
      font-size: 12px;
      color: var(--text);
      line-height: 1.2;
      word-break: break-word;
    }

    .poi-distance {
      font-family: 'Space Mono', monospace;
      font-size: 9px;
      color: var(--cyan);
      margin-top: 3px;
      letter-spacing: 0.08em;
    }

    /* fade by angular distance from center */
    .poi-label[data-fade="1"] { opacity: 0.85; }
    .poi-label[data-fade="2"] { opacity: 0.6; }
    .poi-label[data-fade="3"] { opacity: 0.35; }

    /* Vertical stagger to avoid overlap */
    .poi-label:nth-child(2n) { top: 32%; }
    .poi-label:nth-child(3n) { top: 45%; }

    /* â”€â”€ BOTTOM HUD â”€â”€ */
    #bottom-hud {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      z-index: 20;
      padding: 12px 20px;
      padding-bottom: max(12px, env(safe-area-inset-bottom));
      background: linear-gradient(to top, rgba(2,13,26,0.95), transparent);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    #gps-status {
      font-family: 'Space Mono', monospace;
      font-size: 10px;
      color: var(--muted);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot {
      width: 6px; height: 6px;
      border-radius: 50%;
      background: var(--muted);
      flex-shrink: 0;
    }
    .status-dot.active { background: var(--green); box-shadow: 0 0 6px var(--green); }
    .status-dot.error { background: var(--red); box-shadow: 0 0 6px var(--red); }

    #poi-count {
      font-family: 'Space Mono', monospace;
      font-size: 10px;
      color: var(--muted);
    }

    #refresh-btn {
      font-family: 'Syne', sans-serif;
      font-size: 11px;
      font-weight: 600;
      color: var(--cyan);
      background: var(--cyan-dim);
      border: 1px solid var(--cyan-border);
      border-radius: 20px;
      padding: 6px 14px;
      cursor: pointer;
      letter-spacing: 0.05em;
      backdrop-filter: blur(8px);
      transition: background 0.2s;
    }
    #refresh-btn:active { background: rgba(0,229,255,0.3); }

    /* â”€â”€ POI DETAIL PANEL â”€â”€ */
    #detail-panel {
      position: fixed;
      bottom: 70px;
      left: 16px; right: 16px;
      z-index: 30;
      background: rgba(2,18,34,0.95);
      border: 1px solid var(--cyan-border);
      border-radius: 16px;
      padding: 16px 20px;
      backdrop-filter: blur(20px);
      display: none;
      pointer-events: auto;
    }
    #detail-panel.visible { display: block; }

    #detail-close {
      position: absolute;
      top: 10px; right: 14px;
      font-size: 18px;
      color: var(--muted);
      cursor: pointer;
      background: none;
      border: none;
      color: var(--muted);
      font-family: 'Space Mono', monospace;
    }

    #detail-icon { font-size: 28px; margin-bottom: 6px; }
    #detail-name {
      font-size: 20px;
      font-weight: 800;
      color: var(--text);
      margin-bottom: 4px;
    }
    #detail-type {
      font-family: 'Space Mono', monospace;
      font-size: 10px;
      color: var(--cyan);
      letter-spacing: 0.1em;
      text-transform: uppercase;
      margin-bottom: 10px;
    }
    #detail-meta {
      display: flex;
      gap: 20px;
    }
    .detail-meta-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .detail-meta-label {
      font-family: 'Space Mono', monospace;
      font-size: 9px;
      color: var(--muted);
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }
    .detail-meta-value {
      font-family: 'Space Mono', monospace;
      font-size: 13px;
      color: var(--text);
      font-weight: 700;
    }

    /* â”€â”€ STARTUP SCREEN â”€â”€ */
    #startup {
      position: fixed;
      inset: 0;
      z-index: 100;
      background: var(--bg);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 32px;
      padding: 40px;
    }

    .startup-logo {
      font-family: 'Syne', sans-serif;
      font-size: 48px;
      font-weight: 800;
      color: var(--text);
      letter-spacing: -0.03em;
      text-align: center;
      line-height: 1;
    }
    .startup-logo span {
      color: var(--cyan);
    }

    .startup-subtitle {
      font-family: 'Space Mono', monospace;
      font-size: 11px;
      color: var(--muted);
      letter-spacing: 0.15em;
      text-align: center;
    }

    .startup-perms {
      display: flex;
      flex-direction: column;
      gap: 10px;
      width: 100%;
    }

    .perm-item {
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(0,229,255,0.05);
      border: 1px solid var(--cyan-border);
      border-radius: 12px;
      padding: 12px 16px;
      font-size: 13px;
      color: var(--muted);
    }
    .perm-item .perm-icon { font-size: 20px; flex-shrink: 0; }
    .perm-item .perm-status {
      margin-left: auto;
      font-family: 'Space Mono', monospace;
      font-size: 10px;
      color: var(--muted);
    }
    .perm-item.granted { border-color: rgba(34,211,160,0.4); }
    .perm-item.granted .perm-status { color: var(--green); }

    #start-btn {
      width: 100%;
      background: var(--cyan);
      color: var(--bg);
      border: none;
      border-radius: 14px;
      padding: 16px;
      font-family: 'Syne', sans-serif;
      font-size: 16px;
      font-weight: 800;
      cursor: pointer;
      letter-spacing: 0.05em;
      transition: opacity 0.2s;
    }
    #start-btn:active { opacity: 0.8; }

    /* â”€â”€ LOADING â”€â”€ */
    #loading-ring {
      position: fixed;
      top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      z-index: 25;
      display: none;
    }
    #loading-ring.visible { display: block; }
    #loading-ring svg { animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ COMPASS CALIBRATION WARNING â”€â”€ */
    #compass-warning {
      position: fixed;
      top: 110px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 25;
      background: rgba(251,191,36,0.15);
      border: 1px solid rgba(251,191,36,0.5);
      border-radius: 20px;
      padding: 6px 16px;
      font-family: 'Space Mono', monospace;
      font-size: 10px;
      color: var(--gold);
      letter-spacing: 0.05em;
      pointer-events: none;
      display: none;
    }

    /* grid overlay lines (subtle) */
    .grid-line-h, .grid-line-v {
      position: absolute;
      background: rgba(0,229,255,0.04);
      pointer-events: none;
    }
    .grid-line-h { left: 0; right: 0; height: 1px; top: 33%; }
    .grid-line-h:nth-child(2) { top: 66%; }
    .grid-line-v { top: 0; bottom: 0; width: 1px; left: 33%; }
    .grid-line-v:nth-child(4) { left: 66%; }

    /* center crosshair */
    .crosshair-h {
      position: absolute;
      top: 50%; left: calc(50% - 20px);
      width: 40px; height: 1px;
      background: rgba(0,229,255,0.3);
      transform: translateY(-50%);
    }
    .crosshair-v {
      position: absolute;
      left: 50%; top: calc(50% - 20px);
      width: 1px; height: 40px;
      background: rgba(0,229,255,0.3);
      transform: translateX(-50%);
    }
  </style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     STARTUP SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="startup">
  <div>
    <div class="startup-logo">HORI<span>ZON</span></div>
    <div class="startup-subtitle">CE QUI EST DEVANT VOUS</div>
  </div>

  <div class="startup-perms">
    <div class="perm-item" id="perm-camera">
      <span class="perm-icon">ğŸ“·</span>
      <span>CamÃ©ra</span>
      <span class="perm-status">EN ATTENTE</span>
    </div>
    <div class="perm-item" id="perm-gps">
      <span class="perm-icon">ğŸ“</span>
      <span>Localisation GPS</span>
      <span class="perm-status">EN ATTENTE</span>
    </div>
    <div class="perm-item" id="perm-compass">
      <span class="perm-icon">ğŸ§­</span>
      <span>Boussole / Orientation</span>
      <span class="perm-status">EN ATTENTE</span>
    </div>
  </div>

  <button id="start-btn" onclick="initApp()">DÃ©marrer</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CAMERA FEED
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<video id="camera-feed" autoplay playsinline muted></video>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     VISUAL OVERLAYS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="vignette"></div>

<div id="ar-overlay">
  <!-- Grid -->
  <div class="grid-line-h"></div>
  <div class="grid-line-h"></div>
  <div class="grid-line-v"></div>
  <div class="grid-line-v"></div>
  <!-- Crosshair -->
  <div class="crosshair-h"></div>
  <div class="crosshair-v"></div>
  <!-- Horizon line -->
  <div class="horizon-line"></div>
  <!-- POI container -->
  <div id="poi-container"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     COMPASS BAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="compass-bar">
  <div id="compass-track">
    <div id="compass-center"></div>
  </div>
</div>
<div id="heading-display">---Â° N</div>
<div id="compass-warning">âš  Calibrez la boussole â€” tournez en 8</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     BOTTOM HUD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="bottom-hud">
  <div id="gps-status">
    <div class="status-dot" id="gps-dot"></div>
    <span id="gps-text">GPS inactif</span>
  </div>
  <div id="poi-count">â€” points dÃ©tectÃ©s</div>
  <button id="refresh-btn" onclick="refreshPOIs()">â†» RafraÃ®chir</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LOADING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="loading-ring">
  <svg width="36" height="36" viewBox="0 0 36 36">
    <circle cx="18" cy="18" r="14" fill="none" stroke="rgba(0,229,255,0.15)" stroke-width="3"/>
    <circle cx="18" cy="18" r="14" fill="none" stroke="#00e5ff" stroke-width="3"
      stroke-dasharray="20 68" stroke-linecap="round"/>
  </svg>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     DETAIL PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="detail-panel">
  <button id="detail-close" onclick="closeDetail()">âœ•</button>
  <div id="detail-icon">ğŸ“</div>
  <div id="detail-name">â€”</div>
  <div id="detail-type">â€”</div>
  <div id="detail-meta">
    <div class="detail-meta-item">
      <span class="detail-meta-label">Distance</span>
      <span class="detail-meta-value" id="detail-dist">â€”</span>
    </div>
    <div class="detail-meta-item">
      <span class="detail-meta-label">Direction</span>
      <span class="detail-meta-value" id="detail-bearing">â€”</span>
    </div>
    <div class="detail-meta-item">
      <span class="detail-meta-label">CoordonnÃ©es</span>
      <span class="detail-meta-value" id="detail-coords">â€”</span>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const state = {
  userLat: null,
  userLng: null,
  heading: null,       // degrees 0-360, 0=North
  headingRaw: null,
  pois: [],
  compassSource: null, // 'ios' | 'absolute' | 'relative'
  compassReady: false,
  gpsReady: false,
  lastFetchLat: null,
  lastFetchLng: null,
  animFrame: null,
};

const FOV = 75; // horizontal field of view in degrees
const FOV_HALF = FOV / 2;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function initApp() {
  document.getElementById('start-btn').disabled = true;
  document.getElementById('start-btn').textContent = 'Initialisationâ€¦';

  // 1. Camera
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } },
      audio: false
    });
    document.getElementById('camera-feed').srcObject = stream;
    setPermStatus('camera', true);
  } catch (e) {
    setPermStatus('camera', false);
    alert('CamÃ©ra non disponible : ' + e.message);
    document.getElementById('start-btn').disabled = false;
    document.getElementById('start-btn').textContent = 'DÃ©marrer';
    return;
  }

  // 2. Geolocation
  if (!navigator.geolocation) {
    setPermStatus('gps', false);
  } else {
    setPermStatus('gps', true, 'ACTIF');
    navigator.geolocation.watchPosition(onGPS, onGPSError, {
      enableHighAccuracy: true, maximumAge: 5000, timeout: 15000
    });
  }

  // 3. Compass â€” iOS needs permission request
  if (typeof DeviceOrientationEvent !== 'undefined' &&
      typeof DeviceOrientationEvent.requestPermission === 'function') {
    try {
      const perm = await DeviceOrientationEvent.requestPermission();
      if (perm === 'granted') {
        window.addEventListener('deviceorientation', onOrientation, true);
        setPermStatus('compass', true);
      } else {
        setPermStatus('compass', false);
      }
    } catch (e) {
      setPermStatus('compass', false);
    }
  } else {
    // Android / desktop
    window.addEventListener('deviceorientationabsolute', onOrientationAbsolute, true);
    window.addEventListener('deviceorientation', onOrientation, true);
    setPermStatus('compass', true, 'ACTIF');
  }

  // Hide startup, show app
  document.getElementById('startup').style.transition = 'opacity 0.6s';
  document.getElementById('startup').style.opacity = '0';
  setTimeout(() => document.getElementById('startup').style.display = 'none', 600);

  // Start render loop
  renderLoop();
}

function setPermStatus(perm, ok, label) {
  const el = document.getElementById('perm-' + perm);
  const status = el.querySelector('.perm-status');
  if (ok) {
    el.classList.add('granted');
    status.textContent = label || 'OK';
  } else {
    status.textContent = 'REFUSÃ‰';
    status.style.color = 'var(--red)';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GEOLOCATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onGPS(pos) {
  state.userLat = pos.coords.latitude;
  state.userLng = pos.coords.longitude;
  state.gpsReady = true;

  document.getElementById('gps-dot').classList.add('active');
  const acc = Math.round(pos.coords.accuracy);
  document.getElementById('gps-text').textContent =
    `${state.userLat.toFixed(5)}, ${state.userLng.toFixed(5)} Â±${acc}m`;

  // Fetch POIs if moved more than 200m or first time
  const d = state.lastFetchLat !== null
    ? haversine(state.userLat, state.userLng, state.lastFetchLat, state.lastFetchLng)
    : Infinity;
  if (d > 200) fetchPOIs();
}

function onGPSError(err) {
  document.getElementById('gps-dot').classList.add('error');
  document.getElementById('gps-text').textContent = 'Erreur GPS: ' + err.message;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COMPASS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function onOrientationAbsolute(e) {
  if (e.alpha === null) return;
  // alpha=0 means pointing North (when absolute)
  state.heading = (360 - e.alpha + 360) % 360;
  state.compassSource = 'absolute';
  state.compassReady = true;
}

function onOrientation(e) {
  if (state.compassSource === 'absolute') return; // prefer absolute

  // iOS: webkitCompassHeading = degrees clockwise from magnetic north
  if (e.webkitCompassHeading !== undefined && e.webkitCompassHeading !== null) {
    state.heading = e.webkitCompassHeading;
    state.compassSource = 'ios';
    state.compassReady = true;
    return;
  }

  // Android fallback using alpha (not north-referenced without absolute)
  if (e.alpha !== null) {
    state.heading = (360 - e.alpha + 360) % 360;
    state.compassSource = 'relative';
    state.compassReady = true;
    document.getElementById('compass-warning').style.display = 'block';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FETCH POIs via Overpass API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchPOIs() {
  if (!state.userLat) return;
  document.getElementById('loading-ring').classList.add('visible');

  const lat = state.userLat;
  const lng = state.userLng;
  const radius = 50000; // 50km

  const query = `
[out:json][timeout:25];
(
  node["place"~"^(island|islet|city|town|village|hamlet|suburb|quarter)$"](around:${radius},${lat},${lng});
  node["natural"~"^(peak|volcano|cliff|cape|bay|strait)$"](around:${radius},${lat},${lng});
  node["man_made"="lighthouse"](around:${radius},${lat},${lng});
  way["place"~"^(island|islet)$"](around:${radius},${lat},${lng});
  relation["place"~"^(island|islet)$"](around:${radius},${lat},${lng});
);
out center 200;
  `.trim();

  try {
    const resp = await fetch('https://overpass-api.de/api/interpreter', {
      method: 'POST',
      body: query
    });
    const data = await resp.json();
    processPOIs(data.elements, lat, lng);
    state.lastFetchLat = lat;
    state.lastFetchLng = lng;
  } catch (e) {
    console.warn('Overpass error, trying fallbackâ€¦', e);
    // Fallback: nominatim reverse for nearby places
    await fetchNominatimFallback(lat, lng);
  } finally {
    document.getElementById('loading-ring').classList.remove('visible');
  }
}

async function fetchNominatimFallback(lat, lng) {
  try {
    const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json&addressdetails=1&zoom=10`;
    const resp = await fetch(url, { headers: { 'Accept-Language': 'fr' } });
    const data = await resp.json();
    // Provide at least a location name
    if (data && data.display_name) {
      document.getElementById('gps-text').textContent =
        data.address?.city || data.address?.town || data.address?.village || data.display_name;
    }
  } catch(e) { console.warn(e); }
}

function processPOIs(elements, userLat, userLng) {
  const seen = new Set();
  const results = [];

  for (const el of elements) {
    const elLat = el.lat ?? el.center?.lat;
    const elLng = el.lon ?? el.center?.lon;
    if (!elLat || !elLng) continue;

    const name = el.tags?.name || el.tags?.['name:fr'];
    if (!name) continue;
    if (seen.has(name)) continue;
    seen.add(name);

    const dist = haversine(userLat, userLng, elLat, elLng);
    if (dist < 50) continue; // skip if too close (user is there)

    const bearing = calcBearing(userLat, userLng, elLat, elLng);
    const type = classifyPOI(el.tags);

    results.push({ name, lat: elLat, lng: elLng, dist, bearing, type, tags: el.tags });
  }

  // Sort by distance, keep best 60
  results.sort((a, b) => a.dist - b.dist);
  state.pois = results.slice(0, 60);
  document.getElementById('poi-count').textContent =
    `${state.pois.length} point${state.pois.length > 1 ? 's' : ''} dÃ©tectÃ©${state.pois.length > 1 ? 's' : ''}`;
}

function classifyPOI(tags) {
  if (!tags) return { emoji: 'ğŸ“', label: 'Lieu' };
  const place = tags.place;
  const natural = tags.natural;
  const manMade = tags.man_made;

  if (place === 'island' || place === 'islet') return { emoji: 'ğŸï¸', label: 'Ãle' };
  if (natural === 'peak' || natural === 'volcano') return { emoji: 'â›°ï¸', label: 'Sommet' };
  if (natural === 'cape') return { emoji: 'ğŸ—ºï¸', label: 'Cap' };
  if (natural === 'bay') return { emoji: 'ğŸŒŠ', label: 'Baie' };
  if (natural === 'strait') return { emoji: 'ã€°ï¸', label: 'DÃ©troit' };
  if (natural === 'cliff') return { emoji: 'ğŸª¨', label: 'Falaise' };
  if (manMade === 'lighthouse') return { emoji: 'ğŸ—¼', label: 'Phare' };
  if (place === 'city') return { emoji: 'ğŸ™ï¸', label: 'Ville' };
  if (place === 'town') return { emoji: 'ğŸ˜ï¸', label: 'Bourg' };
  if (place === 'village' || place === 'hamlet') return { emoji: 'ğŸ¡', label: 'Village' };
  return { emoji: 'ğŸ“', label: 'Lieu' };
}

function refreshPOIs() {
  state.lastFetchLat = null;
  state.lastFetchLng = null;
  if (state.gpsReady) fetchPOIs();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderLoop() {
  updateCompassBar();
  updatePOILabels();
  updateHeadingDisplay();
  state.animFrame = requestAnimationFrame(renderLoop);
}

// â”€â”€ Compass bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const COMPASS_POINTS = [
  { deg: 0, label: 'N' }, { deg: 22.5, label: 'NNE' },
  { deg: 45, label: 'NE' }, { deg: 67.5, label: 'ENE' },
  { deg: 90, label: 'E' }, { deg: 112.5, label: 'ESE' },
  { deg: 135, label: 'SE' }, { deg: 157.5, label: 'SSE' },
  { deg: 180, label: 'S' }, { deg: 202.5, label: 'SSO' },
  { deg: 225, label: 'SO' }, { deg: 247.5, label: 'OSO' },
  { deg: 270, label: 'O' }, { deg: 292.5, label: 'ONO' },
  { deg: 315, label: 'NO' }, { deg: 337.5, label: 'NNO' },
];

let compassLabelsBuilt = false;
function buildCompassLabels() {
  const track = document.getElementById('compass-track');
  COMPASS_POINTS.forEach(p => {
    const el = document.createElement('div');
    el.className = 'compass-label' + ([0,90,180,270].includes(p.deg) ? ' cardinal' : '');
    el.textContent = p.label;
    el.dataset.deg = p.deg;
    track.appendChild(el);
  });
  compassLabelsBuilt = true;
}

function updateCompassBar() {
  if (!compassLabelsBuilt) buildCompassLabels();
  if (state.heading === null) return;

  const track = document.getElementById('compass-track');
  const W = track.offsetWidth;
  const degsPerPx = FOV / W; // how many degrees per pixel

  document.querySelectorAll('.compass-label').forEach(el => {
    const deg = parseFloat(el.dataset.deg);
    let diff = normalizeDeg(deg - state.heading);
    // diff in -180..180, center at 0
    const x = W / 2 + diff / FOV * W;
    if (x < -40 || x > W + 40) {
      el.style.display = 'none';
    } else {
      el.style.display = '';
      el.style.left = x + 'px';
      const fade = Math.abs(diff) / FOV_HALF;
      el.style.opacity = Math.max(0, 1 - fade * 0.8);
    }
  });
}

function updateHeadingDisplay() {
  if (state.heading === null) return;
  const h = Math.round(state.heading);
  const cardinal = headingToCardinal(h);
  document.getElementById('heading-display').textContent = `${h.toString().padStart(3,'0')}Â° ${cardinal}`;
}

// â”€â”€ POI labels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const poiContainer = document.getElementById('poi-container');
const poiElements = new Map(); // name -> element

function updatePOILabels() {
  if (state.heading === null || !state.gpsReady) return;

  const W = window.innerWidth;
  const visible = [];

  for (const poi of state.pois) {
    let diff = normalizeDeg(poi.bearing - state.heading);
    if (Math.abs(diff) > FOV_HALF * 1.2) continue; // outside FOV
    visible.push({ poi, diff });
  }

  // Remove POIs no longer visible
  for (const [name, el] of poiElements) {
    if (!visible.find(v => v.poi.name === name)) {
      el.remove();
      poiElements.delete(name);
    }
  }

  // Add / update visible POIs
  for (const { poi, diff } of visible) {
    let el = poiElements.get(poi.name);
    if (!el) {
      el = createPOIElement(poi);
      poiContainer.appendChild(el);
      poiElements.set(poi.name, el);
    }

    const x = W / 2 + (diff / FOV_HALF) * (W / 2);
    el.style.left = x + 'px';

    // Fade by angular distance
    const absDiff = Math.abs(diff);
    const fade = absDiff > FOV_HALF * 0.7 ? 3 : absDiff > FOV_HALF * 0.4 ? 2 : 1;
    el.dataset.fade = fade;
  }
}

function createPOIElement(poi) {
  const el = document.createElement('div');
  el.className = 'poi-label';
  // Stagger vertical position by name hash
  const hash = poi.name.split('').reduce((a,c) => a + c.charCodeAt(0), 0);
  const tops = [28, 35, 42, 22, 48];
  el.style.top = tops[hash % tops.length] + '%';

  const dot = document.createElement('div');
  dot.className = 'poi-dot';
  dot.style.top = el.style.top;

  const connector = document.createElement('div');
  connector.className = 'poi-connector';

  const card = document.createElement('div');
  card.className = 'poi-card';
  card.innerHTML = `
    <span class="poi-type-icon">${poi.type.emoji}</span>
    <div class="poi-name">${poi.name}</div>
    <div class="poi-distance">${formatDist(poi.dist)}</div>
  `;

  el.appendChild(connector);
  el.appendChild(card);
  el.addEventListener('click', () => showDetail(poi));
  return el;
}

function showDetail(poi) {
  document.getElementById('detail-icon').textContent = poi.type.emoji;
  document.getElementById('detail-name').textContent = poi.name;
  document.getElementById('detail-type').textContent = poi.type.label.toUpperCase();
  document.getElementById('detail-dist').textContent = formatDist(poi.dist);
  document.getElementById('detail-bearing').textContent =
    Math.round(poi.bearing) + 'Â° ' + headingToCardinal(poi.bearing);
  document.getElementById('detail-coords').textContent =
    poi.lat.toFixed(4) + ', ' + poi.lng.toFixed(4);
  document.getElementById('detail-panel').classList.add('visible');
}

function closeDetail() {
  document.getElementById('detail-panel').classList.remove('visible');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GEO MATH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371000; // metres
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 +
    Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}

function calcBearing(lat1, lon1, lat2, lon2) {
  const Ï†1 = lat1 * Math.PI / 180;
  const Ï†2 = lat2 * Math.PI / 180;
  const Î”Î» = (lon2 - lon1) * Math.PI / 180;
  const y = Math.sin(Î”Î») * Math.cos(Ï†2);
  const x = Math.cos(Ï†1)*Math.sin(Ï†2) - Math.sin(Ï†1)*Math.cos(Ï†2)*Math.cos(Î”Î»);
  return (Math.atan2(y, x) * 180 / Math.PI + 360) % 360;
}

// Normalize angle to -180..+180
function normalizeDeg(d) {
  d = ((d % 360) + 360) % 360;
  if (d > 180) d -= 360;
  return d;
}

function headingToCardinal(deg) {
  const dirs = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSO','SO','OSO','O','ONO','NO','NNO'];
  return dirs[Math.round(deg / 22.5) % 16];
}

function formatDist(m) {
  if (m < 1000) return Math.round(m) + ' m';
  return (m / 1000).toFixed(1) + ' km';
}
</script>
</body>
</html>
