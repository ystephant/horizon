<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DISTS = [
  {l:'500m', v:500},{l:'1km',v:1000},{l:'2km',v:2000},
  {l:'5km',v:5000},{l:'10km',v:10000},{l:'25km',v:25000},
  {l:'50km',v:50000},{l:'100km',v:100000},
];

const CATS = [
  {id:'all',lb:'ğŸŒ Tout',cc:'#00e5ff'},
  {id:'city',lb:'ğŸ™ Villes',cc:'#a78bfa'},
  {id:'coast',lb:'ğŸ—º CÃ´tes',cc:'#38bdf8'},
  {id:'isle',lb:'ğŸ Ãles',cc:'#34d399'},
  {id:'mount',lb:'â›° Montagnes',cc:'#fb923c'},
  {id:'wood',lb:'ğŸŒ² ForÃªts',cc:'#4ade80'},
  {id:'lh',lb:'ğŸ—¼ Phares',cc:'#fbbf24'},
  {id:'site',lb:'ğŸ“Œ Lieux-dits',cc:'#f472b6'},
  {id:'beach',lb:'ğŸ– Plages',cc:'#fcd34d'},
];

const FOV = 75;
const FOV2 = FOV/2;
const ALPHA = 0.25;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S={
  lat:null,lng:null,
  hRaw:null,hSm:null,hOff:0,
  cSrc:null,
  gpsOk:false,gpsMan:false,
  allPOIs:[],pois:[],
  fetchLat:null,fetchLng:null,
  maxD:10000,
  cat:'all',
  detPOI:null,
};

const poiEls=new Map();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function rad(x){return x*Math.PI/180}
function hav(lat1,lon1,lat2,lon2){
  const R=6371000;
  const dLat=rad(lat2-lat1);
  const dLon=rad(lon2-lon1);
  const a=Math.sin(dLat/2)**2+
    Math.cos(rad(lat1))*Math.cos(rad(lat2))*
    Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}
function brg(lat1,lon1,lat2,lon2){
  const y=Math.sin(rad(lon2-lon1))*Math.cos(rad(lat2));
  const x=Math.cos(rad(lat1))*Math.sin(rad(lat2))-
    Math.sin(rad(lat1))*Math.cos(rad(lat2))*Math.cos(rad(lon2-lon1));
  return (Math.atan2(y,x)*180/Math.PI+360)%360;
}
function ndeg(d){return ((d+540)%360)-180}
function fmt(m){return m<1000?Math.round(m)+'m':(m/1000).toFixed(1)+'km'}
function card(d){
  const dirs=['N','NE','E','SE','S','SO','O','NO'];
  return dirs[Math.round(d/45)%8];
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function startGPS(){
  navigator.geolocation.getCurrentPosition(onGPS,onGPSErr,
    {enableHighAccuracy:true});
  navigator.geolocation.watchPosition(onGPS,onGPSErr,
    {enableHighAccuracy:true});
}
function onGPS(pos){
  if(S.gpsMan)return;

  const oldLat=S.lat,oldLng=S.lng;

  S.lat=pos.coords.latitude;
  S.lng=pos.coords.longitude;
  S.gpsOk=true;

  if(S.allPOIs.length){
    S.allPOIs.forEach(p=>{
      p.dist=hav(S.lat,S.lng,p.lat,p.lng);
      p.bearing=brg(S.lat,S.lng,p.lat,p.lng);
    });
    S.allPOIs.sort((a,b)=>a.dist-b.dist);
    applyFilter();
  }

  const moved=S.fetchLat?hav(S.lat,S.lng,S.fetchLat,S.fetchLng):Infinity;
  if(moved>100) fetchPOIs();
}
function onGPSErr(){}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMPASS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updRaw(r){
  S.hRaw=r;
  if(S.hSm==null){S.hSm=r;return;}
  let d=r-S.hSm;
  if(d>180)d-=360;if(d<-180)d+=360;
  S.hSm=(S.hSm+ALPHA*d+360)%360;
}
function getH(){return S.hSm==null?null:(S.hSm+S.hOff+360)%360}

window.addEventListener('deviceorientation',e=>{
  if(e.webkitCompassHeading!=null){
    updRaw(e.webkitCompassHeading);
    S.cSrc='ios';
  }else if(e.alpha!=null){
    updRaw((360-e.alpha+360)%360);
    S.cSrc='abs';
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FETCH POIs (WIKIPEDIA ONLY STABLE VERSION)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchPOIs(){
  if(!S.lat)return;
  const url=`https://fr.wikipedia.org/w/api.php?action=query&list=geosearch&gsradius=10000&gslatitude=${S.lat}&gslongitude=${S.lng}&gslimit=50&format=json&origin=*`;
  const data=await fetch(url).then(r=>r.json()).catch(()=>null);
  if(!data)return;
  const res=[];
  for(const p of data.query.geosearch){
    const dist=hav(S.lat,S.lng,p.lat,p.lon);
    if(dist<30)continue;
    res.push({
      name:p.title,
      lat:p.lat,
      lng:p.lon,
      dist,
      bearing:brg(S.lat,S.lng,p.lat,p.lon),
      type:{emoji:'ğŸ“',label:'Lieu',cat:'all'}
    });
  }
  S.allPOIs=res.sort((a,b)=>a.dist-b.dist);
  S.fetchLat=S.lat;S.fetchLng=S.lng;
  applyFilter();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILTER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function applyFilter(){
  S.pois=S.allPOIs.filter(p=>p.dist<=S.maxD);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderLoop(){
  const h=getH();
  if(S.gpsOk&&S.pois.length)updPOIs(h);
  requestAnimationFrame(renderLoop);
}

function updPOIs(h){
  const W=window.innerWidth;
  const useHeading=h!==null;
  const effectiveH=h||0;

  for(const p of S.pois){
    let e=poiEls.get(p.name);
    if(!e){
      e=buildPOI(p);
      document.getElementById('poic').appendChild(e);
      poiEls.set(p.name,e);
    }
    const df=useHeading?ndeg(p.bearing-effectiveH):0;
    const x=W/2+(df/FOV2)*(W/2);
    e.style.transform=`translateX(${x}px) translateX(-50%)`;
  }
}

function buildPOI(p){
  const e=document.createElement('div');
  e.className='poi';
  e.style.top='35%';
  e.innerHTML=`
    <div class="poc"></div>
    <div class="pob">
      <span class="pii">${p.type.emoji}</span>
      <div class="pin">${p.name}</div>
      <div class="pid">${fmt(p.dist)}</div>
    </div>`;
  return e;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initApp(){
  startGPS();
  fetchPOIs();
  renderLoop();
}
</script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DISTS = [
  {l:'500m', v:500},   {l:'1km',  v:1000},
  {l:'2km',  v:2000},  {l:'5km',  v:5000},
  {l:'10km', v:10000}, {l:'25km', v:25000},
  {l:'50km', v:50000}, {l:'100km',v:100000},
];
const CATS = [
  {id:'all',  lb:'ğŸŒ Tout',       cc:'#00e5ff'},
  {id:'city', lb:'ğŸ™ Villes',      cc:'#a78bfa'},
  {id:'coast',lb:'ğŸ—º CÃ´tes',       cc:'#38bdf8'},
  {id:'isle', lb:'ğŸ Ãles',        cc:'#34d399'},
  {id:'mount',lb:'â›° Montagnes',   cc:'#fb923c'},
  {id:'wood', lb:'ğŸŒ² ForÃªts',      cc:'#4ade80'},
  {id:'lh',   lb:'ğŸ—¼ Phares',      cc:'#fbbf24'},
  {id:'site',  lb:'ğŸ“Œ Lieux-dits',  cc:'#f472b6'},
  {id:'beach', lb:'ğŸ– Plages',        cc:'#fcd34d'},
];
const FOV = 75, FOV2 = FOV/2;
const ALPHA = 0.25; // compass smoothing (higher = less lag)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S = {
  lat:null, lng:null,
  hRaw:null, hSm:null, hOff:0,
  cSrc:null,
  gpsOk:false, gpsMan:false,
  allPOIs:[], pois:[],
  fetchLat:null, fetchLng:null,
  maxD:10000, band:false,  // band=false: montre de 0 Ã  maxD
  bandPct:0.20,            // Â±20% by default (e.g. 50km â†’ 40-60km)
  cat:'all',
  detPOI:null,
  centerPOI:null,          // POI closest to crosshair center
};
let lmap=null, lmk=null, pLat=null, pLng=null;
let cRelTimer=null;
const poiEls=new Map();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initApp(){
  const btn=document.getElementById('stbtn');
  btn.disabled=true; btn.textContent='DÃ©marrageâ€¦';

  // Dismiss startup immediately
  const st=document.getElementById('startup');
  st.style.transition='opacity .4s';
  st.style.opacity='0';
  setTimeout(()=>st.style.display='none', 400);

  buildFilters();
  renderLoop();

  // Camera (async, non-blocking)
  if(navigator.mediaDevices?.getUserMedia){
    navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}},audio:false})
      .then(s=>{document.getElementById('cam').srcObject=s; setPerm('cam','ok');})
      .catch(()=>setPerm('cam','no'));
  } else setPerm('cam','no');

  // GPS (async, non-blocking)
  if(!navigator.geolocation){ setPerm('gps','no'); showGPSHelp('ns'); }
  else { setPerm('gps','wait'); startGPS(); }

  // Compass
  if(typeof DeviceOrientationEvent!=='undefined' &&
     typeof DeviceOrientationEvent.requestPermission==='function'){
    // iOS Safari : requestPermission requis (doit Ãªtre depuis un geste utilisateur)
    DeviceOrientationEvent.requestPermission()
      .then(p=>{
        if(p==='granted'){
          // iOS : webkitCompassHeading est dans deviceorientation (pas besoin d'absolute)
          window.addEventListener('deviceorientation',onOri,true);
          setPerm('cmp','ok');
        } else {
          setPerm('cmp','no');
          showDbg('ğŸ§­ Boussole refusÃ©e â€“ active-la dans RÃ©glages â†’ Safari');
        }
      }).catch(()=>setPerm('cmp','no'));
  } else {
    // Android / desktop : Ã©couter les deux sources
    // deviceorientationabsolute = nord magnÃ©tique (meilleur quand disponible)
    // deviceorientation         = fallback si absolute est figÃ© ou absent
    window.addEventListener('deviceorientationabsolute',onOriAbs,true);
    window.addEventListener('deviceorientation',onOri,true);
    setPerm('cmp','ok');
  }
}

function setPerm(id,s){
  const idMap={cam:'pcam',gps:'pgps',cmp:'pcmp'};
  const el=document.getElementById(idMap[id]);
  if(!el)return;
  el.classList.remove('ok','no');
  const st=el.querySelector('.pis');
  if(s==='ok'){el.classList.add('ok');st.textContent='OK';}
  else if(s==='no'){el.classList.add('no');st.textContent='REFUSÃ‰';}
  else st.textContent='EN ATTENTEâ€¦';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function startGPS(){
  if(navigator.permissions){
    try{
      const p=await navigator.permissions.query({name:'geolocation'});
      if(p.state==='denied'){setPerm('gps','no');showGPSHelp(1);setDot('err');gtxt('GPS refusÃ© Â· ğŸ“ position manuelle');return;}
    }catch(e){}
  }
  navigator.geolocation.getCurrentPosition(
    pos=>{onGPS(pos);setPerm('gps','ok');document.getElementById('ghelp').classList.remove('on');
      navigator.geolocation.watchPosition(onGPS,onGPSErr,{enableHighAccuracy:true,maximumAge:5000,timeout:20000});},
    err=>{setPerm('gps','no');showGPSHelp(err.code);setDot('err');gtxt(gpsmsg(err.code)+' Â· ğŸ“ tap');},
    {enableHighAccuracy:true,timeout:20000,maximumAge:0}
  );
}
function retryGPS(){document.getElementById('ghelp').classList.remove('on');setPerm('gps','wait');startGPS();}
function onGPS(pos){
  if(S.gpsMan)return;
  S.lat=pos.coords.latitude; S.lng=pos.coords.longitude; S.gpsOk=true;
  setDot('ok');
  const acc=Math.round(pos.coords.accuracy);
  gtxt(`${S.lat.toFixed(5)}, ${S.lng.toFixed(5)} Â±${acc}m`);
  document.getElementById('mmgps').disabled=false;
  const moved=S.fetchLat!=null?hav(S.lat,S.lng,S.fetchLat,S.fetchLng):Infinity;
  if(moved>150) fetchPOIs();
}
function onGPSErr(e){setDot('err');gtxt(gpsmsg(e.code));}
function gpsmsg(c){return{1:'GPS refusÃ©',2:'GPS indisponible',3:'DÃ©lai GPS'}[c]||'Erreur GPS';}
function setDot(s){const d=document.getElementById('sdot');d.classList.remove('ok','err','mn');d.classList.add(s);}
function gtxt(t){document.getElementById('gtxt').textContent=t;}

function showGPSHelp(c){
  const isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent);
  const isAnd=/Android/.test(navigator.userAgent);
  let m='';
  if(c===1||c==='denied'){
    if(isIOS) m='1. RÃ©glages â†’ ConfidentialitÃ© & SÃ©curitÃ©\n   â†’ Service de localisation â†’ Safari\n   â†’ Â« Lors de l\'utilisation Â»\n2. Reviens ici â†’ RÃ©essayer\n\nOu utilise la position manuelle ğŸ“';
    else if(isAnd) m='1. Tap sur ğŸ”’ dans la barre d\'adresse\n2. Autorisations â†’ Localisation â†’ Autoriser\n3. RÃ©essayer\n\nOu utilise la position manuelle ğŸ“';
    else m='Autorise la gÃ©olocalisation dans les\nparamÃ¨tres du navigateur, puis RÃ©essayer.\nOu utilise la position manuelle ğŸ“';
  } else if(c===2) m='GPS indisponible. VÃ©rifie que la\nlocalisation est activÃ©e sur l\'appareil.\nOu utilise la position manuelle ğŸ“';
  else if(c===3) m='DÃ©lai GPS dÃ©passÃ©. Va en extÃ©rieur\nsi possible, puis RÃ©essayer.\nOu utilise la position manuelle ğŸ“';
  else m='GPS non supportÃ©. Utilise la position manuelle ğŸ“';
  document.getElementById('ghelpb').textContent=m;
  document.getElementById('ghelp').classList.add('on');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMPASS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â”€â”€ COMPASS : gestion multi-source robuste â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ProblÃ¨me frÃ©quent : deviceorientationabsolute donne alpha=0 figÃ© et
// verrouille S.cSrc='abs', bloquant deviceorientation qui, lui, bouge.
// Solution : on surveille si la source abs change vraiment. Si elle reste
// identique pendant >1s on la considÃ¨re "figÃ©e" et on passe au fallback.

let _absHistory=[]; // derniÃ¨res valeurs absolues pour dÃ©tection stagnation
let _absFrozen=false;

function _absIsLive(val){
  _absHistory.push({v:val,t:Date.now()});
  if(_absHistory.length>60) _absHistory.shift();
  // Garder uniquement les 2 derniÃ¨res secondes
  const cutoff=Date.now()-2000;
  const recent=_absHistory.filter(x=>x.t>cutoff);
  if(recent.length<10) return true; // pas encore assez de donnÃ©es â†’ optimiste
  const mn=Math.min(...recent.map(x=>x.v));
  const mx=Math.max(...recent.map(x=>x.v));
  // Si toutes les valeurs sont dans un Ã©cart de 0.5Â° â†’ capteur figÃ©
  _absFrozen = (mx-mn)<0.5;
  return !_absFrozen;
}

function onOriAbs(e){
  if(e.alpha==null) return;
  const h=(360-e.alpha+360)%360;
  if(!_absIsLive(h)) return; // valeur figÃ©e â†’ ignorer, laisser onOri prendre le relais
  updRaw(h);
  S.cSrc='abs';
  hideCWarn();
}

function onOri(e){
  // â”€â”€ iOS : webkitCompassHeading (source la plus fiable sur iPhone/iPad) â”€â”€
  if(e.webkitCompassHeading!=null && e.webkitCompassHeading>=0){
    _absFrozen=false;
    updRaw(e.webkitCompassHeading);
    S.cSrc='ios';
    hideCWarn();
    return;
  }
  // â”€â”€ Android : event avec absolute=true (equivalent Ã  deviceorientationabsolute) â”€â”€
  if(e.absolute===true && e.alpha!=null){
    const h=(360-e.alpha+360)%360;
    if(_absIsLive(h)){
      updRaw(h);
      S.cSrc='abs';
      hideCWarn();
      return;
    }
  }
  // â”€â”€ Bloc si une source absolue VIVANTE est dÃ©jÃ  active â”€â”€
  // IMPORTANT : on ne bloque PAS si _absFrozen=true â†’ on laisse passer le fallback
  if((S.cSrc==='abs'||S.cSrc==='ios') && !_absFrozen) return;

  // â”€â”€ Fallback : alpha relatif (origin arbitraire â€” boussole non calibrÃ©e) â”€â”€
  if(e.alpha!=null){
    updRaw((360-e.alpha+360)%360);
    if(S.cSrc!=='rel'){
      S.cSrc='rel';
      if(!cRelTimer) cRelTimer=setTimeout(()=>{
        if(S.cSrc==='rel') document.getElementById('cwarn').style.display='block';
      },2000);
    }
  }
}

function updRaw(r){
  S.hRaw=r;
  if(S.hSm==null){S.hSm=r;return;}
  let d=r-S.hSm;
  if(d>180)d-=360; if(d<-180)d+=360;
  S.hSm=(S.hSm+ALPHA*d+360)%360;
}
function getH(){return S.hSm==null?null:(S.hSm+S.hOff+360)%360;}
function hideCWarn(){
  if(cRelTimer){clearTimeout(cRelTimer);cRelTimer=null;}
  document.getElementById('cwarn').style.display='none';
  document.getElementById('calw').classList.remove('on');
}
function toggleCal(){document.getElementById('calw').classList.toggle('on');}
function chOff(d){
  S.hOff=(S.hOff+d+360)%360;
  if(S.hOff>180)S.hOff-=360;
  document.getElementById('offd').textContent=(S.hOff>=0?'+':'')+S.hOff+'Â°';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILTERS BUILD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildFilters(){
  // Categories
  const cr=document.getElementById('cfrow'); cr.innerHTML='';
  CATS.forEach(c=>{
    const b=document.createElement('button');
    b.className='pill cpill'+(c.id===S.cat?' on':'');
    b.textContent=c.lb; b.style.setProperty('--cc',c.cc);
    b.onclick=()=>selCat(c.id);
    cr.appendChild(b);
  });
  // Distances
  const dr=document.getElementById('dfrow'); dr.innerHTML='';
  // Band width selector: strict or wide
  const bw=document.createElement('button');
  bw.className='pill on'; bw.id='bwpill';
  bw.textContent=S.bandPct===0.2?'Â±20%':'Â±10%';
  bw.title='Largeur de la fourchette de distance';
  bw.onclick=()=>{
    S.bandPct=S.bandPct===0.20?0.10:0.20;
    bw.textContent=S.bandPct===0.2?'Â±20%':'Â±10%';
    applyFilter();
  };
  dr.appendChild(bw);
  DISTS.forEach(d=>{
    const b=document.createElement('button');
    b.className='pill'+(d.v===S.maxD?' on':'');
    b.textContent=d.l;
    b.onclick=()=>{
      S.maxD=d.v;
      document.querySelectorAll('#dfrow .pill:not(#bwpill)').forEach((x,i)=>x.classList.toggle('on',DISTS[i].v===d.v));
      applyFilter();
    };
    dr.appendChild(b);
  });
}

function selCat(id){
  S.cat=id;
  document.querySelectorAll('.cpill').forEach((b,i)=>b.classList.toggle('on',CATS[i].id===id));
  applyFilter();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILTER LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function applyFilter(){
  // Band: for small distances (â‰¤2km) always show from 0
  // For larger: strict window around selected distance
  let dMin=0, dMax=S.maxD;
  if(S.band && S.maxD>2000){
    dMin = S.maxD*(1-S.bandPct);
    dMax = S.maxD*(1+S.bandPct);
  }

  const filtered=S.allPOIs.filter(p=>{
    if(p.dist<dMin||p.dist>dMax)return false;
    return S.cat==='all'||p.type.cat===S.cat;
  });

  // Max 25 POIs spread across the band (5 buckets Ã— 5)
  const bw=(dMax-dMin)/5;
  const buckets=[[],[],[],[],[]];
  filtered.forEach(p=>{
    const bi=Math.min(4,Math.floor((p.dist-dMin)/Math.max(bw,1)));
    if(buckets[bi].length<5) buckets[bi].push(p);
  });
  S.pois=buckets.flat();

  poiEls.forEach(e=>e.remove()); poiEls.clear();

  const rng=S.band&&S.maxD>2000
    ?`${fmt(dMin)} â€“ ${fmt(dMax)}`
    :`0 â€“ ${fmt(dMax)}`;
  document.getElementById('pcnt').textContent=
    `${S.pois.length} pts Â· ${rng}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FETCH POIs â€” WikipÃ©dia (primaire) + Overpass allÃ©gÃ© (fallback)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Classifie un lieu d'aprÃ¨s son nom (pour WikipÃ©dia)
function classifyByName(name){
  const n=name.toLowerCase();
  if(/\bphare\b/.test(n))                                        return{emoji:'ğŸ—¼',label:'Phare',cat:'lh'};
  if(/\b(Ã®le|Ã®les|Ã®lot|ile |iles |ilot|island|atoll)/.test(n))  return{emoji:'ğŸï¸',label:'Ãle',cat:'isle'};
  if(/\b(mont|montagne|pic |sommet|volcan|puy |col |massif)/.test(n))return{emoji:'â›°ï¸',label:'Sommet',cat:'mount'};
  if(/(^cap |^cap-|\bcap\b|pointe |^raz |presqu.Ã®le|pÃ©ninsule|pointe-|headland)/.test(n))return{emoji:'ğŸ—ºï¸',label:'Cap / Pointe',cat:'coast'};
  if(/\b(baie|golfe|anse |rade |fjord)/.test(n))                 return{emoji:'ğŸŒŠ',label:'Baie',cat:'coast'};
  if(/\bdÃ©troit\b/.test(n))                                      return{emoji:'ã€°ï¸',label:'DÃ©troit',cat:'coast'};
  if(/\b(falaise|cliffs?)\b/.test(n))                            return{emoji:'ğŸª¨',label:'Falaise',cat:'coast'};
  if(/\b(forÃªt|bois |woods?|forest)/.test(n))                    return{emoji:'ğŸŒ²',label:'ForÃªt',cat:'wood'};
  if(/\b(plage|beach|spiaggia)/.test(n))                          return{emoji:'ğŸ–',label:'Plage',cat:'beach'};
  if(/\b(lieu-dit|lieudit|hameau|Ã©cart|lieu dit)/.test(n))       return{emoji:'ğŸ“Œ',label:'Lieu-dit',cat:'site'};
  return null; // inconnu â†’ sera classifiÃ© comme ville par dÃ©faut
}

// Source 1 : WikipÃ©dia GeoSearch (FR puis EN) â€” rapide, gratuit, pas de clÃ©
async function fetchWikipedia(lat,lng,radiusM){
  // Wikipedia: max 10 000m par requÃªte.
  // Pour couvrir de plus grands rayons on crÃ©e une grille de points d'ancrage
  // espacÃ©s de ~14km (diagonal = 10km) autour de la position centrale.
  const WR = 10000; // rayon max Wikipedia
  const seen=new Set(); const items=[];

  // GÃ©nÃ¨re les points d'ancrage couvrant radiusM
  function anchorPoints(cLat, cLng, totalR){
    const pts=[{lat:cLat,lng:cLng}];
    if(totalR<=WR) return pts;
    // Grille hexagonale ~14km entre centres
    const step = 0.125; // ~14km en degrÃ©s lat
    const cols = Math.ceil(totalR/1000/14);
    for(let dx=-cols;dx<=cols;dx++){
      for(let dy=-cols;dy<=cols;dy++){
        if(dx===0&&dy===0) continue;
        const aLat=cLat+dy*step;
        const aLng=cLng+dx*step/Math.cos(cLat*Math.PI/180);
        // N'inclure que si le point d'ancrage est dans le rayon total
        if(hav(cLat,cLng,aLat,aLng)<totalR)
          pts.push({lat:aLat,lng:aLng});
      }
    }
    return pts;
  }

  const anchors = anchorPoints(lat,lng,radiusM);
  // Limite Ã  9 ancres max pour ne pas surcharger
  const usedAnchors = anchors.slice(0,9);

  // Lance tous les appels Wikipedia (fr) en parallÃ¨le
  const fetches = usedAnchors.map(a => {
    const url=`https://fr.wikipedia.org/w/api.php?action=query&list=geosearch`+
      `&gsradius=${WR}&gslatitude=${a.lat}&gslongitude=${a.lng}&gslimit=500`+
      `&format=json&origin=*`;
    const ctrl=new AbortController();
    setTimeout(()=>ctrl.abort(),9000);
    return fetch(url,{signal:ctrl.signal})
      .then(r=>r.ok?r.json():null)
      .catch(()=>null);
  });

  const results = await Promise.all(fetches);
  for(const data of results){
    for(const p of data?.query?.geosearch||[]){
      if(seen.has(p.pageid)) continue;
      seen.add(p.pageid);
      // Recalculer la distance rÃ©elle depuis la position utilisateur
      const realDist = hav(lat,lng,p.lat,p.lon);
      if(realDist > radiusM*1.1) continue; // hors rayon
      items.push({name:p.title, lat:p.lat, lng:p.lon, dist:realDist});
    }
  }
  return items;
}

// Source 2 : Overpass allÃ©gÃ© â€” uniquement nodes "place" (trÃ¨s rapide)
async function fetchOverpassLight(lat,lng,radiusM){
  const r=Math.min(radiusM*1.5, 100000);
  const q=`[out:json][timeout:15];(
node["place"~"^(city|town|village|hamlet|suburb|island|islet|locality)$"](around:${r},${lat},${lng});
node["natural"~"^(peak|volcano|cape|bay|beach|cliff)$"]["name"](around:${r},${lat},${lng});
node["man_made"="lighthouse"]["name"](around:${r},${lat},${lng});
);out 600;`;
  const APIS=['https://overpass-api.de/api/interpreter','https://overpass.kumi.systems/api/interpreter'];
  for(const api of APIS){
    try{
      const ctrl=new AbortController();
      const tid=setTimeout(()=>ctrl.abort(),17000);
      const resp=await fetch(api,{method:'POST',body:q,signal:ctrl.signal});
      clearTimeout(tid);
      if(!resp.ok) continue;
      const data=await resp.json();
      return data.elements||[];
    }catch(e){}
  }
  return [];
}

async function fetchPOIs(){
  if(!S.lat)return;
  showDbg('ğŸ” Recherche POIsâ€¦');
  document.getElementById('ldr').classList.add('on');
  const lat=S.lat, lng=S.lng;
  const radiusM=Math.min(100000, Math.max(5000, S.maxD*1.5));

  // Wikipedia: max 10 000m par appel â†’ on fait N appels dÃ©calÃ©s si rayon > 10km
  // Overpass : couvre tout le rayon â†’ les deux en PARALLÃˆLE
  const [wikiItems, ovItems] = await Promise.all([
    fetchWikipedia(lat, lng, radiusM),
    fetchOverpassLight(lat, lng, radiusM)
  ]);

  document.getElementById('ldr').classList.remove('on');

  const total = wikiItems.length + ovItems.length;
  if(!total){
    showDbg('âŒ Aucune donnÃ©e â€“ vÃ©rifie ta connexion internet');
    return;
  }
  showDbg(`âœ“ Wikipedia:${wikiItems.length} + OSM:${ovItems.length}`);
  processPOIs(wikiItems, ovItems, lat, lng);
  S.fetchLat=lat; S.fetchLng=lng;
}

function processPOIs(wikiItems, ovEls, ulat, ulng){
  const seen=new Set(), res=[];

  // Traiter les donnÃ©es Overpass (ground truth : tags OSM prÃ©cis)
  for(const el of ovEls){
    const eLat=el.lat??el.center?.lat;
    const eLng=el.lon??el.center?.lon;
    if(!eLat||!eLng) continue;
    const name=el.tags?.name||el.tags?.['name:fr'];
    if(!name) continue;
    const key=name.toLowerCase().trim();
    if(seen.has(key)) continue;
    seen.add(key);
    const dist=hav(ulat,ulng,eLat,eLng);
    if(dist<30) continue;
    res.push({name,lat:eLat,lng:eLng,dist,bearing:brg(ulat,ulng,eLat,eLng),type:classifyOSM(el.tags,name)});
  }

  // ComplÃ©ter avec WikipÃ©dia (lieux non dÃ©jÃ  prÃ©sents via Overpass)
  for(const w of wikiItems){
    const key=w.name.toLowerCase().trim();
    if(seen.has(key)) continue;
    seen.add(key);
    const dist=hav(ulat,ulng,w.lat,w.lng);
    if(dist<30) continue;
    const typeGuess=classifyByName(w.name);
    const type=typeGuess||{emoji:'ğŸ™ï¸',label:'Ville',cat:'city'};
    res.push({name:w.name,lat:w.lat,lng:w.lng,dist,bearing:brg(ulat,ulng,w.lat,w.lng),type});
  }

  res.sort((a,b)=>a.dist-b.dist);
  S.allPOIs=res;
  showDbg(`âœ“ ${res.length} POIs traitÃ©s`);
  applyFilter();
}

// Classifie via tags OSM (source Overpass)
function classifyOSM(t,name){
  if(!t)return{emoji:'ğŸ“',label:'Lieu',cat:'all'};
  const p=t.place,n=t.natural,m=t.man_made,lu=t.landuse;
  const nm=(name||'').toLowerCase();
  if(n==='wood'||lu==='forest')return{emoji:'ğŸŒ²',label:'ForÃªt',cat:'wood'};
  if(m==='lighthouse')return{emoji:'ğŸ—¼',label:'Phare',cat:'lh'};
  if(p==='island'||p==='islet')return{emoji:'ğŸï¸',label:'Ãle',cat:'isle'};
  if(n==='peak'||n==='volcano')return{emoji:'â›°ï¸',label:'Sommet',cat:'mount'};
  if(n==='cape'||n==='peninsula'||n==='headland'||
     nm.startsWith('pointe')||nm.startsWith('cap ')||nm.startsWith('cap-')||
     nm.includes("presqu'Ã®le"))
    return{emoji:'ğŸ—ºï¸',label:'Cap / Pointe',cat:'coast'};
  if(n==='bay')return{emoji:'ğŸŒŠ',label:'Baie',cat:'coast'};
  if(n==='strait')return{emoji:'ã€°ï¸',label:'DÃ©troit',cat:'coast'};
  if(n==='cliff')return{emoji:'ğŸª¨',label:'Falaise',cat:'coast'};
  if(p==='city')return{emoji:'ğŸ™ï¸',label:'Ville',cat:'city'};
  if(p==='town')return{emoji:'ğŸ˜ï¸',label:'Bourg',cat:'city'};
  if(p==='village'||p==='hamlet'||p==='suburb')return{emoji:'ğŸ¡',label:'Village',cat:'city'};
  if(p==='locality'||p==='isolated_dwelling')return{emoji:'ğŸ“Œ',label:'Lieu-dit',cat:'site'};
  if(n==='beach'||t?.leisure==='beach_resort'||t?.tourism==='beach')return{emoji:'ğŸ–',label:'Plage',cat:'beach'};
  return{emoji:'ğŸ“',label:'Lieu',cat:'all'};
}

// Alias pour compatibilitÃ© (classify reste utilisÃ© nulle part mais on garde)
function classify(t,n){return classifyOSM(t,n);}

function doRefresh(){
  S.fetchLat=null;
  if(S.gpsOk) fetchPOIs();
  else showDbg('ğŸ“ Position non dÃ©finie â€” utilise la carte');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAP MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openMap(){
  document.getElementById('mmap').classList.add('on');
  // Enable GPS button if we have coords
  document.getElementById('mmgps').disabled=!S.gpsOk;
  setTimeout(()=>{
    if(!lmap){
      const initLat=S.lat||48.0, initLng=S.lng||-2.0;
      lmap=L.map('lmap',{zoomControl:true}).setView([initLat,initLng],S.gpsOk?12:6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
        attribution:'Â© OpenStreetMap',maxZoom:19
      }).addTo(lmap);

      lmap.on('click',e=>{
        pLat=e.latlng.lat; pLng=e.latlng.lng;
        setMapMarker(pLat,pLng);
        document.getElementById('mmok').disabled=false;
      });
    } else {
      lmap.invalidateSize();
    }
    // If we have a position, show it
    if(S.lat&&!lmk){
      setMapMarker(S.lat,S.lng);
      pLat=S.lat; pLng=S.lng;
      document.getElementById('mmok').disabled=false;
    }
  },120);
}

function setMapMarker(lat,lng){
  if(lmk){lmk.setLatLng([lat,lng]);}
  else{
    lmk=L.marker([lat,lng],{draggable:true}).addTo(lmap);
    lmk.on('dragend',e=>{
      const ll=e.target.getLatLng();
      pLat=ll.lat; pLng=ll.lng;
      document.getElementById('mmc').textContent=`${pLat.toFixed(5)}, ${pLng.toFixed(5)}`;
    });
  }
  document.getElementById('mmc').textContent=`${lat.toFixed(5)}, ${lng.toFixed(5)}`;
  if(lmap) lmap.setView([lat,lng],Math.max(lmap.getZoom(),10));
}

function useGPSPos(){
  if(!S.lat)return;
  pLat=S.lat; pLng=S.lng;
  setMapMarker(pLat,pLng);
  document.getElementById('mmok').disabled=false;
}

function closeMap(){
  document.getElementById('mmap').classList.remove('on');
}

function confirmPos(){
  if(pLat==null)return;
  S.lat=pLat; S.lng=pLng; S.gpsOk=true; S.gpsMan=true;
  setDot('mn');
  gtxt(`ğŸ“ Manuel : ${S.lat.toFixed(4)}, ${S.lng.toFixed(4)}`);
  closeMap();
  // Recalculate all POI distances from new position
  S.allPOIs.forEach(p=>{
    p.dist=hav(S.lat,S.lng,p.lat,p.lng);
    p.bearing=brg(S.lat,S.lng,p.lat,p.lng);
  });
  S.allPOIs.sort((a,b)=>a.dist-b.dist);
  S.fetchLat=null;
  fetchPOIs();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CPS=[
  {d:0,l:'N'},{d:22.5,l:'NNE'},{d:45,l:'NE'},{d:67.5,l:'ENE'},
  {d:90,l:'E'},{d:112.5,l:'ESE'},{d:135,l:'SE'},{d:157.5,l:'SSE'},
  {d:180,l:'S'},{d:202.5,l:'SSO'},{d:225,l:'SO'},{d:247.5,l:'OSO'},
  {d:270,l:'O'},{d:292.5,l:'ONO'},{d:315,l:'NO'},{d:337.5,l:'NNO'},
];
let cpBuilt=false;
const TOPS=[28,35,42,22,48];

function renderLoop(){
  const h=getH();
  if(!cpBuilt){
    const tr=document.getElementById('ctrack');
    CPS.forEach(p=>{
      const e=document.createElement('div');
      e.className='clbl'+([0,90,180,270].includes(p.d)?' card':'');
      e.textContent=p.l; e.dataset.d=p.d;
      tr.appendChild(e);
    });
    cpBuilt=true;
  }
  if(h!==null){
    const W=document.getElementById('ctrack').offsetWidth;
    document.querySelectorAll('.clbl').forEach(e=>{
      const df=ndeg(parseFloat(e.dataset.d)-h);
      const x=W/2+df/FOV*W;
      if(x<-40||x>W+40){e.style.display='none';return;}
      e.style.display=''; e.style.left=x+'px';
      e.style.opacity=Math.max(0,1-Math.abs(df)/FOV2*.8);
    });
    const hi=Math.round(h);
    const srcLabel={'ios':'ğŸ§­','abs':'ğŸ§­','rel':'âš ï¸',null:'?'}[S.cSrc]||'?';
    document.getElementById('hdg').textContent=`${hi.toString().padStart(3,'0')}Â° ${card(hi)} ${srcLabel}`;
    if(S.gpsOk && S.pois.length) throttledUpdPOIs(h);
  } else if(S.gpsOk && S.pois.length) {
    // Pas de boussole : on affiche quand mÃªme les POIs triÃ©s par distance
    throttledUpdPOIs(null);
  }
  requestAnimationFrame(renderLoop);
}

let _lastPOIUpdate = 0;
function throttledUpdPOIs(h) {
  const now = Date.now();
  if(now - _lastPOIUpdate < 120) return; // max ~8 updates/sec
  _lastPOIUpdate = now;
  updPOIs(h);
}

function updPOIs(h){
  const W=window.innerWidth;
  const vis=[];
  let bestDf=Infinity, bestPOI=null;  // FIX: was undefined â†’ ReferenceError
  // If no compass, show all POIs centered (sorted by distance)
  const useHeading = h !== null;
  const effectiveH = h || 0;
  for(const p of S.pois){
    const df = useHeading ? ndeg(p.bearing - effectiveH) : 0;
    if(useHeading && Math.abs(df)>FOV2*1.2) continue;
    vis.push({p, df});
  }
  for(const[n,e]of poiEls){
    if(!vis.find(v=>v.p.name===n)){e.remove();poiEls.delete(n);}
  }
  for(const{p,df}of vis){
    let e=poiEls.get(p.name);
    if(!e){e=buildPOI(p);document.getElementById('poic').appendChild(e);poiEls.set(p.name,e);}
    // Use transform for GPU-composited movement (no layout reflow)
    const xPx = W/2+(df/FOV2)*(W/2);
    e.style.transform = `translateX(calc(${xPx}px - 50%))`;
    const a=Math.abs(df);
    e.dataset.f=a>FOV2*.7?3:a>FOV2*.4?2:1;
    const ch=Math.max(18,Math.round(55*(1-Math.min(p.dist/S.maxD,1))));
    e.querySelector('.poc').style.height=ch+'px';
    if(a<bestDf&&a<12){bestDf=a;bestPOI=p;}
  }
  // Center badge â€” "what's in front of me"
  const badge=document.getElementById('cfocus');
  if(bestPOI){
    document.getElementById('cfn').textContent=bestPOI.name;
    document.getElementById('cfd').textContent=fmt(bestPOI.dist);
    document.getElementById('cft').textContent=bestPOI.type.label.toUpperCase()+' Â· '+Math.round(bestPOI.bearing)+'Â° '+card(bestPOI.bearing);
    badge.classList.add('on');
  } else {
    badge.classList.remove('on');
  }
}

function buildPOI(p){
  const e=document.createElement('div');
  e.className='poi';
  // transform set in updPOIs
  const hash=p.name.split('').reduce((a,c)=>a+c.charCodeAt(0),0);
  const topPct = TOPS[hash%TOPS.length];
  e.style.top = topPct + '%';
  e.innerHTML=`<div class="poc" style="height:40px"></div>
<div class="pob">
  <span class="pii">${p.type.emoji}</span>
  <div class="pin">${p.name}</div>
  <div class="pid">${fmt(p.dist)}</div>
</div>`;
  e.addEventListener('click',()=>openDet(p));
  return e;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DETAIL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openDet(p){
  S.detPOI=p;
  document.getElementById('deti').textContent=p.type.emoji;
  document.getElementById('detn').textContent=p.name;
  document.getElementById('dett').textContent=p.type.label.toUpperCase();
  document.getElementById('dmd').textContent=fmt(p.dist);
  document.getElementById('dmb').textContent=Math.round(p.bearing)+'Â° '+card(p.bearing);
  document.getElementById('dmxy').textContent=p.lat.toFixed(4)+', '+p.lng.toFixed(4);
  document.getElementById('bpoi').style.display=p.type.cat==='city'?'':'none';
  document.getElementById('nbl').classList.remove('on');
  document.getElementById('nbi').innerHTML='';
  document.getElementById('det').classList.add('on');
}
function closeDet(){document.getElementById('det').classList.remove('on');}
function goGMaps(){
  const p=S.detPOI;if(!p)return;
  window.open(`https://www.google.com/maps/dir/?api=1&origin=${S.lat},${S.lng}&destination=${p.lat},${p.lng}&travelmode=driving`,'_blank');
}
async function loadNearby(){
  const p=S.detPOI;if(!p)return;
  const b=document.getElementById('bpoi');
  b.textContent='â³ Chargementâ€¦';b.disabled=true;
  const q=`[out:json][timeout:15];(
node["tourism"~"^(attraction|museum|viewpoint|monument|castle)$"](around:3000,${p.lat},${p.lng});
node["historic"~"^(castle|monument|ruins|church|memorial|archaeological_site)$"](around:3000,${p.lat},${p.lng});
node["amenity"~"^(place_of_worship|theatre)$"]["name"](around:3000,${p.lat},${p.lng});
node["leisure"~"^(park|garden|nature_reserve)$"]["name"](around:3000,${p.lat},${p.lng});
node["natural"~"^(beach|cliff|peak)$"]["name"](around:3000,${p.lat},${p.lng});
);out 20;`;
  try{
    const res=await fetch('https://overpass-api.de/api/interpreter',{method:'POST',body:q}).then(r=>r.json());
    const items=res.elements.filter(e=>e.tags?.name).map(e=>({name:e.tags.name,tags:e.tags}))
      .filter((e,i,a)=>a.findIndex(x=>x.name===e.name)===i).slice(0,12);
    const c=document.getElementById('nbi');c.innerHTML='';
    if(!items.length){c.innerHTML='<div style="font-family:Space Mono,monospace;font-size:10px;color:var(--mu);padding:6px">Aucun lieu trouvÃ© dans 3km.</div>';}
    else items.forEach(it=>{
      const{e,l}=clsNrb(it.tags);
      const d=document.createElement('div');d.className='nbi';
      d.innerHTML=`<span class="nbii">${e}</span><span class="nbin">${it.name}</span><span class="nbit">${l}</span>`;
      d.onclick=()=>window.open(`https://www.google.com/maps/search/${encodeURIComponent(it.name+' '+p.name)}`,'_blank');
      c.appendChild(d);
    });
    document.getElementById('nbl').classList.add('on');
  }catch(e){
    document.getElementById('nbi').innerHTML='<div style="color:var(--red);font-size:10px;padding:6px">Erreur rÃ©seau.</div>';
    document.getElementById('nbl').classList.add('on');
  }finally{b.textContent='ğŸ” Lieux Ã  voir';b.disabled=false;}
}
function clsNrb(t){
  const{tourism:to,historic:hi,amenity:a,leisure:le,natural:n}=t;
  if(to==='museum')return{e:'ğŸ›',l:'MusÃ©e'};if(to==='viewpoint')return{e:'ğŸ‘',l:'Panorama'};
  if(to==='castle'||hi==='castle'||hi==='manor')return{e:'ğŸ°',l:'ChÃ¢teau'};
  if(hi==='church'||a==='place_of_worship')return{e:'â›ª',l:'Religieux'};
  if(hi==='ruins'||hi==='archaeological_site')return{e:'ğŸš',l:'Ruines'};
  if(hi==='memorial'||hi==='monument'||to==='monument')return{e:'ğŸ—¿',l:'Monument'};
  if(le==='park'||le==='garden')return{e:'ğŸŒ³',l:'Parc'};
  if(le==='nature_reserve')return{e:'ğŸŒ¿',l:'RÃ©serve'};
  if(n==='beach')return{e:'ğŸ–',l:'Plage'};
  return{e:'ğŸ“',l:'Lieu'};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MENU / QUIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goMenu(){
  const s=document.getElementById('startup');
  s.style.display='flex'; s.style.opacity='0'; s.style.transition='opacity .3s';
  const b=document.getElementById('stbtn');b.disabled=false;b.textContent='â†© Reprendre';
  requestAnimationFrame(()=>s.style.opacity='1');
}
function showQuit(){document.getElementById('qov').classList.add('on');}
function hideQuit(){document.getElementById('qov').classList.remove('on');}
function quitApp(){
  const v=document.getElementById('cam');
  if(v.srcObject){v.srcObject.getTracks().forEach(t=>t.stop());v.srcObject=null;}
  window.close();
  setTimeout(()=>{
    document.body.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100dvh;background:#020d1a;font-family:Syne,sans-serif;color:#e0f4ff;flex-direction:column;gap:10px"><div style="font-size:32px;font-weight:800">HORIZON</div><div style="font-family:monospace;font-size:11px;color:rgba(180,220,240,.5)">Fermez cet onglet</div></div>';
  },200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEBUG TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let dbgTimer=null;
function showDbg(msg,dur=3000){
  const el=document.getElementById('dbg');
  el.textContent=msg; el.style.display='block';
  if(dbgTimer)clearTimeout(dbgTimer);
  dbgTimer=setTimeout(()=>el.style.display='none',dur);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GEO UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function hav(a,b,c,d){
  const R=6371000,da=(c-a)*Math.PI/180,db=(d-b)*Math.PI/180;
  const x=Math.sin(da/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(db/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}
function brg(a,b,c,d){
  const f1=a*Math.PI/180,f2=c*Math.PI/180,dl=(d-b)*Math.PI/180;
  return(Math.atan2(Math.sin(dl)*Math.cos(f2),Math.cos(f1)*Math.sin(f2)-Math.sin(f1)*Math.cos(f2)*Math.cos(dl))*180/Math.PI+360)%360;
}
function ndeg(d){d=((d%360)+360)%360;return d>180?d-360:d;}
function card(g){return['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSO','SO','OSO','O','ONO','NO','NNO'][Math.round(g/22.5)%16];}
function fmt(m){return m<1000?Math.round(m)+' m':(m/1000).toFixed(m<10000?1:0)+' km';}

window.addEventListener('resize',()=>{poiEls.forEach(e=>e.remove());poiEls.clear();});
</script>
</body>
</html>
