<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="theme-color" content="#020d1a"/>
  <title>Horizon</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;800&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <style>
    :root {
      --cyan:#00e5ff; --cyan-dim:rgba(0,229,255,0.15); --cyan-border:rgba(0,229,255,0.35);
      --gold:#fbbf24; --bg:#020d1a; --surface:rgba(2,18,34,0.88);
      --text:#e0f4ff; --muted:rgba(180,220,240,0.5); --red:#ff4d6d; --green:#22d3a0;
    }
    *{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    body{background:var(--bg);color:var(--text);font-family:'Syne',sans-serif;overflow:hidden;height:100dvh;width:100dvw;user-select:none}

    /* ‚îÄ‚îÄ CAMERA ‚îÄ‚îÄ */
    #camera-feed{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;z-index:0}
    .vignette{position:fixed;inset:0;z-index:5;background:radial-gradient(ellipse at center,transparent 45%,rgba(2,13,26,.6) 100%);pointer-events:none}

    /* ‚îÄ‚îÄ AR OVERLAY ‚îÄ‚îÄ */
    #ar-overlay{position:fixed;inset:0;z-index:10;pointer-events:none}
    .horizon-line{position:absolute;left:0;right:0;top:50%;height:1px;background:linear-gradient(to right,transparent,var(--cyan-border),transparent);transform:translateY(-50%)}
    .crosshair-h{position:absolute;top:50%;left:calc(50% - 24px);width:48px;height:1px;background:rgba(0,229,255,.35);transform:translateY(-50%)}
    .crosshair-v{position:absolute;left:50%;top:calc(50% - 24px);width:1px;height:48px;background:rgba(0,229,255,.35);transform:translateX(-50%)}

    /* ‚îÄ‚îÄ DISTANCE SCALE RINGS ‚îÄ‚îÄ */
    #scale-rings{position:absolute;inset:0;pointer-events:none;overflow:hidden}
    .scale-ring{position:absolute;left:50%;top:90%;transform:translate(-50%,-50%);border-radius:50%;border:1px solid rgba(0,229,255,0.12);pointer-events:none}
    .scale-ring-label{position:absolute;font-family:'Space Mono',monospace;font-size:8px;color:rgba(0,229,255,0.35);white-space:nowrap}

    /* ‚îÄ‚îÄ COMPASS ‚îÄ‚îÄ */
    #compass-bar{position:fixed;top:0;left:0;right:0;z-index:20;height:52px;background:linear-gradient(to bottom,rgba(2,13,26,.92),transparent);pointer-events:none;overflow:hidden}
    #compass-track{position:relative;width:100%;height:52px;overflow:hidden}
    .compass-label{position:absolute;top:50%;transform:translateX(-50%) translateY(-50%);font-family:'Space Mono',monospace;font-size:10px;color:var(--muted);letter-spacing:.05em}
    .compass-label.cardinal{font-size:12px;font-weight:700;color:var(--cyan)}
    #compass-center{position:absolute;left:50%;top:0;bottom:0;width:1px;background:var(--cyan);transform:translateX(-50%);z-index:2}
    #compass-center::before{content:'';position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:5px;height:5px;background:var(--cyan);border-radius:50%}

    #heading-display{position:fixed;top:56px;left:50%;transform:translateX(-50%);z-index:20;font-family:'Space Mono',monospace;font-size:13px;color:var(--cyan);background:var(--surface);border:1px solid var(--cyan-border);border-radius:20px;padding:4px 14px;letter-spacing:.1em;backdrop-filter:blur(10px);pointer-events:none}

    /* ‚îÄ‚îÄ COMPASS CALIBRATION ‚îÄ‚îÄ */
    #compass-warning{position:fixed;top:106px;left:50%;transform:translateX(-50%);z-index:25;background:rgba(251,191,36,.12);border:1px solid rgba(251,191,36,.45);border-radius:20px;padding:5px 14px;font-family:'Space Mono',monospace;font-size:10px;color:var(--gold);pointer-events:auto;cursor:pointer;display:none}

    /* Compass offset calibration */
    #compass-calibrate{position:fixed;top:136px;left:50%;transform:translateX(-50%);z-index:25;display:none;gap:6px;align-items:center;background:var(--surface);border:1px solid var(--cyan-border);border-radius:20px;padding:5px 10px;backdrop-filter:blur(10px)}
    #compass-calibrate.visible{display:flex}
    #compass-calibrate span{font-family:'Space Mono',monospace;font-size:10px;color:var(--muted)}
    #compass-calibrate button{font-family:'Space Mono',monospace;font-size:11px;background:none;border:1px solid var(--cyan-border);border-radius:12px;color:var(--cyan);padding:3px 8px;cursor:pointer}
    #offset-display{font-family:'Space Mono',monospace;font-size:11px;color:var(--cyan);min-width:40px;text-align:center}

    /* ‚îÄ‚îÄ POI LABELS ‚îÄ‚îÄ */
    .poi-label{position:absolute;transform:translateX(-50%) translateY(-50%);display:flex;flex-direction:column;align-items:center;pointer-events:auto;cursor:pointer;transition:opacity .35s}
    .poi-connector{width:1px;background:linear-gradient(to bottom,var(--cyan-border),transparent);margin-bottom:4px}
    .poi-card{background:var(--surface);border:1px solid var(--cyan-border);border-radius:10px;padding:6px 10px;backdrop-filter:blur(14px);min-width:80px;max-width:130px;text-align:center;transition:border-color .15s}
    .poi-label:active .poi-card{border-color:var(--cyan)}
    .poi-type-icon{font-size:13px;margin-bottom:1px;display:block}
    .poi-name{font-family:'Syne',sans-serif;font-weight:600;font-size:11px;color:var(--text);line-height:1.25}
    .poi-distance{font-family:'Space Mono',monospace;font-size:9px;color:var(--cyan);margin-top:2px;letter-spacing:.06em}
    .poi-label[data-fade="1"]{opacity:.9}
    .poi-label[data-fade="2"]{opacity:.6}
    .poi-label[data-fade="3"]{opacity:.3}

    /* ‚îÄ‚îÄ FILTERS ‚îÄ‚îÄ */
    #filter-wrap{position:fixed;bottom:52px;left:0;right:0;z-index:21;display:flex;flex-direction:column;gap:3px;padding-bottom:3px;pointer-events:auto}
    .filter-row{display:flex;gap:5px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;padding:0 12px}
    .filter-row::-webkit-scrollbar{display:none}
    #cat-filter-row{padding-top:5px}
    #dist-filter-row{background:linear-gradient(to top,rgba(2,13,26,.75),transparent);padding:3px 12px}
    .dist-pill,.cat-pill{flex-shrink:0;font-family:'Space Mono',monospace;font-size:10px;letter-spacing:.04em;padding:4px 10px;border-radius:20px;border:1px solid rgba(0,229,255,.18);background:rgba(2,13,26,.55);color:var(--muted);cursor:pointer;backdrop-filter:blur(8px);transition:all .15s}
    .dist-pill:active,.cat-pill:active{transform:scale(.93)}
    .dist-pill.active{border-color:var(--cyan);background:var(--cyan-dim);color:var(--cyan)}
    .cat-pill.active{border-color:var(--cat-color,var(--cyan));background:color-mix(in srgb,var(--cat-color,var(--cyan)) 15%,transparent);color:var(--cat-color,var(--cyan))}

    /* ‚îÄ‚îÄ BOTTOM HUD ‚îÄ‚îÄ */
    #bottom-hud{position:fixed;bottom:0;left:0;right:0;z-index:20;padding:6px 12px;padding-bottom:max(6px,env(safe-area-inset-bottom));background:rgba(2,13,26,.9);display:flex;align-items:center;justify-content:space-between;gap:6px}
    #gps-status{font-family:'Space Mono',monospace;font-size:9px;color:var(--muted);display:flex;align-items:center;gap:5px;flex:1;min-width:0;overflow:hidden;cursor:pointer}
    #gps-text{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .status-dot{width:6px;height:6px;border-radius:50%;background:var(--muted);flex-shrink:0}
    .status-dot.active{background:var(--green);box-shadow:0 0 6px var(--green)}
    .status-dot.error{background:var(--red);box-shadow:0 0 6px var(--red)}
    .status-dot.manual{background:var(--gold);box-shadow:0 0 6px var(--gold)}
    #poi-count{font-family:'Space Mono',monospace;font-size:9px;color:var(--muted);white-space:nowrap;flex-shrink:0}
    #hud-btns{display:flex;gap:5px;flex-shrink:0}
    .hud-btn{font-family:'Space Mono',monospace;font-size:11px;color:var(--cyan);background:var(--cyan-dim);border:1px solid var(--cyan-border);border-radius:16px;padding:4px 10px;cursor:pointer;backdrop-filter:blur(8px);transition:background .15s;white-space:nowrap}
    .hud-btn:active{background:rgba(0,229,255,.3)}
    .hud-btn.gold{color:var(--gold);background:rgba(251,191,36,.12);border-color:rgba(251,191,36,.4)}

    /* ‚îÄ‚îÄ DETAIL PANEL ‚îÄ‚îÄ */
    #detail-panel{position:fixed;bottom:108px;left:14px;right:14px;z-index:30;background:rgba(2,18,34,.96);border:1px solid var(--cyan-border);border-radius:16px;padding:16px 18px;backdrop-filter:blur(20px);display:none;pointer-events:auto;max-height:70vh;overflow-y:auto}
    #detail-panel.visible{display:block}
    #detail-close{position:absolute;top:10px;right:14px;font-family:'Space Mono',monospace;font-size:16px;background:none;border:none;color:var(--muted);cursor:pointer}
    #detail-icon{font-size:26px;margin-bottom:5px}
    #detail-name{font-size:19px;font-weight:800;color:var(--text);margin-bottom:3px}
    #detail-type{font-family:'Space Mono',monospace;font-size:10px;color:var(--cyan);letter-spacing:.1em;text-transform:uppercase;margin-bottom:10px}
    #detail-meta{display:flex;gap:16px;flex-wrap:wrap}
    .detail-meta-item{display:flex;flex-direction:column;gap:2px}
    .detail-meta-label{font-family:'Space Mono',monospace;font-size:9px;color:var(--muted);letter-spacing:.08em;text-transform:uppercase}
    .detail-meta-value{font-family:'Space Mono',monospace;font-size:13px;color:var(--text);font-weight:700}
    #detail-actions{display:flex;gap:8px;margin-top:14px;flex-wrap:wrap}
    .detail-btn{flex:1;min-width:100px;font-family:'Syne',sans-serif;font-size:12px;font-weight:700;border-radius:10px;padding:9px 10px;cursor:pointer;text-align:center;transition:opacity .15s;border:none;display:flex;align-items:center;justify-content:center;gap:6px}
    .detail-btn:active{opacity:.75}
    #btn-gmaps{background:#1a73e8;color:white}
    #btn-poi{background:var(--cyan-dim);color:var(--cyan);border:1px solid var(--cyan-border)}
    #nearby-list{margin-top:12px;display:none}
    #nearby-list.visible{display:block}
    #nearby-title{font-family:'Space Mono',monospace;font-size:9px;color:var(--muted);letter-spacing:.08em;text-transform:uppercase;margin-bottom:8px}
    #nearby-items{display:flex;flex-direction:column;gap:5px}
    .nearby-item{display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:8px;background:rgba(0,229,255,.05);border:1px solid rgba(0,229,255,.1);cursor:pointer;transition:background .15s}
    .nearby-item:active{background:rgba(0,229,255,.12)}
    .nearby-item-icon{font-size:14px;flex-shrink:0}
    .nearby-item-name{font-size:12px;font-weight:600;color:var(--text);flex:1}
    .nearby-item-type{font-family:'Space Mono',monospace;font-size:9px;color:var(--muted)}

    /* ‚îÄ‚îÄ MANUAL POSITION MAP ‚îÄ‚îÄ */
    #map-modal{position:fixed;inset:0;z-index:200;background:rgba(2,13,26,.97);display:none;flex-direction:column}
    #map-modal.visible{display:flex}
    #map-header{padding:14px 16px;display:flex;align-items:center;justify-content:space-between;background:rgba(2,13,26,.9);border-bottom:1px solid var(--cyan-border);flex-shrink:0}
    #map-header-title{font-family:'Syne',sans-serif;font-weight:800;font-size:16px;color:var(--text)}
    #map-header-sub{font-family:'Space Mono',monospace;font-size:10px;color:var(--muted);margin-top:2px}
    #map-close-btn{font-family:'Space Mono',monospace;font-size:14px;background:none;border:1px solid var(--cyan-border);color:var(--muted);border-radius:10px;padding:4px 10px;cursor:pointer}
    #leaflet-map{flex:1;z-index:1}
    #map-footer{padding:12px 16px;background:rgba(2,13,26,.9);border-top:1px solid var(--cyan-border);display:flex;gap:10px;align-items:center;flex-shrink:0}
    #map-coords-display{font-family:'Space Mono',monospace;font-size:10px;color:var(--muted);flex:1}
    #map-confirm-btn{font-family:'Syne',sans-serif;font-weight:800;font-size:14px;background:var(--cyan);color:var(--bg);border:none;border-radius:12px;padding:10px 20px;cursor:pointer;transition:opacity .15s}
    #map-confirm-btn:disabled{opacity:.4;cursor:not-allowed}
    #map-confirm-btn:not(:disabled):active{opacity:.8}

    /* ‚îÄ‚îÄ STARTUP ‚îÄ‚îÄ */
    #startup{position:fixed;inset:0;z-index:100;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:22px;padding:32px;overflow-y:auto}
    .startup-logo{font-family:'Syne',sans-serif;font-size:48px;font-weight:800;color:var(--text);letter-spacing:-.03em;line-height:1}
    .startup-logo span{color:var(--cyan)}
    .startup-subtitle{font-family:'Space Mono',monospace;font-size:11px;color:var(--muted);letter-spacing:.15em;text-align:center}
    .startup-perms{display:flex;flex-direction:column;gap:8px;width:100%}
    .perm-item{display:flex;align-items:center;gap:12px;background:rgba(0,229,255,.05);border:1px solid var(--cyan-border);border-radius:12px;padding:11px 14px;font-size:13px;color:var(--muted)}
    .perm-icon{font-size:20px;flex-shrink:0}
    .perm-status{margin-left:auto;font-family:'Space Mono',monospace;font-size:10px;color:var(--muted)}
    .perm-item.ok{border-color:rgba(34,211,160,.45)}
    .perm-item.ok .perm-status{color:var(--green)}
    .perm-item.denied{border-color:rgba(255,77,109,.45)}
    .perm-item.denied .perm-status{color:var(--red)}
    #gps-help{display:none;width:100%;background:rgba(255,77,109,.07);border:1px solid rgba(255,77,109,.3);border-radius:12px;padding:14px 16px}
    #gps-help.visible{display:block}
    #gps-help-title{font-weight:700;font-size:13px;color:var(--red);margin-bottom:8px}
    #gps-help-body{font-family:'Space Mono',monospace;font-size:10px;color:var(--muted);line-height:1.9;white-space:pre-line}
    #gps-retry-btn{margin-top:10px;width:100%;background:rgba(255,77,109,.12);border:1px solid rgba(255,77,109,.4);border-radius:10px;padding:9px;font-family:'Syne',sans-serif;font-size:13px;font-weight:700;color:var(--red);cursor:pointer}
    #start-btn{width:100%;background:var(--cyan);color:var(--bg);border:none;border-radius:14px;padding:15px;font-family:'Syne',sans-serif;font-size:16px;font-weight:800;cursor:pointer;letter-spacing:.05em;transition:opacity .2s}
    #start-btn:disabled{opacity:.45;cursor:not-allowed}
    #start-btn:not(:disabled):active{opacity:.8}

    /* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
    #loading-ring{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:25;display:none}
    #loading-ring.on{display:block}
    #loading-ring svg{animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STARTUP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="startup">
  <div style="text-align:center">
    <div class="startup-logo">HORI<span>ZON</span></div>
    <div class="startup-subtitle" style="margin-top:6px">CE QUI EST DEVANT VOUS</div>
  </div>
  <div class="startup-perms">
    <div class="perm-item" id="perm-camera">
      <span class="perm-icon">üì∑</span><span>Cam√©ra</span>
      <span class="perm-status">EN ATTENTE</span>
    </div>
    <div class="perm-item" id="perm-gps">
      <span class="perm-icon">üìç</span><span>Localisation GPS</span>
      <span class="perm-status">EN ATTENTE</span>
    </div>
    <div class="perm-item" id="perm-compass">
      <span class="perm-icon">üß≠</span><span>Boussole</span>
      <span class="perm-status">EN ATTENTE</span>
    </div>
  </div>
  <div id="gps-help">
    <div id="gps-help-title">‚ö† Localisation refus√©e</div>
    <div id="gps-help-body"></div>
    <button id="gps-retry-btn" onclick="retryGPS()">‚Ü∫ R√©essayer</button>
  </div>
  <button id="start-btn" onclick="initApp()">D√©marrer</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CAMERA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<video id="camera-feed" autoplay playsinline muted></video>
<div class="vignette"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AR OVERLAY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="ar-overlay">
  <div id="scale-rings"></div>
  <div class="crosshair-h"></div>
  <div class="crosshair-v"></div>
  <div class="horizon-line"></div>
  <div id="poi-container"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê COMPASS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="compass-bar"><div id="compass-track"><div id="compass-center"></div></div></div>
<div id="heading-display">---¬∞ N</div>
<div id="compass-warning" onclick="toggleCalibrate()">‚ö† Boussole non calibr√©e ‚Äî tap pour corriger ‚úï</div>
<div id="compass-calibrate">
  <span>Offset :</span>
  <button onclick="changeOffset(-5)">‚àí5¬∞</button>
  <button onclick="changeOffset(-1)">‚àí1¬∞</button>
  <span id="offset-display">0¬∞</span>
  <button onclick="changeOffset(+1)">+1¬∞</button>
  <button onclick="changeOffset(+5)">+5¬∞</button>
  <button onclick="toggleCalibrate()">‚úï</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê FILTERS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="filter-wrap">
  <div class="filter-row" id="cat-filter-row"></div>
  <div class="filter-row" id="dist-filter-row"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BOTTOM HUD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="bottom-hud">
  <div id="gps-status" onclick="openMapModal()">
    <div class="status-dot" id="gps-dot"></div>
    <span id="gps-text">GPS inactif ‚Äî tap pour position manuelle</span>
  </div>
  <div id="poi-count">‚Äî</div>
  <div id="hud-btns">
    <button class="hud-btn gold" onclick="openMapModal()" title="Position manuelle">üìç</button>
    <button class="hud-btn" onclick="refreshPOIs()">‚Üª</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LOADING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="loading-ring">
  <svg width="38" height="38" viewBox="0 0 38 38">
    <circle cx="19" cy="19" r="15" fill="none" stroke="rgba(0,229,255,0.12)" stroke-width="3"/>
    <circle cx="19" cy="19" r="15" fill="none" stroke="#00e5ff" stroke-width="3" stroke-dasharray="22 72" stroke-linecap="round"/>
  </svg>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DETAIL PANEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="detail-panel">
  <button id="detail-close" onclick="closeDetail()">‚úï</button>
  <div id="detail-icon">üìç</div>
  <div id="detail-name">‚Äî</div>
  <div id="detail-type">‚Äî</div>
  <div id="detail-meta">
    <div class="detail-meta-item">
      <span class="detail-meta-label">Distance</span>
      <span class="detail-meta-value" id="detail-dist">‚Äî</span>
    </div>
    <div class="detail-meta-item">
      <span class="detail-meta-label">Direction</span>
      <span class="detail-meta-value" id="detail-bearing">‚Äî</span>
    </div>
    <div class="detail-meta-item">
      <span class="detail-meta-label">Coordonn√©es</span>
      <span class="detail-meta-value" id="detail-coords">‚Äî</span>
    </div>
  </div>
  <div id="detail-actions">
    <button class="detail-btn" id="btn-gmaps" onclick="openGoogleMaps()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
      Google Maps
    </button>
    <button class="detail-btn" id="btn-poi" onclick="loadNearbyPOIs()">üîç Lieux √† voir</button>
  </div>
  <div id="nearby-list">
    <div id="nearby-title">LIEUX √Ä PROXIMIT√â</div>
    <div id="nearby-items"></div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MANUAL POSITION MAP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="map-modal">
  <div id="map-header">
    <div>
      <div id="map-header-title">üìç Choisir ma position</div>
      <div id="map-header-sub">Tap sur la carte pour te placer, puis confirme</div>
    </div>
    <button id="map-close-btn" onclick="closeMapModal()">‚úï Annuler</button>
  </div>
  <div id="leaflet-map"></div>
  <div id="map-footer">
    <div id="map-coords-display">Tap sur la carte‚Ä¶</div>
    <button id="map-confirm-btn" disabled onclick="confirmManualPos()">Confirmer</button>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DISTANCES = [
  {label:'500m', value:500},   {label:'1km', value:1000},
  {label:'2km',  value:2000},  {label:'5km', value:5000},
  {label:'10km', value:10000}, {label:'25km', value:25000},
  {label:'50km', value:50000},
];
const CATEGORIES = [
  {id:'all',        label:'üåê Tout',       color:'#00e5ff'},
  {id:'city',       label:'üèô Villes',      color:'#a78bfa'},
  {id:'coast',      label:'üó∫ C√¥te & Caps', color:'#38bdf8'},
  {id:'island',     label:'üèù √éles',        color:'#34d399'},
  {id:'mountain',   label:'‚õ∞ Montagnes',   color:'#fb923c'},
  {id:'forest',     label:'üå≤ For√™ts',      color:'#4ade80'},
  {id:'lighthouse', label:'üóº Phares',      color:'#fbbf24'},
];

const FOV = 75;
const FOV_HALF = FOV / 2;
// Low-pass filter alpha for compass smoothing (lower = smoother but more lag)
const COMPASS_ALPHA = 0.12;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const state = {
  userLat: null, userLng: null,
  headingRaw: null,  // latest raw reading
  headingSmooth: null, // low-pass filtered
  compassOffset: 0,    // manual calibration offset in degrees
  compassSource: null,
  compassWarningShown: false,
  gpsReady: false,
  gpsManual: false,
  allPois: [], pois: [],
  lastFetchLat: null, lastFetchLng: null,
  maxDist: 50000,
  activeCat: 'all',
  detailPoi: null,
};

let compassWarningTimer = null;
let leafletMap = null;
let leafletMarker = null;
let pendingManualLat = null, pendingManualLng = null;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function initApp() {
  const btn = document.getElementById('start-btn');
  btn.disabled = true; btn.textContent = 'Initialisation‚Ä¶';

  // ‚îÄ‚îÄ Camera (with 8s timeout ‚Äî never block forever) ‚îÄ‚îÄ
  try {
    const camPromise = navigator.mediaDevices.getUserMedia({
      video:{facingMode:{ideal:'environment'}, width:{ideal:1280}}, audio:false
    });
    const timeoutPromise = new Promise((_, reject) =>
      setTimeout(() => reject(new Error('timeout')), 8000)
    );
    const stream = await Promise.race([camPromise, timeoutPromise]);
    document.getElementById('camera-feed').srcObject = stream;
    setPermStatus('camera','ok');
  } catch(e) {
    // Camera failed ‚Äî continue anyway (app still works without it)
    setPermStatus('camera','denied');
    console.warn('Camera unavailable:', e.message);
    // Show dark background instead
    document.getElementById('camera-feed').style.display = 'none';
    document.body.style.background = 'linear-gradient(180deg,#020d1a 0%,#041428 100%)';
  }

  // ‚îÄ‚îÄ GPS (fire and forget ‚Äî never blocks startup) ‚îÄ‚îÄ
  if (!navigator.geolocation) {
    setPermStatus('gps','denied'); showGPSHelp('not_supported');
  } else {
    setPermStatus('gps','waiting'); startGPS();
  }

  // ‚îÄ‚îÄ Compass ‚îÄ‚îÄ
  if (typeof DeviceOrientationEvent !== 'undefined' &&
      typeof DeviceOrientationEvent.requestPermission === 'function') {
    try {
      const p = await Promise.race([
        DeviceOrientationEvent.requestPermission(),
        new Promise(r => setTimeout(() => r('timeout'), 5000))
      ]);
      if (p === 'granted') {
        window.addEventListener('deviceorientation', onOrientation, true);
        setPermStatus('compass','ok');
      } else { setPermStatus('compass', p === 'timeout' ? 'waiting' : 'denied'); }
    } catch(e) { setPermStatus('compass','denied'); }
  } else {
    window.addEventListener('deviceorientationabsolute', onOrientationAbsolute, true);
    window.addEventListener('deviceorientation', onOrientation, true);
    setPermStatus('compass','ok');
  }

  buildFilters();
  buildScaleRings();

  // ‚îÄ‚îÄ Always dismiss startup ‚îÄ‚îÄ
  const startup = document.getElementById('startup');
  startup.style.transition = 'opacity .5s';
  startup.style.opacity = '0';
  setTimeout(() => startup.style.display = 'none', 500);
  renderLoop();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GPS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function startGPS() {
  if (navigator.permissions) {
    try {
      const p = await navigator.permissions.query({name:'geolocation'});
      if (p.state === 'denied') {
        setPermStatus('gps','denied'); showGPSHelp(1); updateGPSDot('error');
        document.getElementById('gps-text').textContent = 'GPS refus√© ‚Äî üìç tap pour position manuelle';
        return;
      }
    } catch(e) {}
  }
  navigator.geolocation.getCurrentPosition(
    pos => { onGPS(pos); setPermStatus('gps','ok'); document.getElementById('gps-help').classList.remove('visible');
      navigator.geolocation.watchPosition(onGPS, onGPSErr, {enableHighAccuracy:true, maximumAge:5000, timeout:20000}); },
    err => { setPermStatus('gps','denied'); showGPSHelp(err.code); updateGPSDot('error');
      document.getElementById('gps-text').textContent = gpsErrMsg(err.code) + ' ‚Äî üìç tap pour position manuelle'; },
    {enableHighAccuracy:true, timeout:20000, maximumAge:0}
  );
}

function retryGPS() { document.getElementById('gps-help').classList.remove('visible'); setPermStatus('gps','waiting'); startGPS(); }

function onGPS(pos) {
  if (state.gpsManual) return; // don't override manual position
  state.userLat = pos.coords.latitude;
  state.userLng = pos.coords.longitude;
  state.gpsReady = true;
  updateGPSDot('active');
  const acc = Math.round(pos.coords.accuracy);
  document.getElementById('gps-text').textContent = `${state.userLat.toFixed(5)}, ${state.userLng.toFixed(5)} ¬±${acc}m`;
  const moved = state.lastFetchLat !== null ? haversine(state.userLat,state.userLng,state.lastFetchLat,state.lastFetchLng) : Infinity;
  if (moved > 200) fetchPOIs();
}

function onGPSErr(err) { updateGPSDot('error'); document.getElementById('gps-text').textContent = gpsErrMsg(err.code); }
function gpsErrMsg(c) { return {1:'GPS refus√©',2:'GPS indisponible',3:'GPS : d√©lai d√©pass√©'}[c]||'Erreur GPS'; }
function updateGPSDot(s) {
  const d = document.getElementById('gps-dot');
  d.classList.remove('active','error','manual');
  d.classList.add(s);
}

function showGPSHelp(code) {
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  const isAndroid = /Android/.test(navigator.userAgent);
  let msg = '';
  if (code === 1) {
    if (isIOS) msg = '1. R√©glages ‚öôÔ∏è ‚Üí Confidentialit√© & S√©curit√©\n   ‚Üí Service de localisation\n2. Trouve Safari ‚Üí ¬´ Lors de l\'utilisation ¬ª\n3. R√©essayer\n\nOu utilise la position manuelle üìç';
    else if (isAndroid) msg = '1. Appuie sur üîí dans la barre d\'adresse\n2. Autorisations ‚Üí Localisation ‚Üí Autoriser\n3. R√©essayer\n\nOu utilise la position manuelle üìç';
    else msg = 'Autorise la localisation dans les param√®tres,\npuis R√©essayer. Ou utilise la position manuelle üìç';
  } else if (code === 2) { msg = 'Signal GPS indisponible.\nActive le GPS puis R√©essayer.\nOu utilise la position manuelle üìç'; }
  else if (code === 3) { msg = 'D√©lai GPS d√©pass√©. Essaie en ext√©rieur.\nOu utilise la position manuelle üìç'; }
  else { msg = 'GPS non support√©. Utilise la position manuelle üìç'; }
  document.getElementById('gps-help-body').textContent = msg;
  document.getElementById('gps-help').classList.add('visible');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MANUAL POSITION (Leaflet map)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openMapModal() {
  document.getElementById('map-modal').classList.add('visible');
  setTimeout(() => {
    if (!leafletMap) {
      const initLat = state.userLat || 48.0;
      const initLng = state.userLng || -2.0;
      leafletMap = L.map('leaflet-map').setView([initLat, initLng], state.gpsReady ? 13 : 6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution:'¬© OpenStreetMap', maxZoom:19
      }).addTo(leafletMap);

      // If we already have a position, show marker
      if (state.userLat) {
        leafletMarker = L.marker([state.userLat, state.userLng], {draggable:true}).addTo(leafletMap);
        leafletMarker.bindPopup('Ma position').openPopup();
        pendingManualLat = state.userLat; pendingManualLng = state.userLng;
        updateMapFooter(state.userLat, state.userLng);
        document.getElementById('map-confirm-btn').disabled = false;
        leafletMarker.on('dragend', e => {
          const ll = e.target.getLatLng();
          pendingManualLat = ll.lat; pendingManualLng = ll.lng;
          updateMapFooter(ll.lat, ll.lng);
        });
      }

      leafletMap.on('click', e => {
        pendingManualLat = e.latlng.lat; pendingManualLng = e.latlng.lng;
        updateMapFooter(e.latlng.lat, e.latlng.lng);
        document.getElementById('map-confirm-btn').disabled = false;
        if (leafletMarker) { leafletMarker.setLatLng(e.latlng); }
        else { leafletMarker = L.marker(e.latlng, {draggable:true}).addTo(leafletMap);
          leafletMarker.on('dragend', ev => {
            const ll = ev.target.getLatLng();
            pendingManualLat = ll.lat; pendingManualLng = ll.lng;
            updateMapFooter(ll.lat, ll.lng);
          });
        }
      });
    } else {
      leafletMap.invalidateSize();
      if (state.userLat) leafletMap.setView([state.userLat, state.userLng]);
    }
  }, 100);
}

function updateMapFooter(lat, lng) {
  document.getElementById('map-coords-display').textContent = `${lat.toFixed(5)}, ${lng.toFixed(5)}`;
}

function closeMapModal() {
  document.getElementById('map-modal').classList.remove('visible');
  pendingManualLat = null; pendingManualLng = null;
  if (leafletMarker && !state.gpsManual) { leafletMarker.remove(); leafletMarker = null; }
}

function confirmManualPos() {
  if (pendingManualLat === null) return;
  state.userLat = pendingManualLat;
  state.userLng = pendingManualLng;
  state.gpsReady = true;
  state.gpsManual = true;
  updateGPSDot('manual');
  document.getElementById('gps-text').textContent = `üìç Manuel : ${state.userLat.toFixed(4)}, ${state.userLng.toFixed(4)}`;
  document.getElementById('map-modal').classList.remove('visible');
  // Recalculate bearings for all existing POIs
  if (state.allPois.length) {
    state.allPois.forEach(p => {
      p.dist = haversine(state.userLat, state.userLng, p.lat, p.lng);
      p.bearing = calcBearing(state.userLat, state.userLng, p.lat, p.lng);
    });
    state.allPois.sort((a,b) => a.dist - b.dist);
    applyFilter();
  }
  state.lastFetchLat = null;
  fetchPOIs();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  COMPASS ‚Äî with low-pass filter + manual offset
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function onOrientationAbsolute(e) {
  if (e.alpha === null) return;
  updateHeadingRaw((360 - e.alpha + 360) % 360);
  state.compassSource = 'absolute';
  hideCompassWarning();
}

let compassRelativeTimer = null;
function onOrientation(e) {
  if (state.compassSource === 'absolute') { hideCompassWarning(); return; }
  if (e.webkitCompassHeading != null) {
    updateHeadingRaw(e.webkitCompassHeading);
    state.compassSource = 'ios';
    hideCompassWarning();
    return;
  }
  if (e.alpha !== null) {
    updateHeadingRaw((360 - e.alpha + 360) % 360);
    if (state.compassSource !== 'relative') {
      state.compassSource = 'relative';
      // Show warning after 3s if still relative
      if (!compassRelativeTimer) {
        compassRelativeTimer = setTimeout(() => {
          if (state.compassSource === 'relative') showCompassWarning();
        }, 3000);
      }
    }
  }
}

function updateHeadingRaw(raw) {
  state.headingRaw = raw;
  if (state.headingSmooth === null) {
    state.headingSmooth = raw;
  } else {
    // Low-pass filter with wrap-around handling
    let diff = raw - state.headingSmooth;
    // Handle wrap-around
    if (diff > 180) diff -= 360;
    if (diff < -180) diff += 360;
    state.headingSmooth = (state.headingSmooth + COMPASS_ALPHA * diff + 360) % 360;
  }
}

function getHeading() {
  if (state.headingSmooth === null) return null;
  return (state.headingSmooth + state.compassOffset + 360) % 360;
}

function showCompassWarning() {
  if (state.compassWarningShown) return;
  state.compassWarningShown = true;
  document.getElementById('compass-warning').style.display = 'block';
}
function hideCompassWarning() {
  if (compassRelativeTimer) { clearTimeout(compassRelativeTimer); compassRelativeTimer = null; }
  document.getElementById('compass-warning').style.display = 'none';
  document.getElementById('compass-calibrate').classList.remove('visible');
  state.compassWarningShown = false;
}
function toggleCalibrate() {
  const el = document.getElementById('compass-calibrate');
  el.classList.toggle('visible');
}
function changeOffset(delta) {
  state.compassOffset = (state.compassOffset + delta + 360) % 360;
  if (state.compassOffset > 180) state.compassOffset -= 360;
  document.getElementById('offset-display').textContent = (state.compassOffset >= 0 ? '+' : '') + state.compassOffset + '¬∞';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FILTERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildFilters() {
  const catBar = document.getElementById('cat-filter-row');
  catBar.innerHTML = '';
  CATEGORIES.forEach(c => {
    const btn = document.createElement('button');
    btn.className = 'cat-pill' + (c.id === state.activeCat ? ' active' : '');
    btn.textContent = c.label;
    btn.style.setProperty('--cat-color', c.color);
    btn.addEventListener('click', () => selectCat(c.id));
    catBar.appendChild(btn);
  });
  const distBar = document.getElementById('dist-filter-row');
  distBar.innerHTML = '';
  DISTANCES.forEach(d => {
    const btn = document.createElement('button');
    btn.className = 'dist-pill' + (d.value === state.maxDist ? ' active' : '');
    // For > 2km show "~Xkm" to hint at band mode
    btn.textContent = d.value > 2000 ? '~' + d.label : d.label;
    btn.title = d.value > 2000
      ? `Affiche entre ${fmtDist(d.value*0.9)} et ${fmtDist(d.value*1.1)}`
      : `Affiche de 0 √† ${fmtDist(d.value*1.15)}`;
    btn.addEventListener('click', () => selectDist(d.value));
    distBar.appendChild(btn);
  });
}

function selectCat(id) {
  state.activeCat = id;
  document.querySelectorAll('.cat-pill').forEach((b,i) => b.classList.toggle('active', CATEGORIES[i].id === id));
  applyFilter();
}
function selectDist(m) {
  state.maxDist = m;
  document.querySelectorAll('.dist-pill').forEach((b,i) => b.classList.toggle('active', DISTANCES[i].value === m));
  buildScaleRings();
  applyFilter();
}

function distBand(d) {
  // Returns [minDist, maxDist] for a given distance value
  // ‚â§ 2km: show 0 ‚Üí d*1.1 (everything nearby)
  // > 2km: show d*0.9 ‚Üí d*1.1 (band around the distance)
  if (d <= 2000) return [0, d * 1.15];
  return [d * 0.9, d * 1.1];
}

function applyFilter() {
  const [dMin, dMax] = distBand(state.maxDist);

  let filtered = state.allPois.filter(p => {
    if (p.dist < dMin || p.dist > dMax) return false;
    if (state.activeCat === 'all') return true;
    return p.type.cat === state.activeCat;
  });

  // Cap at 60 results, sorted by distance
  state.pois = filtered.slice(0, 60);

  poiElements.forEach(el => el.remove());
  poiElements.clear();

  const bandLabel = state.maxDist > 2000
    ? `${fmtDist(dMin)}‚Äì${fmtDist(dMax)}`
    : `0‚Äì${fmtDist(dMax)}`;
  document.getElementById('poi-count').textContent =
    `${state.pois.length} pt${state.pois.length !== 1 ? 's' : ''} ¬∑ ${bandLabel}`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SCALE RINGS (visual distance guide on AR overlay)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildScaleRings() {
  const container = document.getElementById('scale-rings');
  container.innerHTML = '';
  const W = window.innerWidth, H = window.innerHeight;
  // Show 3 rings: 20%, 50%, 100% of max distance
  const fractions = [0.2, 0.5, 1.0];
  fractions.forEach(f => {
    const dist = state.maxDist * f;
    // Ring radius proportional to distance (perspective simulation)
    const minR = W * 0.15, maxR = W * 1.2;
    const r = minR + (maxR - minR) * f;
    const ring = document.createElement('div');
    ring.className = 'scale-ring';
    ring.style.width = (r * 2) + 'px';
    ring.style.height = (r * 2) + 'px';
    ring.style.marginLeft = -r + 'px';
    ring.style.marginTop = -r + 'px';
    ring.style.opacity = 0.4 + f * 0.3;
    container.appendChild(ring);
    // Label
    const label = document.createElement('div');
    label.className = 'scale-ring-label';
    label.textContent = fmtDist(dist);
    label.style.left = (W / 2 + r * 0.7) + 'px';
    label.style.top = (H * 0.9 - r * 0.28) + 'px';
    container.appendChild(label);
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FETCH POIs ‚Äî comprehensive Overpass query
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function fetchPOIs() {
  if (!state.userLat) return;
  document.getElementById('loading-ring').classList.add('on');
  const lat = state.userLat, lng = state.userLng;
  const radius = 50000;

  // IMPORTANT: OSM forests/mountains are mostly ways & relations, not nodes
  // Use nwr (node+way+relation) for natural features
  // place=locality covers lieux-dits
  const query = `
[out:json][timeout:30];
(
  node["place"~"^(island|islet|city|town|village|hamlet|suburb|locality|isolated_dwelling)$"](around:${radius},${lat},${lng});
  nwr["natural"~"^(peak|volcano|cliff|cape|bay|strait|peninsula|headland)$"]["name"](around:${radius},${lat},${lng});
  nwr["natural"="wood"]["name"](around:${radius},${lat},${lng});
  nwr["landuse"="forest"]["name"](around:${radius},${lat},${lng});
  nwr["man_made"="lighthouse"]["name"](around:${radius},${lat},${lng});
  nwr["place"~"^(island|islet)$"]["name"](around:${radius},${lat},${lng});
);
out center 500;
  `.trim();

  try {
    const resp = await fetch('https://overpass-api.de/api/interpreter', {method:'POST', body:query});
    const data = await resp.json();
    processPOIs(data.elements, lat, lng);
    state.lastFetchLat = lat; state.lastFetchLng = lng;
  } catch(e) {
    console.warn('Overpass:', e);
    document.getElementById('poi-count').textContent = 'Erreur r√©seau';
  } finally {
    document.getElementById('loading-ring').classList.remove('on');
  }
}

function processPOIs(elements, userLat, userLng) {
  const seen = new Set(), results = [];
  for (const el of elements) {
    const eLat = el.lat ?? el.center?.lat;
    const eLng = el.lon ?? el.center?.lon;
    if (!eLat || !eLng) continue;
    const name = el.tags?.name || el.tags?.['name:fr'];
    if (!name || seen.has(name.toLowerCase())) continue;
    seen.add(name.toLowerCase());
    const dist = haversine(userLat, userLng, eLat, eLng);
    if (dist < 50) continue;
    results.push({
      name, lat:eLat, lng:eLng, dist,
      bearing: calcBearing(userLat, userLng, eLat, eLng),
      type: classifyPOI(el.tags, name)
    });
  }
  results.sort((a,b) => a.dist - b.dist);
  state.allPois = results; // keep all, bucketing happens in applyFilter
  applyFilter();
}

function classifyPOI(tags, name) {
  if (!tags) return {emoji:'üìç', label:'Lieu', cat:'all'};
  const p = tags.place, n = tags.natural, m = tags.man_made, lu = tags.landuse;
  const nm = (name||'').toLowerCase();

  if (n === 'wood' || lu === 'forest')
    return {emoji:'üå≤', label:'For√™t', cat:'forest'};
  if (m === 'lighthouse')
    return {emoji:'üóº', label:'Phare', cat:'lighthouse'};
  if (p === 'island' || p === 'islet')
    return {emoji:'üèùÔ∏è', label:'√éle', cat:'island'};
  if (n === 'peak' || n === 'volcano')
    return {emoji:'‚õ∞Ô∏è', label:'Sommet', cat:'mountain'};
  if (n === 'cape' || n === 'peninsula' || n === 'headland' ||
      nm.startsWith('pointe') || nm.startsWith('cap ') || nm.startsWith('cap-') ||
      nm === 'pointe du raz' || nm.includes("presqu'√Æle") || nm.includes('tas de'))
    return {emoji:'üó∫Ô∏è', label:'Cap / Pointe', cat:'coast'};
  if (n === 'bay')    return {emoji:'üåä', label:'Baie', cat:'coast'};
  if (n === 'strait') return {emoji:'„Ä∞Ô∏è', label:'D√©troit', cat:'coast'};
  if (n === 'cliff')  return {emoji:'ü™®', label:'Falaise', cat:'coast'};
  if (p === 'city')   return {emoji:'üèôÔ∏è', label:'Ville', cat:'city'};
  if (p === 'town')   return {emoji:'üèòÔ∏è', label:'Bourg', cat:'city'};
  if (p === 'village' || p === 'hamlet' || p === 'suburb')
    return {emoji:'üè°', label:'Village', cat:'city'};
  if (p === 'locality' || p === 'isolated_dwelling')
    return {emoji:'üìå', label:'Lieu-dit', cat:'city'};
  return {emoji:'üìç', label:'Lieu', cat:'all'};
}

function refreshPOIs() { state.lastFetchLat = null; if (state.gpsReady) fetchPOIs(); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER LOOP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const COMPASS_POINTS = [
  {deg:0,label:'N'},{deg:22.5,label:'NNE'},{deg:45,label:'NE'},{deg:67.5,label:'ENE'},
  {deg:90,label:'E'},{deg:112.5,label:'ESE'},{deg:135,label:'SE'},{deg:157.5,label:'SSE'},
  {deg:180,label:'S'},{deg:202.5,label:'SSO'},{deg:225,label:'SO'},{deg:247.5,label:'OSO'},
  {deg:270,label:'O'},{deg:292.5,label:'ONO'},{deg:315,label:'NO'},{deg:337.5,label:'NNO'},
];
let compassBuilt = false;

function renderLoop() {
  const heading = getHeading();

  if (!compassBuilt) {
    const track = document.getElementById('compass-track');
    COMPASS_POINTS.forEach(p => {
      const el = document.createElement('div');
      el.className = 'compass-label' + ([0,90,180,270].includes(p.deg) ? ' cardinal' : '');
      el.textContent = p.label; el.dataset.deg = p.deg;
      track.appendChild(el);
    });
    compassBuilt = true;
  }

  if (heading !== null) {
    const W = document.getElementById('compass-track').offsetWidth;
    document.querySelectorAll('.compass-label').forEach(el => {
      const diff = normalizeDeg(parseFloat(el.dataset.deg) - heading);
      const x = W/2 + diff/FOV*W;
      if (x < -40 || x > W+40) { el.style.display='none'; return; }
      el.style.display = '';
      el.style.left = x + 'px';
      el.style.opacity = Math.max(0, 1 - Math.abs(diff)/FOV_HALF * .8);
    });
    const h = Math.round(heading);
    document.getElementById('heading-display').textContent = `${h.toString().padStart(3,'0')}¬∞ ${cardinal(h)}`;
    if (state.gpsReady) updatePOILabels(heading);
  }

  requestAnimationFrame(renderLoop);
}

// ‚îÄ‚îÄ POI rendering ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const poiContainer = document.getElementById('poi-container');
const poiElements  = new Map();
const POI_TOPS = [28,35,42,22,48];

function updatePOILabels(heading) {
  const W = window.innerWidth;
  const visible = [];
  for (const poi of state.pois) {
    const diff = normalizeDeg(poi.bearing - heading);
    if (Math.abs(diff) > FOV_HALF * 1.2) continue;
    visible.push({poi, diff});
  }
  for (const [name, el] of poiElements) {
    if (!visible.find(v => v.poi.name === name)) { el.remove(); poiElements.delete(name); }
  }
  for (const {poi, diff} of visible) {
    let el = poiElements.get(poi.name);
    if (!el) {
      el = buildPOIEl(poi); poiContainer.appendChild(el); poiElements.set(poi.name, el);
    }
    el.style.left = (W/2 + (diff/FOV_HALF)*(W/2)) + 'px';
    const abs = Math.abs(diff);
    el.dataset.fade = abs > FOV_HALF*.7 ? 3 : abs > FOV_HALF*.4 ? 2 : 1;
    // Connector height scales with distance: closer = taller connector
    const maxD = state.maxDist;
    const normalizedDist = Math.min(poi.dist / maxD, 1);
    const connH = Math.round(20 + (1 - normalizedDist) * 40); // 20-60px
    el.querySelector('.poi-connector').style.height = connH + 'px';
  }
}

function buildPOIEl(poi) {
  const el = document.createElement('div');
  el.className = 'poi-label';
  const hash = poi.name.split('').reduce((a,c) => a+c.charCodeAt(0), 0);
  el.style.top = POI_TOPS[hash % POI_TOPS.length] + '%';
  el.innerHTML = `
    <div class="poi-connector" style="height:40px"></div>
    <div class="poi-card">
      <span class="poi-type-icon">${poi.type.emoji}</span>
      <div class="poi-name">${poi.name}</div>
      <div class="poi-distance">${fmtDist(poi.dist)}</div>
    </div>`;
  el.addEventListener('click', () => openDetail(poi));
  return el;
}

// ‚îÄ‚îÄ Detail panel ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openDetail(poi) {
  state.detailPoi = poi;
  document.getElementById('detail-icon').textContent    = poi.type.emoji;
  document.getElementById('detail-name').textContent    = poi.name;
  document.getElementById('detail-type').textContent    = poi.type.label.toUpperCase();
  document.getElementById('detail-dist').textContent    = fmtDist(poi.dist);
  document.getElementById('detail-bearing').textContent = Math.round(poi.bearing) + '¬∞ ' + cardinal(poi.bearing);
  document.getElementById('detail-coords').textContent  = poi.lat.toFixed(4) + ', ' + poi.lng.toFixed(4);
  document.getElementById('btn-poi').style.display      = poi.type.cat === 'city' ? '' : 'none';
  document.getElementById('nearby-list').classList.remove('visible');
  document.getElementById('nearby-items').innerHTML = '';
  document.getElementById('detail-panel').classList.add('visible');
}
function closeDetail() { document.getElementById('detail-panel').classList.remove('visible'); }

function openGoogleMaps() {
  const poi = state.detailPoi; if (!poi) return;
  const url = `https://www.google.com/maps/dir/?api=1&origin=${state.userLat},${state.userLng}&destination=${poi.lat},${poi.lng}&travelmode=driving`;
  window.open(url, '_blank');
}

async function loadNearbyPOIs() {
  const poi = state.detailPoi; if (!poi) return;
  const btn = document.getElementById('btn-poi');
  btn.textContent = '‚è≥ Chargement‚Ä¶'; btn.disabled = true;
  const query = `[out:json][timeout:20];(
    node["tourism"~"^(attraction|museum|viewpoint|artwork|gallery|monument|castle)$"](around:3000,${poi.lat},${poi.lng});
    node["historic"~"^(castle|monument|ruins|church|manor|archaeological_site|memorial)$"](around:3000,${poi.lat},${poi.lng});
    node["amenity"~"^(place_of_worship|theatre)$"]["name"](around:3000,${poi.lat},${poi.lng});
    node["leisure"~"^(park|garden|nature_reserve)$"]["name"](around:3000,${poi.lat},${poi.lng});
    node["natural"~"^(beach|cliff|peak)$"]["name"](around:3000,${poi.lat},${poi.lng});
  );out 25;`;
  try {
    const resp = await fetch('https://overpass-api.de/api/interpreter', {method:'POST', body:query});
    const data = await resp.json();
    const items = data.elements.filter(e => e.tags?.name)
      .map(e => ({name:e.tags.name, tags:e.tags}))
      .filter((e,i,a) => a.findIndex(x => x.name===e.name)===i).slice(0,15);
    const container = document.getElementById('nearby-items');
    container.innerHTML = '';
    if (items.length === 0) {
      container.innerHTML = '<div style="font-family:Space Mono,monospace;font-size:10px;color:var(--muted);padding:8px">Aucun lieu trouv√© dans un rayon de 3km.</div>';
    } else {
      items.forEach(item => {
        const {emoji, label} = classifyNearby(item.tags);
        const div = document.createElement('div');
        div.className = 'nearby-item';
        div.innerHTML = `<span class="nearby-item-icon">${emoji}</span><span class="nearby-item-name">${item.name}</span><span class="nearby-item-type">${label}</span>`;
        div.addEventListener('click', () => window.open(`https://www.google.com/maps/search/${encodeURIComponent(item.name+' '+poi.name)}`,'_blank'));
        container.appendChild(div);
      });
    }
    document.getElementById('nearby-list').classList.add('visible');
  } catch(e) {
    document.getElementById('nearby-items').innerHTML = '<div style="font-family:Space Mono,monospace;font-size:10px;color:var(--red);padding:8px">Erreur r√©seau.</div>';
    document.getElementById('nearby-list').classList.add('visible');
  } finally { btn.textContent = 'üîç Lieux √† voir'; btn.disabled = false; }
}

function classifyNearby(tags) {
  const t=tags.tourism, h=tags.historic, a=tags.amenity, l=tags.leisure, n=tags.natural;
  if (t==='museum')           return {emoji:'üèõ',label:'Mus√©e'};
  if (t==='viewpoint')        return {emoji:'üëÅ',label:'Panorama'};
  if (t==='castle'||h==='castle'||h==='manor') return {emoji:'üè∞',label:'Ch√¢teau'};
  if (h==='church'||a==='place_of_worship')    return {emoji:'‚õ™',label:'Religieux'};
  if (h==='ruins'||h==='archaeological_site')  return {emoji:'üèö',label:'Ruines'};
  if (h==='memorial'||h==='monument'||t==='monument') return {emoji:'üóø',label:'Monument'};
  if (l==='park'||l==='garden')  return {emoji:'üå≥',label:'Parc'};
  if (l==='nature_reserve')      return {emoji:'üåø',label:'R√©serve'};
  if (n==='beach')               return {emoji:'üèñ',label:'Plage'};
  if (n==='peak')                return {emoji:'‚õ∞',label:'Sommet'};
  if (t==='attraction')          return {emoji:'‚≠ê',label:'Attraction'};
  return {emoji:'üìç',label:'Lieu'};
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GEO UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function haversine(lat1,lon1,lat2,lon2) {
  const R=6371000, dLat=(lat2-lat1)*Math.PI/180, dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}
function calcBearing(lat1,lon1,lat2,lon2) {
  const œÜ1=lat1*Math.PI/180, œÜ2=lat2*Math.PI/180, ŒîŒª=(lon2-lon1)*Math.PI/180;
  return (Math.atan2(Math.sin(ŒîŒª)*Math.cos(œÜ2), Math.cos(œÜ1)*Math.sin(œÜ2)-Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(ŒîŒª))*180/Math.PI+360)%360;
}
function normalizeDeg(d) { d=((d%360)+360)%360; return d>180?d-360:d; }
function cardinal(deg) { return ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSO','SO','OSO','O','ONO','NO','NNO'][Math.round(deg/22.5)%16]; }
function fmtDist(m) { return m<1000 ? Math.round(m)+' m' : (m/1000).toFixed(m<10000?1:0)+' km'; }

window.addEventListener('resize', buildScaleRings);
</script>
</body>
</html>
