<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="theme-color" content="#020d1a"/>
  <title>Horizon</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;800&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
:root{--c:#00e5ff;--cd:rgba(0,229,255,.15);--cb:rgba(0,229,255,.35);--gold:#fbbf24;--bg:#020d1a;--sf:rgba(2,18,34,.88);--tx:#e0f4ff;--mu:rgba(180,220,240,.5);--red:#ff4d6d;--gr:#22d3a0}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{background:var(--bg);color:var(--tx);font-family:'Syne',sans-serif;overflow:hidden;height:100dvh;width:100dvw;user-select:none}

/* camera */
#cam{position:fixed;inset:0;width:100%;height:100%;object-fit:cover;z-index:0}
.vig{position:fixed;inset:0;z-index:5;background:radial-gradient(ellipse at center,transparent 40%,rgba(2,13,26,.65) 100%);pointer-events:none}

/* ar overlay */
#ar{position:fixed;inset:0;z-index:10;pointer-events:none}
.hl{position:absolute;left:0;right:0;top:50%;height:1px;background:linear-gradient(to right,transparent,var(--cb),transparent)}
.ch{position:absolute;top:50%;left:calc(50% - 20px);width:40px;height:1px;background:rgba(0,229,255,.4);transform:translateY(-50%)}
.cv{position:absolute;left:50%;top:calc(50% - 20px);width:1px;height:40px;background:rgba(0,229,255,.4);transform:translateX(-50%)}

/* compass */
#cbar{position:fixed;top:0;left:0;right:0;z-index:20;height:52px;background:linear-gradient(to bottom,rgba(2,13,26,.92),transparent);pointer-events:none;overflow:hidden}
#ctrack{position:relative;width:100%;height:52px;overflow:hidden}
.clbl{position:absolute;top:50%;transform:translateX(-50%) translateY(-50%);font-family:'Space Mono',monospace;font-size:10px;color:var(--mu)}
.clbl.card{font-size:12px;font-weight:700;color:var(--c)}
#cctr{position:absolute;left:50%;top:0;bottom:0;width:1px;background:var(--c);transform:translateX(-50%);z-index:2}
#cctr::after{content:'';position:absolute;bottom:0;left:50%;transform:translateX(-50%);width:5px;height:5px;background:var(--c);border-radius:50%}

/* heading badge */
#hdg{position:fixed;top:56px;left:50%;transform:translateX(-50%);z-index:20;font-family:'Space Mono',monospace;font-size:13px;color:var(--c);background:var(--sf);border:1px solid var(--cb);border-radius:20px;padding:4px 14px;letter-spacing:.1em;backdrop-filter:blur(10px);cursor:pointer;transition:background .15s}
#hdg:active{background:rgba(0,229,255,.2)}
#hdg .htip{font-size:8px;color:var(--mu);letter-spacing:0;display:block;text-align:center;margin-top:1px}

/* manual heading controls */
#hmanual{position:fixed;top:98px;left:50%;transform:translateX(-50%);z-index:22;display:none;gap:6px;align-items:center;background:var(--sf);border:1px solid rgba(251,191,36,.4);border-radius:20px;padding:5px 10px;backdrop-filter:blur(10px)}
#hmanual.on{display:flex}
#hmanual span{font-family:'Space Mono',monospace;font-size:9px;color:var(--gold)}
#hmanual button{font-family:'Space Mono',monospace;font-size:12px;background:none;border:1px solid rgba(251,191,36,.35);border-radius:10px;color:var(--gold);padding:3px 9px;cursor:pointer;transition:background .12s}
#hmanual button:active{background:rgba(251,191,36,.15)}

/* menu button */
#mbtn{position:fixed;top:58px;left:12px;z-index:22;width:30px;height:30px;background:rgba(2,13,26,.75);border:1px solid var(--cb);border-radius:50%;cursor:pointer;backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;font-size:13px;color:var(--mu);transition:background .15s}
#mbtn:active{background:rgba(0,229,255,.2)}

/* diagnostic overlay */
#diag{position:fixed;top:58px;right:8px;z-index:30;font-family:'Space Mono',monospace;font-size:9px;color:rgba(0,229,255,.7);background:rgba(2,13,26,.82);border:1px solid rgba(0,229,255,.18);border-radius:8px;padding:5px 8px;line-height:1.9;pointer-events:none;display:none}
#diag.on{display:block}
#dg1,#dg2,#dg3,#dg4{white-space:nowrap}
.dgerr{color:var(--red)!important}.dgok{color:var(--gr)!important}.dgwarn{color:var(--gold)!important}

/* poi labels */
.poi{position:absolute;transform:translateX(-50%) translateY(-50%);display:flex;flex-direction:column;align-items:center;pointer-events:auto;cursor:pointer;transition:left .12s linear,opacity .4s}
.poc{width:1px;background:linear-gradient(to bottom,var(--cb),transparent);margin-bottom:3px}
.pob{background:var(--sf);border:1px solid var(--cb);border-radius:10px;padding:6px 10px;backdrop-filter:blur(14px);min-width:78px;max-width:126px;text-align:center;transition:border-color .15s}
.poi:active .pob{border-color:var(--c)}
.poi[data-f="1"]{opacity:.9}.poi[data-f="2"]{opacity:.6}.poi[data-f="3"]{opacity:.3}
.pii{font-size:13px;display:block;margin-bottom:1px}
.pin{font-family:'Syne',sans-serif;font-weight:600;font-size:11px;color:var(--tx);line-height:1.25}
.pid{font-family:'Space Mono',monospace;font-size:9px;color:var(--c);margin-top:2px}

/* filters */
#fw{position:fixed;bottom:50px;left:0;right:0;z-index:21;display:flex;flex-direction:column;gap:3px;pointer-events:auto}
.frow{display:flex;gap:5px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;padding:2px 10px}
.frow::-webkit-scrollbar{display:none}
#dfrow{background:linear-gradient(to top,rgba(2,13,26,.8),transparent);padding-bottom:4px}
.pill{flex-shrink:0;font-family:'Space Mono',monospace;font-size:10px;padding:4px 9px;border-radius:20px;border:1px solid rgba(0,229,255,.18);background:rgba(2,13,26,.55);color:var(--mu);cursor:pointer;backdrop-filter:blur(8px);transition:all .15s;white-space:nowrap}
.pill:active{transform:scale(.93)}
.pill.on{border-color:var(--c);background:var(--cd);color:var(--c)}
.cpill.on{border-color:var(--cc,var(--c));background:color-mix(in srgb,var(--cc,var(--c)) 15%,transparent);color:var(--cc,var(--c))}

/* bottom hud */
#hud{position:fixed;bottom:0;left:0;right:0;z-index:20;padding:5px 12px;padding-bottom:max(5px,env(safe-area-inset-bottom));background:rgba(2,13,26,.92);display:flex;align-items:center;gap:8px}
#gpstxt{font-family:'Space Mono',monospace;font-size:9px;color:var(--mu);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;cursor:pointer;display:flex;align-items:center;gap:5px}
.sdot{width:6px;height:6px;border-radius:50%;background:var(--mu);flex-shrink:0}
.sdot.ok{background:var(--gr);box-shadow:0 0 5px var(--gr)}.sdot.err{background:var(--red);box-shadow:0 0 5px var(--red)}.sdot.mn{background:var(--gold);box-shadow:0 0 5px var(--gold)}
#pcnt{font-family:'Space Mono',monospace;font-size:9px;color:var(--mu);white-space:nowrap;flex-shrink:0}
.hbtn{font-family:'Space Mono',monospace;font-size:11px;color:var(--c);background:var(--cd);border:1px solid var(--cb);border-radius:14px;padding:4px 10px;cursor:pointer;flex-shrink:0;transition:background .15s}
.hbtn:active{background:rgba(0,229,255,.3)}
.hbtn.g{color:var(--gold);background:rgba(251,191,36,.12);border-color:rgba(251,191,36,.4)}

/* debug toast */
#dbg{position:fixed;top:90px;left:50%;transform:translateX(-50%);z-index:50;font-family:'Space Mono',monospace;font-size:10px;color:var(--gold);background:rgba(2,13,26,.85);border:1px solid rgba(251,191,36,.4);border-radius:20px;padding:4px 14px;pointer-events:none;display:none;white-space:nowrap;max-width:90vw;overflow:hidden;text-overflow:ellipsis}

/* detail panel */
#det{position:fixed;bottom:50px;left:0;right:0;z-index:30;background:rgba(2,13,26,.97);border-top:1px solid var(--cb);pointer-events:auto;max-height:80vh;display:none;flex-direction:column;backdrop-filter:blur(20px)}
#det.on{display:flex}
#deth{flex-shrink:0;padding:14px 16px 10px;position:relative}
#detx{position:absolute;top:12px;right:12px;background:rgba(0,229,255,.08);border:1px solid var(--cb);color:var(--mu);font-size:12px;cursor:pointer;font-family:'Space Mono',monospace;border-radius:50%;width:26px;height:26px;display:flex;align-items:center;justify-content:center}
#deti{font-size:22px;margin-bottom:3px}
#detn{font-size:19px;font-weight:800;margin-bottom:1px;padding-right:34px}
#dett{font-family:'Space Mono',monospace;font-size:9px;color:var(--c);letter-spacing:.12em;text-transform:uppercase;margin-bottom:10px}
#detm{display:flex;gap:14px;flex-wrap:wrap;margin-bottom:4px}
.dmi{display:flex;flex-direction:column;gap:2px}
.dml{font-family:'Space Mono',monospace;font-size:9px;color:var(--mu);letter-spacing:.08em;text-transform:uppercase}
.dmv{font-family:'Space Mono',monospace;font-size:12px;color:var(--tx);font-weight:700}
/* tab bar */
#dettabs{flex-shrink:0;display:flex;border-top:1px solid rgba(0,229,255,.12);border-bottom:1px solid rgba(0,229,255,.12)}
.dtab{flex:1;padding:10px 6px;font-family:'Syne',sans-serif;font-size:13px;font-weight:700;background:none;border:none;border-bottom:2px solid transparent;color:var(--mu);cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px;transition:color .15s,background .15s}
.dtab.on{color:var(--c);border-bottom-color:var(--c);background:rgba(0,229,255,.05)}
.dtab:active{background:rgba(0,229,255,.08)}
/* tab content */
#detbody{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch}
.dtpanel{display:none;padding:14px 16px 24px}
.dtpanel.on{display:block}
/* info panel */
#infophotos{display:flex;gap:8px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;margin-bottom:12px}
#infophotos::-webkit-scrollbar{display:none}
.infophoto{flex-shrink:0;width:150px;height:100px;object-fit:cover;border-radius:10px;border:1px solid rgba(0,229,255,.15);cursor:pointer}
#infoextract{font-family:'Space Mono',monospace;font-size:10px;color:var(--mu);line-height:1.85;margin-bottom:12px}
#infowikilink{display:none;font-family:'Syne',sans-serif;font-size:12px;font-weight:700;color:var(--c);background:var(--cd);border:1px solid var(--cb);border-radius:9px;padding:7px 12px;cursor:pointer;width:100%;text-align:center;margin-bottom:12px}
#infowikilink.on{display:block}
.nbt{font-family:'Space Mono',monospace;font-size:9px;color:var(--mu);text-transform:uppercase;margin-bottom:6px;margin-top:8px}
.nbi{display:flex;align-items:center;gap:7px;padding:7px 9px;border-radius:8px;background:rgba(0,229,255,.05);border:1px solid rgba(0,229,255,.1);cursor:pointer;margin-bottom:4px;transition:background .15s}
.nbi:active{background:rgba(0,229,255,.12)}
.nbii{font-size:13px;flex-shrink:0}.nbin{font-size:11px;font-weight:600;color:var(--tx);flex:1}.nbit{font-family:'Space Mono',monospace;font-size:9px;color:var(--mu)}
#infoloading{font-family:'Space Mono',monospace;font-size:10px;color:var(--mu);text-align:center;padding:22px 0;display:none}
#infoloading.on{display:block}
#infonotfound{font-family:'Space Mono',monospace;font-size:10px;color:var(--mu);text-align:center;padding:18px 0;display:none}
#infonotfound.on{display:block}
/* itinerary panel */
#itinmode{display:flex;gap:6px;margin-bottom:14px}
.imode{flex:1;font-family:'Syne',sans-serif;font-size:12px;font-weight:700;border-radius:9px;padding:9px 4px;cursor:pointer;border:1px solid rgba(0,229,255,.2);background:rgba(2,13,26,.6);color:var(--mu);transition:all .15s;text-align:center}
.imode.on{border-color:var(--c);background:var(--cd);color:var(--c)}
.imode:active{opacity:.75}
#itininfo{font-family:'Space Mono',monospace;font-size:10px;color:var(--mu);margin-bottom:14px;line-height:1.75;background:rgba(0,229,255,.04);border:1px solid rgba(0,229,255,.1);border-radius:9px;padding:10px 12px}
#itingo{width:100%;font-family:'Syne',sans-serif;font-size:15px;font-weight:800;background:#1a73e8;color:white;border:none;border-radius:12px;padding:13px;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:opacity .15s}
#itingo:active{opacity:.8}

/* map modal */
#mmap{position:fixed;inset:0;z-index:200;background:var(--bg);display:none;flex-direction:column}
#mmap.on{display:flex}
#mmh{padding:12px 14px;display:flex;align-items:center;justify-content:space-between;background:rgba(2,13,26,.95);border-bottom:1px solid var(--cb);flex-shrink:0}
#mmht{font-family:'Syne',sans-serif;font-weight:800;font-size:15px}
#mmhs{font-family:'Space Mono',monospace;font-size:10px;color:var(--mu);margin-top:2px}
#mmcl{font-family:'Space Mono',monospace;font-size:12px;background:none;border:1px solid var(--cb);color:var(--mu);border-radius:8px;padding:5px 10px;cursor:pointer}
#lmap{flex:1;z-index:1}
#mmf{padding:10px 14px;background:rgba(2,13,26,.95);border-top:1px solid var(--cb);display:flex;gap:8px;align-items:center;flex-shrink:0}
#mmc{font-family:'Space Mono',monospace;font-size:10px;color:var(--mu);flex:1}
#mmgps{font-family:'Syne',sans-serif;font-size:12px;font-weight:700;background:rgba(251,191,36,.12);border:1px solid rgba(251,191,36,.4);color:var(--gold);border-radius:10px;padding:8px 12px;cursor:pointer;transition:opacity .15s;white-space:nowrap}
#mmgps:disabled{opacity:.35;cursor:not-allowed}
#mmok{font-family:'Syne',sans-serif;font-size:13px;font-weight:800;background:var(--c);color:var(--bg);border:none;border-radius:10px;padding:10px 18px;cursor:pointer;transition:opacity .15s;white-space:nowrap}
#mmok:disabled{opacity:.35;cursor:not-allowed}
#mmok:not(:disabled):active{opacity:.8}

/* compass calibrate */
#calw{position:fixed;top:136px;left:50%;transform:translateX(-50%);z-index:25;display:none;gap:5px;align-items:center;background:var(--sf);border:1px solid var(--cb);border-radius:20px;padding:5px 10px;backdrop-filter:blur(10px)}
#calw.on{display:flex}
#calw span{font-family:'Space Mono',monospace;font-size:9px;color:var(--mu)}
#calw button{font-family:'Space Mono',monospace;font-size:11px;background:none;border:1px solid var(--cb);border-radius:10px;color:var(--c);padding:3px 7px;cursor:pointer}
#offd{font-family:'Space Mono',monospace;font-size:11px;color:var(--c);min-width:38px;text-align:center}

/* compass warning */
#cwarn{position:fixed;top:106px;left:50%;transform:translateX(-50%);z-index:25;background:rgba(251,191,36,.12);border:1px solid rgba(251,191,36,.45);border-radius:20px;padding:5px 13px;font-family:'Space Mono',monospace;font-size:10px;color:var(--gold);pointer-events:auto;cursor:pointer;display:none}

/* no-sensor banner */
#nosensor{position:fixed;top:108px;left:50%;transform:translateX(-50%);z-index:26;background:rgba(255,77,109,.1);border:1px solid rgba(255,77,109,.4);border-radius:20px;padding:6px 14px;font-family:'Space Mono',monospace;font-size:10px;color:var(--red);pointer-events:none;display:none;white-space:nowrap;text-align:center}
#nosensor.on{display:block}

/* startup */
#startup{position:fixed;inset:0;z-index:100;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;padding:30px;overflow-y:auto}
.slogo{font-family:'Syne',sans-serif;font-size:46px;font-weight:800;line-height:1;text-align:center}
.slogo span{color:var(--c)}
.ssub{font-family:'Space Mono',monospace;font-size:11px;color:var(--mu);letter-spacing:.15em;text-align:center}
.sprm{display:flex;flex-direction:column;gap:7px;width:100%}
.pi{display:flex;align-items:center;gap:10px;background:rgba(0,229,255,.05);border:1px solid var(--cb);border-radius:11px;padding:10px 13px;font-size:13px;color:var(--mu)}
.piic{font-size:19px;flex-shrink:0}
.pis{margin-left:auto;font-family:'Space Mono',monospace;font-size:10px;color:var(--mu)}
.pi.ok{border-color:rgba(34,211,160,.45)}.pi.ok .pis{color:var(--gr)}
.pi.no{border-color:rgba(255,77,109,.45)}.pi.no .pis{color:var(--red)}
#ghelp{display:none;width:100%;background:rgba(255,77,109,.07);border:1px solid rgba(255,77,109,.3);border-radius:11px;padding:13px 14px}
#ghelp.on{display:block}
#ghelp h3{font-size:13px;color:var(--red);margin-bottom:6px}
#ghelp p{font-family:'Space Mono',monospace;font-size:10px;color:var(--mu);line-height:1.9;white-space:pre-line}
#gretrybtn{margin-top:8px;width:100%;background:rgba(255,77,109,.12);border:1px solid rgba(255,77,109,.35);border-radius:9px;padding:8px;font-family:'Syne',sans-serif;font-size:13px;font-weight:700;color:var(--red);cursor:pointer}
#stbtn{width:100%;background:var(--c);color:var(--bg);border:none;border-radius:13px;padding:15px;font-family:'Syne',sans-serif;font-size:16px;font-weight:800;cursor:pointer;letter-spacing:.05em}
#stbtn:disabled{opacity:.4;cursor:not-allowed}
#qbtn{background:none;border:none;font-family:'Space Mono',monospace;font-size:10px;color:var(--mu);cursor:pointer;text-decoration:underline;padding:2px}

/* quit overlay */
#qov{position:fixed;inset:0;z-index:300;background:rgba(2,13,26,.92);backdrop-filter:blur(8px);display:none;flex-direction:column;align-items:center;justify-content:center}
#qov.on{display:flex}
#qbox{background:var(--sf);border:1px solid var(--cb);border-radius:18px;padding:26px 28px;text-align:center;max-width:270px}
#qbox h2{font-size:20px;font-weight:800;margin-bottom:4px}
#qbox p{font-family:'Space Mono',monospace;font-size:10px;color:var(--mu);margin-bottom:18px}
.qbs{display:flex;gap:8px}
.qb{flex:1;border:none;border-radius:11px;padding:11px;font-family:'Syne',sans-serif;font-size:13px;font-weight:800;cursor:pointer}
#qno{background:rgba(0,229,255,.1);border:1px solid var(--cb) !important;color:var(--c)}
#qyes{background:var(--red);color:white}

/* loading */
#ldr{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:25;display:none}
#ldr.on{display:block}
#ldr svg{animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>

<!-- STARTUP -->
<div id="startup">
  <div style="text-align:center">
    <div class="slogo">HORI<span>ZON</span></div>
    <div class="ssub" style="margin-top:5px">CE QUI EST DEVANT VOUS</div>
  </div>
  <div class="sprm">
    <div class="pi" id="pcam"><span class="piic">ğŸ“·</span><span>CamÃ©ra</span><span class="pis">EN ATTENTE</span></div>
    <div class="pi" id="pgps"><span class="piic">ğŸ“</span><span>Localisation GPS</span><span class="pis">EN ATTENTE</span></div>
    <div class="pi" id="pcmp"><span class="piic">ğŸ§­</span><span>Boussole</span><span class="pis">EN ATTENTE</span></div>
  </div>
  <div id="ghelp">
    <h3>âš  Localisation refusÃ©e</h3>
    <p id="ghelpb"></p>
    <button id="gretrybtn" onclick="retryGPS()">â†º RÃ©essayer</button>
  </div>
  <button id="stbtn" onclick="initApp()">DÃ©marrer</button>
  <button id="qbtn" onclick="showQuit()">Quitter l'application</button>
</div>

<!-- CAMERA -->
<video id="cam" autoplay playsinline muted></video>
<div class="vig"></div>

<!-- AR OVERLAY -->
<div id="ar">
  <div class="hl"></div><div class="ch"></div><div class="cv"></div>
  <div id="poic"></div>
</div>

<!-- COMPASS -->
<div id="cbar"><div id="ctrack"><div id="cctr"></div></div></div>
<div id="hdg" onclick="onHdgTap()" title="Tap pour contrÃ´le manuel si pas de boussole">---Â° N<span class="htip">tap âœ</span></div>
<button id="mbtn" onclick="goMenu()">â˜°</button>
<div id="cwarn" onclick="toggleCal()">âš  Boussole non calibrÃ©e Â· tap âœ•</div>
<div id="nosensor">âš  Boussole non dÃ©tectÃ©e Â· contrÃ´le manuel activÃ©</div>

<!-- Manual heading controls (shown when no sensor) -->
<div id="hmanual">
  <button onclick="rotH(-45)">âˆ’45Â°</button>
  <button onclick="rotH(-15)">âˆ’15Â°</button>
  <button onclick="rotH(-5)">âˆ’5Â°</button>
  <span id="hmanval">0Â°</span>
  <button onclick="rotH(+5)">+5Â°</button>
  <button onclick="rotH(+15)">+15Â°</button>
  <button onclick="rotH(+45)">+45Â°</button>
</div>

<!-- Compass offset calibration -->
<div id="calw">
  <span>Offset:</span>
  <button onclick="chOff(-10)">âˆ’10Â°</button>
  <button onclick="chOff(-5)">âˆ’5Â°</button>
  <span id="offd">0Â°</span>
  <button onclick="chOff(+5)">+5Â°</button>
  <button onclick="chOff(+10)">+10Â°</button>
  <button onclick="toggleCal()">âœ•</button>
</div>

<!-- FILTERS -->
<div id="fw">
  <div class="frow" id="cfrow"></div>
  <div class="frow" id="dfrow"></div>
</div>

<!-- HUD -->
<div id="hud">
  <div id="gpstxt" onclick="openMap()">
    <span class="sdot" id="sdot"></span>
    <span id="gtxt">GPS inactif â€” tap pour position manuelle</span>
  </div>
  <div id="pcnt">â€”</div>
  <button class="hbtn g" onclick="openMap()">ğŸ“</button>
  <button class="hbtn" id="diagbtn" onclick="toggleDiag()" title="Diagnostic">ğŸ”</button>
  <button class="hbtn" onclick="doRefresh()">â†»</button>
</div>

<!-- DEBUG TOAST -->
<div id="dbg"></div>

<!-- DIAGNOSTIC OVERLAY -->
<div id="diag">
  <div id="dg1">CAP : â€”</div>
  <div id="dg2">SRC : â€”</div>
  <div id="dg3">GPS : â€”</div>
  <div id="dg4">POIs : â€”</div>
</div>

<!-- LOADING -->
<div id="ldr"><svg width="36" height="36" viewBox="0 0 36 36">
  <circle cx="18" cy="18" r="14" fill="none" stroke="rgba(0,229,255,.12)" stroke-width="3"/>
  <circle cx="18" cy="18" r="14" fill="none" stroke="#00e5ff" stroke-width="3" stroke-dasharray="20 68" stroke-linecap="round"/>
</svg></div>

<!-- DETAIL PANEL -->
<div id="det">
  <!-- Header -->
  <div id="deth">
    <button id="detx" onclick="closeDet()">âœ•</button>
    <div id="deti">ğŸ“</div>
    <div id="detn">â€”</div>
    <div id="dett">â€”</div>
    <div id="detm">
      <div class="dmi"><span class="dml">Distance</span><span class="dmv" id="dmd">â€”</span></div>
      <div class="dmi"><span class="dml">Direction</span><span class="dmv" id="dmb">â€”</span></div>
      <div class="dmi"><span class="dml">Coords</span><span class="dmv" id="dmxy">â€”</span></div>
    </div>
  </div>
  <!-- Tabs -->
  <div id="dettabs">
    <button class="dtab on" id="tabinfo" onclick="switchTab('info')">â„¹ï¸ Informations</button>
    <button class="dtab" id="tabitin" onclick="switchTab('itin')">ğŸš¶ ItinÃ©raire</button>
  </div>
  <!-- Body -->
  <div id="detbody">
    <!-- Info tab -->
    <div class="dtpanel on" id="panelinfo">
      <div id="infoloading">â³ Chargementâ€¦</div>
      <div id="infonotfound">Aucune information trouvÃ©e sur Wikipedia.</div>
      <div id="infophotos"></div>
      <div id="infoextract"></div>
      <button id="infowikilink" onclick="openWiki()">ğŸ“– Lire sur WikipÃ©dia</button>
      <div id="infonbl"></div>
    </div>
    <!-- Itinerary tab -->
    <div class="dtpanel" id="panelihtin">
      <div id="itinmode">
        <button class="imode on" data-mode="walking" onclick="selMode(this)">ğŸš¶ Ã€ pied</button>
        <button class="imode" data-mode="bicycling" onclick="selMode(this)">ğŸš² VÃ©lo</button>
        <button class="imode" data-mode="driving" onclick="selMode(this)">ğŸš— Voiture</button>
        <button class="imode" data-mode="transit" onclick="selMode(this)">ğŸšŒ Transport</button>
      </div>
      <div id="itininfo">Calcul du trajet depuis ta positionâ€¦</div>
      <button id="itingo" onclick="goItinerary()">
        <span id="itingoico">ğŸš¶</span> Ouvrir dans Google Maps
      </button>
    </div>
  </div>
</div>

<!-- MAP MODAL -->
<div id="mmap">
  <div id="mmh">
    <div>
      <div id="mmht">ğŸ“ Choisir ma position</div>
      <div id="mmhs">Tap sur la carte Â· dÃ©place le marqueur Â· confirme</div>
    </div>
    <button id="mmcl" onclick="closeMap()">âœ• Annuler</button>
  </div>
  <div id="lmap"></div>
  <div id="mmf">
    <div id="mmc">Tap sur la carteâ€¦</div>
    <button id="mmgps" onclick="useGPSPos()" disabled>ğŸ“¡ GPS</button>
    <button id="mmok" onclick="confirmPos()" disabled>Confirmer</button>
  </div>
</div>

<!-- QUIT -->
<div id="qov">
  <div id="qbox">
    <h2>Quitter ?</h2>
    <p>L'app sera fermÃ©e.</p>
    <div class="qbs">
      <button class="qb" id="qno" onclick="hideQuit()">Annuler</button>
      <button class="qb" id="qyes" onclick="quitApp()">Quitter</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DISTS = [
  {l:'500m', v:500},  {l:'1km',  v:1000},
  {l:'2km',  v:2000}, {l:'5km',  v:5000},
  {l:'10km', v:10000},{l:'25km', v:25000},
  {l:'50km', v:50000},
];
const CATS = [
  {id:'all',  lb:'ğŸŒ Tout',       cc:'#00e5ff'},
  {id:'city', lb:'ğŸ™ Villes',      cc:'#a78bfa'},
  {id:'coast',lb:'ğŸ—º CÃ´tes',       cc:'#38bdf8'},
  {id:'isle', lb:'ğŸ Ãles',        cc:'#34d399'},
  {id:'mount',lb:'â›° Montagnes',   cc:'#fb923c'},
  {id:'wood', lb:'ğŸŒ² ForÃªts',      cc:'#4ade80'},
  {id:'lh',   lb:'ğŸ—¼ Phares',      cc:'#fbbf24'},
  {id:'site', lb:'ğŸ“Œ Lieux-dits',  cc:'#f472b6'},
];
const FOV = 62, FOV2 = FOV/2; // ~62Â° = FOV horizontal rÃ©el smartphone
const ALPHA = 0.06; // lissage boussole â€” plus bas = plus doux

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S = {
  lat:null, lng:null,
  hRaw:null, hSm:null, hOff:0,
  hManual:0,           // heading used when no sensor
  cSrc:null,           // 'abs' | 'ios' | 'rel' | 'manual'
  sensorOk:false,      // true once we receive a real sensor event
  gpsOk:false, gpsMan:false,
  allPOIs:[], pois:[],
  fetchLat:null, fetchLng:null,
  maxD:50000, band:false,
  cat:'all',
  detPOI:null,
  diagOn:false,
};
let lmap=null, lmk=null, pLat=null, pLng=null;
let cRelTimer=null;
let sensorWatchdog=null;
const poiEls=new Map();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initApp(){
  const btn=document.getElementById('stbtn');
  btn.disabled=true; btn.textContent='DÃ©marrageâ€¦';

  const st=document.getElementById('startup');
  st.style.transition='opacity .4s';
  st.style.opacity='0';
  setTimeout(()=>st.style.display='none', 400);

  buildFilters();
  renderLoop();

  // Camera
  if(navigator.mediaDevices?.getUserMedia){
    navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}},audio:false})
      .then(s=>{document.getElementById('cam').srcObject=s; setPerm('cam','ok');})
      .catch(()=>setPerm('cam','no'));
  } else setPerm('cam','no');

  // GPS
  if(!navigator.geolocation){ setPerm('gps','no'); showGPSHelp('ns'); }
  else { setPerm('gps','wait'); startGPS(); }

  // Compass
  initCompass();

  // Fallback: if GPS is already OK but POIs haven't loaded yet, force fetch
  setTimeout(()=>{
    if(S.gpsOk && S.allPOIs.length===0){
      showDbg('â†º Chargement POIs retardÃ©â€¦');
      fetchPOIs();
    }
  }, 4000);

  // Sensor watchdog: if no compass event after 6s, switch to manual mode
  sensorWatchdog = setTimeout(()=>{
    if(!S.sensorOk){
      activateManualHeading();
    }
  }, 6000);
}

function setPerm(id,s){
  const idMap={cam:'pcam',gps:'pgps',cmp:'pcmp'};
  const el=document.getElementById(idMap[id]);
  if(!el)return;
  el.classList.remove('ok','no');
  const st=el.querySelector('.pis');
  if(s==='ok'){el.classList.add('ok');st.textContent='OK';}
  else if(s==='no'){el.classList.add('no');st.textContent='REFUSÃ‰';}
  else st.textContent='EN ATTENTEâ€¦';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function startGPS(){
  if(navigator.permissions){
    try{
      const p=await navigator.permissions.query({name:'geolocation'});
      if(p.state==='denied'){setPerm('gps','no');showGPSHelp(1);setDot('err');gtxt('GPS refusÃ© Â· ğŸ“ position manuelle');return;}
    }catch(e){}
  }
  navigator.geolocation.getCurrentPosition(
    pos=>{
      onGPS(pos);
      setPerm('gps','ok');
      document.getElementById('ghelp').classList.remove('on');
      navigator.geolocation.watchPosition(onGPS,onGPSErr,{enableHighAccuracy:true,maximumAge:5000,timeout:20000});
    },
    err=>{
      setPerm('gps','no');
      showGPSHelp(err.code);
      setDot('err');
      gtxt(gpsmsg(err.code)+' Â· ğŸ“ tap');
    },
    {enableHighAccuracy:true,timeout:20000,maximumAge:0}
  );
}
function retryGPS(){document.getElementById('ghelp').classList.remove('on');setPerm('gps','wait');startGPS();}
function onGPS(pos){
  if(S.gpsMan)return;
  S.lat=pos.coords.latitude; S.lng=pos.coords.longitude; S.gpsOk=true;
  setDot('ok');
  const acc=Math.round(pos.coords.accuracy);
  gtxt(`${S.lat.toFixed(5)}, ${S.lng.toFixed(5)} Â±${acc}m`);
  document.getElementById('mmgps').disabled=false;
  const moved=S.fetchLat!=null ? hav(S.lat,S.lng,S.fetchLat,S.fetchLng) : Infinity;
  if(moved>150) fetchPOIs();
}
function onGPSErr(e){setDot('err');gtxt(gpsmsg(e.code));}
function gpsmsg(c){return{1:'GPS refusÃ©',2:'GPS indisponible',3:'DÃ©lai GPS'}[c]||'Erreur GPS';}
function setDot(s){const d=document.getElementById('sdot');d.classList.remove('ok','err','mn');d.classList.add(s);}
function gtxt(t){document.getElementById('gtxt').textContent=t;}

function showGPSHelp(c){
  const isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent);
  const isAnd=/Android/.test(navigator.userAgent);
  let m='';
  if(c===1||c==='denied'){
    if(isIOS) m='1. RÃ©glages â†’ ConfidentialitÃ© & SÃ©curitÃ©\n   â†’ Service de localisation â†’ Safari\n   â†’ Â« Lors de l\'utilisation Â»\n2. Reviens ici â†’ RÃ©essayer\n\nOu utilise la position manuelle ğŸ“';
    else if(isAnd) m='1. Tap sur ğŸ”’ dans la barre d\'adresse\n2. Autorisations â†’ Localisation â†’ Autoriser\n3. RÃ©essayer\n\nOu utilise la position manuelle ğŸ“';
    else m='Autorise la gÃ©olocalisation dans les\nparamÃ¨tres du navigateur, puis RÃ©essayer.\nOu utilise la position manuelle ğŸ“';
  } else if(c===2) m='GPS indisponible. VÃ©rifie que la\nlocalisation est activÃ©e sur l\'appareil.\nOu utilise la position manuelle ğŸ“';
  else if(c===3) m='DÃ©lai GPS dÃ©passÃ©. Va en extÃ©rieur\nsi possible, puis RÃ©essayer.\nOu utilise la position manuelle ğŸ“';
  else m='GPS non supportÃ©. Utilise la position manuelle ğŸ“';
  document.getElementById('ghelpb').textContent=m;
  document.getElementById('ghelp').classList.add('on');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMPASS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initCompass(){
  if(typeof DeviceOrientationEvent!=='undefined' &&
     typeof DeviceOrientationEvent.requestPermission==='function'){
    // iOS 13+ â€” must be triggered by user gesture (already done via initApp button)
    DeviceOrientationEvent.requestPermission()
      .then(p=>{
        if(p==='granted'){
          window.addEventListener('deviceorientationabsolute',onOriAbs,true);
          window.addEventListener('deviceorientation',onOri,true);
          setPerm('cmp','ok');
        } else {
          setPerm('cmp','no');
          showDbg('âš  Boussole refusÃ©e (iOS) â€” mode manuel dans 6s', 5000);
        }
      }).catch(()=>{
        setPerm('cmp','no');
      });
  } else {
    window.addEventListener('deviceorientationabsolute',onOriAbs,true);
    window.addEventListener('deviceorientation',onOri,true);
    setPerm('cmp','ok');
  }
}

function markSensorOk(){
  if(S.sensorOk) return;
  S.sensorOk = true;
  if(sensorWatchdog){ clearTimeout(sensorWatchdog); sensorWatchdog=null; }
  // Hide manual heading controls if sensor kicks in later
  document.getElementById('nosensor').classList.remove('on');
  document.getElementById('hmanual').classList.remove('on');
}

function onOriAbs(e){
  if(e.alpha==null)return;
  markSensorOk();
  updRaw((360-e.alpha+360)%360);
  S.cSrc='abs'; hideCWarn();
}
function onOri(e){
  if(S.cSrc==='abs'){hideCWarn();return;}
  if(e.webkitCompassHeading!=null){
    markSensorOk();
    updRaw(e.webkitCompassHeading); S.cSrc='ios'; hideCWarn(); return;
  }
  if(e.alpha!=null){
    markSensorOk();
    updRaw((360-e.alpha+360)%360);
    if(S.cSrc!=='rel'){
      S.cSrc='rel';
      if(!cRelTimer) cRelTimer=setTimeout(()=>{
        if(S.cSrc==='rel') document.getElementById('cwarn').style.display='block';
      },3000);
    }
  }
}
function updRaw(r){
  S.hRaw=r;
  if(S.hSm==null){S.hSm=r;return;}
  let d=r-S.hSm;
  if(d>180)d-=360; if(d<-180)d+=360;
  S.hSm=(S.hSm+ALPHA*d+360)%360;
}

/**
 * Returns the effective heading to use for AR rendering.
 * Priority: sensor > manual
 */
function getH(){
  if(S.hSm!=null) return (S.hSm+S.hOff+360)%360;
  if(S.cSrc==='manual') return (S.hManual+360)%360;
  return null;
}

function hideCWarn(){
  if(cRelTimer){clearTimeout(cRelTimer);cRelTimer=null;}
  document.getElementById('cwarn').style.display='none';
  document.getElementById('calw').classList.remove('on');
}
function toggleCal(){document.getElementById('calw').classList.toggle('on');}
function chOff(d){
  S.hOff=(S.hOff+d+360)%360;
  if(S.hOff>180)S.hOff-=360;
  document.getElementById('offd').textContent=(S.hOff>=0?'+':'')+S.hOff+'Â°';
}

// Manual heading (no sensor fallback)
function activateManualHeading(){
  if(S.sensorOk) return; // sensor already working, skip
  S.cSrc='manual';
  S.hManual=0;
  document.getElementById('nosensor').classList.add('on');
  document.getElementById('hmanual').classList.add('on');
  showDbg('âš  Boussole absente â€” utilise les boutons pour orienter', 6000);
  setPerm('cmp','no');
}
function rotH(deg){
  S.hManual=(S.hManual+deg+360)%360;
  document.getElementById('hmanval').textContent=Math.round(S.hManual)+'Â°';
}
function onHdgTap(){
  // If no sensor: toggle manual panel
  if(!S.sensorOk || S.cSrc==='manual'){
    document.getElementById('hmanual').classList.toggle('on');
  } else {
    // Sensor available: open calibration panel
    toggleCal();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILTERS BUILD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildFilters(){
  const cr=document.getElementById('cfrow'); cr.innerHTML='';
  CATS.forEach(c=>{
    const b=document.createElement('button');
    b.className='pill cpill'+(c.id===S.cat?' on':'');
    b.textContent=c.lb; b.style.setProperty('--cc',c.cc);
    b.onclick=()=>selCat(c.id);
    cr.appendChild(b);
  });
  const dr=document.getElementById('dfrow'); dr.innerHTML='';
  const bt=document.createElement('button');
  bt.className='pill'+(S.band?' on':'');
  bt.id='btoggle'; bt.textContent=S.band?'ğŸ“ Bande ON':'ğŸ“ Bande OFF';
  bt.title='Active la fourchette Â±10% autour de la distance';
  bt.onclick=()=>{S.band=!S.band;bt.classList.toggle('on',S.band);bt.textContent=S.band?'ğŸ“ Bande ON':'ğŸ“ Bande OFF';applyFilter();};
  dr.appendChild(bt);
  DISTS.forEach(d=>{
    const b=document.createElement('button');
    b.className='pill'+(d.v===S.maxD?' on':'');
    b.textContent=d.l;
    b.onclick=()=>{
      S.maxD=d.v;
      document.querySelectorAll('#dfrow .pill:not(#btoggle)').forEach((x,i)=>x.classList.toggle('on',DISTS[i].v===d.v));
      applyFilter();
    };
    dr.appendChild(b);
  });
}

function selCat(id){
  S.cat=id;
  document.querySelectorAll('.cpill').forEach((b,i)=>b.classList.toggle('on',CATS[i].id===id));
  applyFilter();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILTER LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Max POIs per category when showing "Tout" â€” Ã©vite que forÃªts/Ã®les noient le reste
const CAP_PER_CAT = { wood:12, isle:12, city:60, coast:20, mount:15, lh:10, site:20, all:15 };
const TOTAL_CAP = 100;

function applyFilter(){
  let dMin=0, dMax=S.maxD;
  if(S.band && S.maxD>2000){ dMin=S.maxD*0.9; dMax=S.maxD*1.1; }

  const filtered=S.allPOIs.filter(p=>{
    if(p.dist<dMin||p.dist>dMax)return false;
    return S.cat==='all'||p.type.cat===S.cat;
  });

  let result;
  if(S.cat==='all'){
    // Enforce per-category cap to guarantee diversity
    const counts={};
    result=[];
    for(const p of filtered){
      const c=p.type.cat;
      const cap=CAP_PER_CAT[c]??12;
      counts[c]=(counts[c]||0);
      if(counts[c]<cap){ counts[c]++; result.push(p); }
    }
  } else {
    result=filtered;
  }

  S.pois=result.slice(0,TOTAL_CAP);
  poiEls.forEach(e=>e.remove()); poiEls.clear();
  const rng=S.band&&S.maxD>2000?`${fmt(dMin)}â€“${fmt(dMax)}`:`0â€“${fmt(dMax)}`;
  document.getElementById('pcnt').textContent=`${S.pois.length} pts Â· ${rng}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FETCH POIs
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function fetchPOIs(){
  if(!S.lat)return;
  showDbg('ğŸ” Recherche POIsâ€¦');
  document.getElementById('ldr').classList.add('on');
  const lat=S.lat, lng=S.lng, r=50000;

  const q1=`[out:json][timeout:20];(
node["place"~"^(city|town|village|hamlet|suburb|locality|isolated_dwelling)$"](around:${r},${lat},${lng});
node["natural"~"^(peak|volcano|cape|bay|strait|cliff|peninsula|headland)$"]["name"](around:${r},${lat},${lng});
node["man_made"="lighthouse"]["name"](around:${r},${lat},${lng});
node["place"~"^(island|islet)$"]["name"](around:${r},${lat},${lng});
);out ${r<=10000?200:400};`;

  const q2=`[out:json][timeout:25];(
way["natural"~"^(wood|peak|cape|peninsula|headland)$"]["name"](around:${r},${lat},${lng});
way["landuse"="forest"]["name"](around:${r},${lat},${lng});
way["place"~"^(island|islet)$"]["name"](around:${r},${lat},${lng});
relation["natural"~"^(wood|peak)$"]["name"](around:${r},${lat},${lng});
relation["place"~"^(island|islet)$"]["name"](around:${r},${lat},${lng});
relation["landuse"="forest"]["name"](around:${r},${lat},${lng});
);out center 200;`;

  try{
    const [r1,r2]=await Promise.allSettled([
      fetch('https://overpass-api.de/api/interpreter',{method:'POST',body:q1}).then(r=>r.json()),
      fetch('https://overpass-api.de/api/interpreter',{method:'POST',body:q2}).then(r=>r.json()),
    ]);
    const els1=r1.status==='fulfilled'?r1.value.elements:[];
    const els2=r2.status==='fulfilled'?r2.value.elements:[];
    showDbg(`âœ“ ${els1.length+els2.length} Ã©lÃ©ments reÃ§us`);
    processPOIs([...els1,...els2],lat,lng);
    S.fetchLat=lat; S.fetchLng=lng;
  }catch(e){
    showDbg('âŒ Erreur rÃ©seau Overpass');
    console.error(e);
  }finally{
    document.getElementById('ldr').classList.remove('on');
  }
}

function processPOIs(els,ulat,ulng){
  const seen=new Set(), res=[];
  for(const el of els){
    const eLat=el.lat??el.center?.lat;
    const eLng=el.lon??el.center?.lon;
    if(!eLat||!eLng)continue;
    const name=el.tags?.name||el.tags?.['name:fr'];
    if(!name)continue;
    const key=name.toLowerCase().trim();
    if(seen.has(key))continue;
    seen.add(key);
    const dist=hav(ulat,ulng,eLat,eLng);
    if(dist<30)continue;
    res.push({name,lat:eLat,lng:eLng,dist,bearing:brg(ulat,ulng,eLat,eLng),type:classify(el.tags,name)});
  }
  res.sort((a,b)=>a.dist-b.dist);

  // Spatial dedup: distance minimale entre deux POIs de mÃªme catÃ©gorie
  // Les villes/villages peuvent Ãªtre trÃ¨s proches â†’ seuil bas
  const SPATIAL_BY_CAT = { wood:600, isle:250, coast:500, mount:800, lh:400, site:150, city:200, all:150 };
  const kept=[], spatialKeys=[];
  for(const p of res){
    const minD = SPATIAL_BY_CAT[p.type.cat] ?? 150;
    const tooClose=spatialKeys.some(k=>k.cat===p.type.cat && hav(p.lat,p.lng,k.lat,k.lng)<minD);
    if(!tooClose){
      kept.push(p);
      spatialKeys.push({cat:p.type.cat,lat:p.lat,lng:p.lng});
    }
  }

  S.allPOIs=kept;
  showDbg(`âœ“ ${kept.length} POIs (${res.length} bruts)`);
  applyFilter();
}

function classify(t,name){
  if(!t)return{emoji:'ğŸ“',label:'Lieu',cat:'all'};
  const p=t.place,n=t.natural,m=t.man_made,lu=t.landuse;
  const nm=(name||'').toLowerCase();
  if(n==='wood'||lu==='forest')return{emoji:'ğŸŒ²',label:'ForÃªt',cat:'wood'};
  if(m==='lighthouse')return{emoji:'ğŸ—¼',label:'Phare',cat:'lh'};
  if(p==='island'||p==='islet')return{emoji:'ğŸï¸',label:'Ãle',cat:'isle'};
  if(n==='peak'||n==='volcano')return{emoji:'â›°ï¸',label:'Sommet',cat:'mount'};
  if(n==='cape'||n==='peninsula'||n==='headland'||
     nm.startsWith('pointe')||nm.startsWith('cap ')||nm.startsWith('cap-')||
     nm.includes("presqu'Ã®le")||nm.includes('tas de'))
    return{emoji:'ğŸ—ºï¸',label:'Cap / Pointe',cat:'coast'};
  if(n==='bay')return{emoji:'ğŸŒŠ',label:'Baie',cat:'coast'};
  if(n==='strait')return{emoji:'ã€°ï¸',label:'DÃ©troit',cat:'coast'};
  if(n==='cliff')return{emoji:'ğŸª¨',label:'Falaise',cat:'coast'};
  if(p==='city')return{emoji:'ğŸ™ï¸',label:'Ville',cat:'city'};
  if(p==='town')return{emoji:'ğŸ˜ï¸',label:'Bourg',cat:'city'};
  if(p==='village'||p==='hamlet'||p==='suburb')return{emoji:'ğŸ¡',label:'Village',cat:'city'};
  if(p==='locality'||p==='isolated_dwelling')return{emoji:'ğŸ“Œ',label:'Lieu-dit',cat:'site'};
  return{emoji:'ğŸ“',label:'Lieu',cat:'all'};
}

function doRefresh(){S.fetchLat=null;if(S.gpsOk)fetchPOIs();}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAP MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openMap(){
  document.getElementById('mmap').classList.add('on');
  document.getElementById('mmgps').disabled=!S.gpsOk;
  setTimeout(()=>{
    if(!lmap){
      const initLat=S.lat||48.0, initLng=S.lng||-2.0;
      lmap=L.map('lmap',{zoomControl:true}).setView([initLat,initLng],S.gpsOk?12:6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
        attribution:'Â© OpenStreetMap',maxZoom:19
      }).addTo(lmap);
      lmap.on('click',e=>{
        pLat=e.latlng.lat; pLng=e.latlng.lng;
        setMapMarker(pLat,pLng);
        document.getElementById('mmok').disabled=false;
      });
    } else {
      lmap.invalidateSize();
    }
    if(S.lat&&!lmk){
      setMapMarker(S.lat,S.lng);
      pLat=S.lat; pLng=S.lng;
      document.getElementById('mmok').disabled=false;
    }
  },120);
}

function setMapMarker(lat,lng){
  if(lmk){lmk.setLatLng([lat,lng]);}
  else{
    lmk=L.marker([lat,lng],{draggable:true}).addTo(lmap);
    lmk.on('dragend',e=>{
      const ll=e.target.getLatLng();
      pLat=ll.lat; pLng=ll.lng;
      document.getElementById('mmc').textContent=`${pLat.toFixed(5)}, ${pLng.toFixed(5)}`;
    });
  }
  document.getElementById('mmc').textContent=`${lat.toFixed(5)}, ${lng.toFixed(5)}`;
  if(lmap) lmap.setView([lat,lng],Math.max(lmap.getZoom(),10));
}

function useGPSPos(){
  if(!S.lat)return;
  pLat=S.lat; pLng=S.lng;
  setMapMarker(pLat,pLng);
  document.getElementById('mmok').disabled=false;
}
function closeMap(){document.getElementById('mmap').classList.remove('on');}
function confirmPos(){
  if(pLat==null)return;
  S.lat=pLat; S.lng=pLng; S.gpsOk=true; S.gpsMan=true;
  setDot('mn');
  gtxt(`ğŸ“ Manuel : ${S.lat.toFixed(4)}, ${S.lng.toFixed(4)}`);
  closeMap();
  S.allPOIs.forEach(p=>{
    p.dist=hav(S.lat,S.lng,p.lat,p.lng);
    p.bearing=brg(S.lat,S.lng,p.lat,p.lng);
  });
  S.allPOIs.sort((a,b)=>a.dist-b.dist);
  S.fetchLat=null;
  fetchPOIs();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DIAGNOSTIC OVERLAY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleDiag(){
  S.diagOn=!S.diagOn;
  document.getElementById('diag').classList.toggle('on',S.diagOn);
  document.getElementById('diagbtn').style.borderColor=S.diagOn?'var(--c)':'';
}

function updateDiag(h){
  if(!S.diagOn)return;
  const d1=document.getElementById('dg1');
  const d2=document.getElementById('dg2');
  const d3=document.getElementById('dg3');
  const d4=document.getElementById('dg4');

  // Heading
  if(h!==null){
    d1.textContent=`CAP : ${Math.round(h)}Â° ${card(h)}`;
    d1.className='dgok';
  } else {
    d1.textContent='CAP : PAS DE BOUSSOLE';
    d1.className='dgerr';
  }

  // Source
  const srcMap={abs:'absolute âœ“',ios:'iOS webkit âœ“',rel:'relatif âš ',manual:'MANUEL',null:'â€” aucune'};
  const srcColor={abs:'dgok',ios:'dgok',rel:'dgwarn',manual:'dgwarn',null:'dgerr'};
  d2.textContent=`SRC : ${srcMap[S.cSrc]||'â€”'}`;
  d2.className=srcColor[S.cSrc]||'dgerr';

  // GPS
  if(S.gpsOk){
    d3.textContent=`GPS : ${S.lat?.toFixed(4)}, ${S.lng?.toFixed(4)}${S.gpsMan?' (manuel)':''}`;
    d3.className=S.gpsMan?'dgwarn':'dgok';
  } else {
    d3.textContent='GPS : INACTIF';
    d3.className='dgerr';
  }

  // POIs
  d4.textContent=`POIs : ${S.pois.length} affichÃ©s / ${S.allPOIs.length} chargÃ©s`;
  d4.className=S.allPOIs.length>0?'dgok':'dgerr';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CPS=[
  {d:0,l:'N'},{d:22.5,l:'NNE'},{d:45,l:'NE'},{d:67.5,l:'ENE'},
  {d:90,l:'E'},{d:112.5,l:'ESE'},{d:135,l:'SE'},{d:157.5,l:'SSE'},
  {d:180,l:'S'},{d:202.5,l:'SSO'},{d:225,l:'SO'},{d:247.5,l:'OSO'},
  {d:270,l:'O'},{d:292.5,l:'ONO'},{d:315,l:'NO'},{d:337.5,l:'NNO'},
];
let cpBuilt=false;
const TOPS=[28,35,42,22,48];

function renderLoop(){
  const h=getH();

  // Always update diagnostic
  updateDiag(h);

  if(!cpBuilt){
    const tr=document.getElementById('ctrack');
    CPS.forEach(p=>{
      const e=document.createElement('div');
      e.className='clbl'+([0,90,180,270].includes(p.d)?' card':'');
      e.textContent=p.l; e.dataset.d=p.d;
      tr.appendChild(e);
    });
    cpBuilt=true;
  }

  if(h!==null){
    const W=document.getElementById('ctrack').offsetWidth;
    document.querySelectorAll('.clbl').forEach(e=>{
      const df=ndeg(parseFloat(e.dataset.d)-h);
      const x=W/2+df/FOV*W;
      if(x<-40||x>W+40){e.style.display='none';return;}
      e.style.display=''; e.style.left=x+'px';
      e.style.opacity=Math.max(0,1-Math.abs(df)/FOV2*.8);
    });
    const hi=Math.round(h);
    document.getElementById('hdg').childNodes[0].textContent=`${hi.toString().padStart(3,'0')}Â° ${card(hi)}`;

    // Only render POIs if GPS is available
    if(S.gpsOk){
      updPOIs(h);
    }
  } else {
    // No heading yet â€” still render POIs if we have GPS
    // (they will appear centred without azimuth filtering)
    // Uncomment below if you want static POI list visible without compass:
    // if(S.gpsOk) updPOIsStatic();
  }

  requestAnimationFrame(renderLoop);
}

// HystÃ©rÃ©sis : zone d'entrÃ©e plus large que zone de sortie
// â†’ un POI apparaÃ®t Ã  FOV2*1.3, ne disparaÃ®t qu'Ã  FOV2*1.6
const ENTER_THRESHOLD = FOV2 * 1.3;
const EXIT_THRESHOLD  = FOV2 * 1.6;

function updPOIs(h){
  const W = window.innerWidth;

  // Calcul des angles pour tous les POIs visibles
  const angles = new Map();
  for(const p of S.pois){
    const df = ndeg(p.bearing - h);
    angles.set(p.name, df);
  }

  // Suppression avec hystÃ©rÃ©sis : on ne retire un Ã©lÃ©ment
  // que s'il est VRAIMENT sorti (EXIT_THRESHOLD), pas juste hors FOV
  for(const [n, e] of poiEls){
    const df = angles.get(n);
    if(df === undefined || Math.abs(df) > EXIT_THRESHOLD){
      e.remove();
      poiEls.delete(n);
    }
  }

  // Ajout et mise Ã  jour â€” on n'ajoute que si dans ENTER_THRESHOLD
  for(const p of S.pois){
    const df = angles.get(p.name);
    if(df === undefined) continue;
    const absdf = Math.abs(df);

    // N'ajoute un nouveau POI que s'il est dans la zone d'entrÃ©e
    if(!poiEls.has(p.name)){
      if(absdf > ENTER_THRESHOLD) continue;
      const e = buildPOI(p);
      document.getElementById('poic').appendChild(e);
      poiEls.set(p.name, e);
    }

    const e = poiEls.get(p.name);

    // Position X avec transition CSS pour fluiditÃ©
    const x = W/2 + (df/FOV2)*(W/2);
    e.style.left = x + 'px';

    // OpacitÃ© : fade progressif vers les bords
    e.dataset.f = absdf > FOV2*.75 ? 3 : absdf > FOV2*.45 ? 2 : 1;

    // Hauteur connecteur
    const ch = Math.max(18, Math.round(55*(1-Math.min(p.dist/S.maxD,1))));
    e.querySelector('.poc').style.height = ch + 'px';
  }
}

function buildPOI(p){
  const e=document.createElement('div');
  e.className='poi';
  const hash=p.name.split('').reduce((a,c)=>a+c.charCodeAt(0),0);
  e.style.top=TOPS[hash%TOPS.length]+'%';
  e.innerHTML=`<div class="poc" style="height:40px"></div>
<div class="pob">
  <span class="pii">${p.type.emoji}</span>
  <div class="pin">${p.name}</div>
  <div class="pid">${fmt(p.dist)}</div>
</div>`;
  e.addEventListener('click',()=>openDet(p));
  return e;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DETAIL PANEL â€” tabs: Informations / ItinÃ©raire
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let itinMode = 'walking';
let wikiPageTitle = null;

const ITIN_ICONS = {walking:'ğŸš¶',bicycling:'ğŸš²',driving:'ğŸš—',transit:'ğŸšŒ'};
const ITIN_LABELS = {walking:'Ã€ pied',bicycling:'Ã€ vÃ©lo',driving:'En voiture',transit:'En transport'};
const ITIN_TIMES = {walking:5,bicycling:15,driving:80};  // km/h approx

function openDet(p){
  S.detPOI = p;
  document.getElementById('deti').textContent = p.type.emoji;
  document.getElementById('detn').textContent = p.name;
  document.getElementById('dett').textContent = p.type.label.toUpperCase();
  document.getElementById('dmd').textContent = fmt(p.dist);
  document.getElementById('dmb').textContent = Math.round(p.bearing)+'Â° '+card(p.bearing);
  document.getElementById('dmxy').textContent = p.lat.toFixed(4)+', '+p.lng.toFixed(4);
  // Reset tabs to Info
  switchTab('info');
  document.getElementById('det').classList.add('on');
  // Load info immediately
  loadWikiInfo(p);
  updateItinInfo();
}

function closeDet(){
  document.getElementById('det').classList.remove('on');
}

function switchTab(tab){
  document.getElementById('tabinfo').classList.toggle('on', tab==='info');
  document.getElementById('tabitin').classList.toggle('on', tab==='itin');
  document.getElementById('panelinfo').classList.toggle('on', tab==='info');
  document.getElementById('panelihtin').classList.toggle('on', tab==='itin');
}

// â”€â”€ ITINERARY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function selMode(btn){
  document.querySelectorAll('.imode').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  itinMode = btn.dataset.mode;
  document.getElementById('itingoico').textContent = ITIN_ICONS[itinMode];
  updateItinInfo();
}

function updateItinInfo(){
  const p = S.detPOI; if(!p) return;
  const distKm = (p.dist/1000);
  let timeStr = 'â€”';
  if(itinMode in ITIN_TIMES){
    const mins = Math.round(distKm / ITIN_TIMES[itinMode] * 60);
    timeStr = mins < 60 ? `~${mins} min` : `~${Math.round(mins/60*10)/10} h`;
  } else {
    timeStr = 'variable selon les horaires';
  }
  document.getElementById('itininfo').innerHTML =
    `<b style="color:var(--tx)">${ITIN_ICONS[itinMode]} ${ITIN_LABELS[itinMode]}</b> Â· ${fmt(p.dist)}<br>` +
    `DurÃ©e estimÃ©e : <span style="color:var(--c)">${timeStr}</span><br>` +
    `Destination : ${p.lat.toFixed(4)}, ${p.lng.toFixed(4)}`;
}

function goItinerary(){
  const p = S.detPOI; if(!p) return;
  const origin = S.lat && S.lng ? `${S.lat},${S.lng}` : '';
  const url = `https://www.google.com/maps/dir/?api=1` +
    (origin ? `&origin=${origin}` : '') +
    `&destination=${p.lat},${p.lng}&travelmode=${itinMode}`;
  window.open(url, '_blank');
}

// â”€â”€ WIKIPEDIA INFO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadWikiInfo(p){
  wikiPageTitle = null;
  document.getElementById('infophotos').innerHTML = '';
  document.getElementById('infoextract').textContent = '';
  document.getElementById('infowikilink').classList.remove('on');
  document.getElementById('infonotfound').classList.remove('on');
  document.getElementById('infoloading').classList.add('on');
  document.getElementById('infonbl').innerHTML = '';

  try {
    // 1. Search Wikipedia in French
    const searchName = encodeURIComponent(p.name);
    const searchUrl = `https://fr.wikipedia.org/w/api.php?action=query&list=search&srsearch=${searchName}&srlimit=3&format=json&origin=*`;
    const searchRes = await fetch(searchUrl).then(r=>r.json());
    const hits = searchRes?.query?.search || [];

    // Pick best hit: prefer exact match or first result
    let pageTitle = null;
    for(const h of hits){
      if(h.title.toLowerCase().includes(p.name.toLowerCase()) ||
         p.name.toLowerCase().includes(h.title.toLowerCase())){
        pageTitle = h.title; break;
      }
    }
    if(!pageTitle && hits.length) pageTitle = hits[0].title;

    if(!pageTitle){
      showInfoNotFound(); return;
    }

    wikiPageTitle = pageTitle;

    // 2. Get page summary (extract + thumbnail)
    const summaryUrl = `https://fr.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(pageTitle)}`;
    const summary = await fetch(summaryUrl).then(r=>r.json());

    document.getElementById('infoloading').classList.remove('on');

    // Extract
    const extract = summary.extract || '';
    document.getElementById('infoextract').textContent =
      extract.length > 600 ? extract.slice(0,600)+'â€¦' : extract;

    // Thumbnail from summary
    const photos = [];
    if(summary.thumbnail?.source) photos.push(summary.thumbnail.source);

    // 3. Get more images from the page
    const imgUrl = `https://fr.wikipedia.org/w/api.php?action=query&titles=${encodeURIComponent(pageTitle)}&prop=images&imlimit=10&format=json&origin=*`;
    const imgRes = await fetch(imgUrl).then(r=>r.json());
    const pages = imgRes?.query?.pages || {};
    const imgList = Object.values(pages)[0]?.images || [];
    const photoTitles = imgList
      .map(i=>i.title)
      .filter(t=>/\.(jpg|jpeg|png|webp)$/i.test(t) && !/flag|logo|icon|coat|blason|seal|map|carte|plan/i.test(t))
      .slice(0,5);

    // 4. Resolve image URLs
    if(photoTitles.length){
      const titlesParam = photoTitles.map(t=>encodeURIComponent(t)).join('|');
      const urlRes = await fetch(`https://fr.wikipedia.org/w/api.php?action=query&titles=${titlesParam}&prop=imageinfo&iiprop=url&iiurlwidth=400&format=json&origin=*`).then(r=>r.json());
      const imgPages = urlRes?.query?.pages || {};
      for(const pg of Object.values(imgPages)){
        const url = pg?.imageinfo?.[0]?.thumburl || pg?.imageinfo?.[0]?.url;
        if(url && !photos.includes(url)) photos.push(url);
      }
    }

    // Render photos
    const photoEl = document.getElementById('infophotos');
    photos.slice(0,6).forEach(src=>{
      const img = document.createElement('img');
      img.className = 'infophoto';
      img.src = src;
      img.loading = 'lazy';
      img.onclick = ()=>window.open(src,'_blank');
      img.onerror = ()=>img.remove();
      photoEl.appendChild(img);
    });

    if(!extract && !photos.length){ showInfoNotFound(); return; }

    // Wiki link button
    document.getElementById('infowikilink').classList.add('on');
    document.getElementById('infowikilink').textContent = `ğŸ“– Lire sur WikipÃ©dia : ${pageTitle}`;

    // 5. Load nearby places (OSM) if city
    if(p.type.cat === 'city') loadNearbyInPanel(p);

  } catch(e){
    console.error('Wiki error', e);
    showInfoNotFound();
  }
}

function openWiki(){
  if(wikiPageTitle)
    window.open(`https://fr.wikipedia.org/wiki/${encodeURIComponent(wikiPageTitle)}`, '_blank');
}

function showInfoNotFound(){
  document.getElementById('infoloading').classList.remove('on');
  document.getElementById('infonotfound').classList.add('on');
  // Still try nearby for cities
  if(S.detPOI?.type?.cat === 'city') loadNearbyInPanel(S.detPOI);
}

async function loadNearbyInPanel(p){
  const container = document.getElementById('infonbl');
  container.innerHTML = '<div class="nbt">LIEUX Ã€ PROXIMITÃ‰</div><div id="nbiInner"></div>';
  const q=`[out:json][timeout:15];(
node["tourism"~"^(attraction|museum|viewpoint|monument|castle)$"](around:3000,${p.lat},${p.lng});
node["historic"~"^(castle|monument|ruins|church|memorial|archaeological_site)$"](around:3000,${p.lat},${p.lng});
node["amenity"~"^(place_of_worship|theatre)$"]["name"](around:3000,${p.lat},${p.lng});
node["leisure"~"^(park|garden|nature_reserve)$"]["name"](around:3000,${p.lat},${p.lng});
node["natural"~"^(beach|cliff|peak)$"]["name"](around:3000,${p.lat},${p.lng});
);out 20;`;
  try{
    const res = await fetch('https://overpass-api.de/api/interpreter',{method:'POST',body:q}).then(r=>r.json());
    const items = res.elements.filter(e=>e.tags?.name)
      .map(e=>({name:e.tags.name,tags:e.tags}))
      .filter((e,i,a)=>a.findIndex(x=>x.name===e.name)===i).slice(0,12);
    const inner = document.getElementById('nbiInner');
    if(!inner) return;
    if(!items.length){
      inner.innerHTML='<div style="font-size:10px;color:var(--mu);padding:4px">Aucun lieu trouvÃ© dans 3 km.</div>';
    } else {
      items.forEach(it=>{
        const{e,l}=clsNrb(it.tags);
        const d=document.createElement('div'); d.className='nbi';
        d.innerHTML=`<span class="nbii">${e}</span><span class="nbin">${it.name}</span><span class="nbit">${l}</span>`;
        d.onclick=()=>window.open(`https://www.google.com/maps/search/${encodeURIComponent(it.name+' '+p.name)}`,'_blank');
        inner.appendChild(d);
      });
    }
  }catch(e){
    const inner = document.getElementById('nbiInner');
    if(inner) inner.innerHTML='<div style="color:var(--red);font-size:10px;padding:4px">Erreur rÃ©seau.</div>';
  }
}

function clsNrb(t){
  const{tourism:to,historic:hi,amenity:a,leisure:le,natural:n}=t;
  if(to==='museum')return{e:'ğŸ›',l:'MusÃ©e'};if(to==='viewpoint')return{e:'ğŸ‘',l:'Panorama'};
  if(to==='castle'||hi==='castle'||hi==='manor')return{e:'ğŸ°',l:'ChÃ¢teau'};
  if(hi==='church'||a==='place_of_worship')return{e:'â›ª',l:'Religieux'};
  if(hi==='ruins'||hi==='archaeological_site')return{e:'ğŸš',l:'Ruines'};
  if(hi==='memorial'||hi==='monument'||to==='monument')return{e:'ğŸ—¿',l:'Monument'};
  if(le==='park'||le==='garden')return{e:'ğŸŒ³',l:'Parc'};
  if(le==='nature_reserve')return{e:'ğŸŒ¿',l:'RÃ©serve'};
  if(n==='beach')return{e:'ğŸ–',l:'Plage'};
  return{e:'ğŸ“',l:'Lieu'};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MENU / QUIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goMenu(){
  const s=document.getElementById('startup');
  s.style.display='flex'; s.style.opacity='0'; s.style.transition='opacity .3s';
  const b=document.getElementById('stbtn');b.disabled=false;b.textContent='â†© Reprendre';
  requestAnimationFrame(()=>s.style.opacity='1');
}
function showQuit(){document.getElementById('qov').classList.add('on');}
function hideQuit(){document.getElementById('qov').classList.remove('on');}
function quitApp(){
  const v=document.getElementById('cam');
  if(v.srcObject){v.srcObject.getTracks().forEach(t=>t.stop());v.srcObject=null;}
  window.close();
  setTimeout(()=>{
    document.body.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100dvh;background:#020d1a;font-family:Syne,sans-serif;color:#e0f4ff;flex-direction:column;gap:10px"><div style="font-size:32px;font-weight:800">HORIZON</div><div style="font-family:monospace;font-size:11px;color:rgba(180,220,240,.5)">Fermez cet onglet</div></div>';
  },200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEBUG TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let dbgTimer=null;
function showDbg(msg,dur=3000){
  const el=document.getElementById('dbg');
  el.textContent=msg; el.style.display='block';
  if(dbgTimer)clearTimeout(dbgTimer);
  dbgTimer=setTimeout(()=>el.style.display='none',dur);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GEO UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function hav(a,b,c,d){
  const R=6371000,da=(c-a)*Math.PI/180,db=(d-b)*Math.PI/180;
  const x=Math.sin(da/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(db/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}
function brg(a,b,c,d){
  const f1=a*Math.PI/180,f2=c*Math.PI/180,dl=(d-b)*Math.PI/180;
  return(Math.atan2(Math.sin(dl)*Math.cos(f2),Math.cos(f1)*Math.sin(f2)-Math.sin(f1)*Math.cos(f2)*Math.cos(dl))*180/Math.PI+360)%360;
}
function ndeg(d){d=((d%360)+360)%360;return d>180?d-360:d;}
function card(g){return['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSO','SO','OSO','O','ONO','NO','NNO'][Math.round(g/22.5)%16];}
function fmt(m){return m<1000?Math.round(m)+' m':(m/1000).toFixed(m<10000?1:0)+' km';}

window.addEventListener('resize',()=>{poiEls.forEach(e=>e.remove());poiEls.clear();});
</script>
</body>
</html>
