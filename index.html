<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"/>
  <meta name="mobile-web-app-capable" content="yes"/>
  <meta name="theme-color" content="#e8f2f7"/>
  <title>Mon Horizon</title>
  <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;0,700;1,400&family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
/* â”€â”€ PALETTE AQUARELLE MARITIME â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
:root{
  --sea:#5b9ec9;        /* bleu mer doux */
  --seadeep:#3a7fa8;    /* bleu profond */
  --seafoam:#daeef8;    /* Ã©cume claire */
  --sand:#f5e9d0;       /* sable chaud */
  --sail:#faf6ee;       /* blanc voile */
  --hull:#8b5e3c;       /* brun coque */
  --coral:#d96b55;      /* corail doux */
  --seagrass:#6a9e7a;   /* vert algue */
  --gold:#c8943a;       /* or ambre */
  --bg:#eef5f9;         /* fond ciel pÃ¢le */
  --card:rgba(250,246,238,.92); /* carte voile */
  --cardsolid:#faf6ee;
  --tx:#2d4a5e;         /* marine foncÃ© â€” trÃ¨s lisible */
  --txlight:#4a6b80;    /* texte secondaire */
  --mu:#8aabb8;         /* gris bleu doux */
  --bord:rgba(91,158,201,.3);
  --bordhov:rgba(91,158,201,.65);
  --red:#c94d3a;
  --gr:#4a9e6a;
  --shadow:0 2px 12px rgba(58,127,168,.15);
  --shadow-md:0 4px 20px rgba(58,127,168,.2);
  --amber:#9a6e00;      /* jaune foncÃ© lisible */
  --amberbg:rgba(255,221,100,.35); /* fond jaune pastel */
  --amberbd:rgba(180,130,0,.45);  /* bordure ambre */
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{background:var(--bg);color:var(--tx);font-family:'Nunito',sans-serif;overflow:hidden;height:100dvh;width:100dvw;user-select:none}

/* â”€â”€ CAMERA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#cam{
position:fixed;
top:0;
left:0;
width:100%;
height:100%;
object-fit:cover;
z-index:0;
border-radius:0
}
/* â”€â”€ GPS POPUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#gpspopup{
  position:fixed;bottom:70px;left:12px;right:12px;z-index:40;
  background:var(--card);border:1.5px solid var(--bord);border-radius:16px;
  padding:14px 15px;display:none;align-items:center;gap:12px;
  box-shadow:var(--shadow-md);backdrop-filter:blur(12px);
  animation:slideUp .3s ease;
}
#gpspopup.on{display:flex}
@keyframes slideUp{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
.gpp-icon{font-size:22px;flex-shrink:0}
.gpp-txt{flex:1}
.gpp-title{font-weight:800;font-size:13px;color:var(--tx);margin-bottom:2px}
.gpp-desc{font-size:11px;color:var(--txlight);line-height:1.4}
.gpp-btn{
  flex-shrink:0;background:var(--seadeep);color:#fff;border:none;
  border-radius:10px;padding:8px 13px;font-family:'Nunito',sans-serif;
  font-size:12px;font-weight:800;cursor:pointer;white-space:nowrap;
}
.gpp-close{
  position:absolute;top:8px;right:10px;background:none;border:none;
  color:var(--mu);font-size:14px;cursor:pointer;padding:2px 4px;
  font-family:'Nunito',sans-serif;
}

/* vignette douce style peinture â€” bords lÃ©gÃ¨rement estompÃ©s */
.vig{position:fixed;inset:0;z-index:5;background:radial-gradient(ellipse at center,transparent 45%,rgba(238,245,249,.35) 100%);pointer-events:none}
#ar{position:fixed;inset:0;z-index:10;pointer-events:none}
.hl{position:absolute;left:0;right:0;top:50%;height:1px;background:linear-gradient(to right,transparent,rgba(91,158,201,.5),transparent)}
.ch{position:absolute;top:50%;left:calc(50% - 18px);width:36px;height:1px;background:rgba(91,158,201,.55);transform:translateY(-50%)}
.cv{position:absolute;left:50%;top:calc(50% - 18px);width:1px;height:36px;background:rgba(91,158,201,.55);transform:translateX(-50%)}

/* â”€â”€ COMPASS BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#cbar{position:fixed;top:0;left:0;right:0;z-index:20;height:52px;background:#f8f4ea;pointer-events:none;overflow:hidden;border-bottom:2px solid rgba(91,158,201,.25);box-shadow:0 2px 8px rgba(58,127,168,.12)}
#ctrack{position:relative;width:100%;height:52px;overflow:hidden}
.clbl{position:absolute;top:50%;transform:translateX(-50%) translateY(-50%);font-family:'Nunito',sans-serif;font-size:12px;font-weight:700;color:var(--txlight)}
.clbl.card{font-size:15px;font-weight:800;color:var(--seadeep)}
#cctr{position:absolute;left:50%;top:8px;bottom:8px;width:1.5px;background:var(--coral);transform:translateX(-50%);z-index:2;border-radius:1px}
#cctr::after{content:'';position:absolute;bottom:-1px;left:50%;transform:translateX(-50%);width:6px;height:6px;background:var(--coral);border-radius:50%;box-shadow:0 0 6px rgba(201,77,58,.4)}

/* â”€â”€ HEADING BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#hdg{position:fixed;top:56px;left:50%;transform:translateX(-50%);z-index:20;font-family:'Nunito',sans-serif;font-size:14px;font-weight:800;color:var(--seadeep);background:#f8f4ea;border:2px solid rgba(91,158,201,.35);border-radius:20px;padding:5px 18px;letter-spacing:.05em;pointer-events:none;box-shadow:var(--shadow)}

/* â”€â”€ MENU & BACK BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#mbtn{position:fixed;top:58px;left:12px;z-index:22;width:32px;height:32px;background:var(--card);border:1px solid var(--bord);border-radius:50%;cursor:pointer;backdrop-filter:blur(10px);display:flex;align-items:center;justify-content:center;font-size:14px;color:var(--txlight);transition:all .2s;box-shadow:var(--shadow)}
#mbtn:active{background:var(--seafoam);border-color:var(--bordhov)}
#backbtn{position:fixed;top:58px;right:12px;z-index:22;height:32px;background:var(--card);border:1px solid var(--bord);border-radius:16px;cursor:pointer;backdrop-filter:blur(10px);display:none;align-items:center;justify-content:center;font-family:'Nunito',sans-serif;font-size:12px;font-weight:600;color:var(--txlight);padding:0 13px;gap:5px;transition:all .2s;box-shadow:var(--shadow);white-space:nowrap}
#backbtn.on{display:flex}
#backbtn:active{background:var(--seafoam)}

/* â”€â”€ POI LABELS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.poi{position:fixed;left:0;top:0;transform:translateX(-50%);display:flex;flex-direction:column;align-items:center;pointer-events:auto;cursor:pointer;transition:opacity .2s;z-index:15}
/* trait aquarelle sous le POI â€” fin et doux */
.poc{width:1.5px;background:linear-gradient(to bottom,rgba(91,158,201,.55),transparent);margin-bottom:4px;border-radius:1px}
.pob{background:var(--card);border:1px solid var(--bord);border-radius:12px;padding:7px 11px;backdrop-filter:blur(16px);min-width:80px;max-width:130px;text-align:center;transition:all .2s;box-shadow:var(--shadow)}
.poi:active .pob,.poi:hover .pob{border-color:var(--bordhov);box-shadow:var(--shadow-md)}
.poi[data-f="1"]{opacity:.95}.poi[data-f="2"]{opacity:.65}.poi[data-f="3"]{opacity:.35}
.pii{font-size:14px;display:block;margin-bottom:2px}
.pin{font-family:'Lora',serif;font-weight:600;font-size:11px;color:var(--tx);line-height:1.3}
.pid{font-family:'Nunito',sans-serif;font-size:9px;font-weight:700;color:var(--sea);margin-top:2px;letter-spacing:.02em}

/* â”€â”€ CROSSHAIR FOCUS BADGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#cfocus{position:fixed;top:50%;left:50%;transform:translate(-50%,-125%);z-index:22;
  background:var(--card);border:1.5px solid var(--sea);border-radius:14px;
  padding:8px 15px;backdrop-filter:blur(14px);display:none;pointer-events:none;text-align:center;
  transition:opacity .3s;box-shadow:var(--shadow-md)}
#cfocus.on{display:block}
#cfn{font-family:'Lora',serif;font-size:14px;font-weight:600;color:var(--tx)}
#cfd{font-family:'Nunito',sans-serif;font-size:11px;font-weight:700;color:var(--sea);margin-top:2px}
#cft{font-family:'Nunito',sans-serif;font-size:9px;color:var(--mu);margin-top:1px}

/* â”€â”€ FILTERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#fw{position:fixed;bottom:50px;left:0;right:0;z-index:21;display:flex;flex-direction:column;gap:0;pointer-events:auto;background:#f8f4ea;border-top:1px solid rgba(91,158,201,.18);border-bottom:1px solid rgba(91,158,201,.18);box-shadow:0 -1px 8px rgba(58,127,168,.08)}
.frow{display:flex;gap:6px;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:none;padding:3px 12px}
.frow::-webkit-scrollbar{display:none}
#dfrow{background:#f8f4ea;padding:5px 0;border-top:1px solid rgba(91,158,201,.15)}
.pill{flex-shrink:0;font-family:'Nunito',sans-serif;font-size:11px;font-weight:600;padding:5px 11px;border-radius:20px;border:1px solid var(--bord);background:rgba(255,255,255,.6);color:var(--txlight);cursor:pointer;transition:all .18s;white-space:nowrap;box-shadow:0 1px 4px rgba(58,127,168,.1)}
.pill:active{transform:scale(.93)}
.pill.on{border-color:var(--amberbd);background:var(--amberbg);color:var(--amber);font-weight:800}
.cpill.on{border-color:var(--amberbd);background:var(--amberbg);color:var(--amber);font-weight:800}

/* â”€â”€ BOTTOM HUD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#hud{position:fixed;bottom:0;left:0;right:0;z-index:20;padding:7px 14px;padding-bottom:max(7px,env(safe-area-inset-bottom));background:rgba(250,246,238,.95);display:flex;align-items:center;gap:8px;border-top:1px solid rgba(91,158,201,.2);box-shadow:0 -2px 12px rgba(58,127,168,.1)}
#gpstxt{font-family:'Nunito',sans-serif;font-size:10px;font-weight:600;color:var(--txlight);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;cursor:pointer;display:flex;align-items:center;gap:6px}
.sdot{width:7px;height:7px;border-radius:50%;background:var(--mu);flex-shrink:0}
.sdot.ok{background:var(--gr);box-shadow:0 0 5px rgba(74,158,106,.5)}.sdot.err{background:var(--red);box-shadow:0 0 5px rgba(201,77,58,.5)}.sdot.mn{background:var(--gold);box-shadow:0 0 5px rgba(200,148,58,.5)}
#pcnt{font-family:'Nunito',sans-serif;font-size:10px;font-weight:700;color:var(--mu);white-space:nowrap;flex-shrink:0}
.hbtn{font-family:'Nunito',sans-serif;font-size:12px;font-weight:700;color:var(--seadeep);background:rgba(91,158,201,.15);border:1px solid var(--bord);border-radius:14px;padding:5px 11px;cursor:pointer;flex-shrink:0;transition:all .18s}
.hbtn:active{background:rgba(91,158,201,.3)}
.hbtn.g{color:var(--hull);background:rgba(200,148,58,.12);border-color:rgba(200,148,58,.4)}

/* â”€â”€ DEBUG TOAST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#dbg{position:fixed;top:90px;left:50%;transform:translateX(-50%);z-index:50;font-family:'Nunito',sans-serif;font-size:11px;font-weight:600;color:var(--hull);background:rgba(245,233,208,.95);border:1px solid rgba(200,148,58,.45);border-radius:20px;padding:5px 16px;pointer-events:none;display:none;white-space:nowrap;max-width:90vw;overflow:hidden;text-overflow:ellipsis;box-shadow:var(--shadow)}

/* â”€â”€ DETAIL PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#det{position:fixed;bottom:106px;left:12px;right:12px;z-index:30;background:rgba(250,246,238,.97);border:1.5px solid var(--bord);border-radius:18px;padding:16px 17px;backdrop-filter:blur(20px);display:none;pointer-events:auto;max-height:68vh;overflow-y:auto;box-shadow:var(--shadow-md)}
#det.on{display:block}
#detx{position:absolute;top:11px;right:13px;background:none;border:none;color:var(--mu);font-size:17px;cursor:pointer;font-family:'Nunito',sans-serif;font-weight:400;line-height:1}
#deti{font-size:26px;margin-bottom:5px}
#detn{font-family:'Lora',serif;font-size:19px;font-weight:700;color:var(--tx);margin-bottom:3px;line-height:1.2}
#dett{font-family:'Nunito',sans-serif;font-size:10px;font-weight:700;color:var(--sea);letter-spacing:.1em;text-transform:uppercase;margin-bottom:11px}
#detm{display:flex;gap:14px;flex-wrap:wrap;padding:10px 12px;background:rgba(218,238,248,.45);border-radius:10px;border:1px solid rgba(91,158,201,.18)}
.dmi{display:flex;flex-direction:column;gap:2px}
.dml{font-family:'Nunito',sans-serif;font-size:9px;font-weight:700;color:var(--mu);letter-spacing:.08em;text-transform:uppercase}
.dmv{font-family:'Lora',serif;font-size:13px;color:var(--tx);font-weight:600}
#deta{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
.dbtn{flex:1;min-width:90px;font-family:'Nunito',sans-serif;font-size:12px;font-weight:700;border-radius:11px;padding:9px;cursor:pointer;border:none;display:flex;align-items:center;justify-content:center;gap:6px;transition:opacity .18s}
.dbtn:active{opacity:.72}
#binfo{background:rgba(91,158,201,.18);color:var(--seadeep);border:1.5px solid var(--bord) !important}
#binfo.active{background:rgba(91,158,201,.35);border-color:var(--sea) !important}
#bnav{background:var(--seadeep);color:#fff}

/* â”€â”€ INFO PANEL (Wikipedia) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#detinfo{margin-top:12px;display:none}
#detinfo.on{display:block}
#infoimgw{width:100%;height:145px;border-radius:10px;overflow:hidden;margin-bottom:10px;background:rgba(218,238,248,.4);display:none;border:1px solid var(--bord)}
#infoimgw.on{display:block}
#infoimg{width:100%;height:100%;object-fit:cover}
#infoext{font-family:'Lora',serif;font-size:12px;color:var(--tx);line-height:1.8;max-height:150px;overflow-y:auto}
#infowl{margin-top:9px;display:flex;justify-content:flex-end}
#infowl a{font-family:'Nunito',sans-serif;font-size:10px;font-weight:700;color:var(--sea);text-decoration:none;border:1px solid var(--bord);border-radius:9px;padding:4px 10px;background:rgba(218,238,248,.5)}
#infoloading{font-family:'Nunito',sans-serif;font-size:11px;color:var(--mu);text-align:center;padding:18px 0;display:none;font-weight:600}
#infoloading.on{display:block}
#infoerr{font-family:'Nunito',sans-serif;font-size:11px;color:var(--red);padding:6px 0;display:none;font-weight:600}
#infoerr.on{display:block}

/* â”€â”€ STATS OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#statsov{position:fixed;inset:0;z-index:40;background:rgba(238,245,249,.6);backdrop-filter:blur(12px);display:none;align-items:flex-end;justify-content:center;padding-bottom:62px}
#statsov.on{display:flex}
#statsbox{background:rgba(250,246,238,.98);border:1.5px solid var(--bord);border-radius:20px;padding:18px;width:calc(100% - 24px);max-width:420px;max-height:75vh;overflow-y:auto;box-shadow:var(--shadow-md)}
#statsbox h2{font-family:'Lora',serif;font-size:16px;font-weight:700;color:var(--tx);margin-bottom:4px;display:flex;align-items:center;justify-content:space-between}
#statsbox h2 button{background:none;border:none;color:var(--mu);font-size:17px;cursor:pointer;font-family:'Nunito',sans-serif;line-height:1}
#stattot{font-family:'Nunito',sans-serif;font-size:11px;color:var(--mu);font-weight:600;margin-bottom:13px}
.statrow{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:11px;background:rgba(218,238,248,.35);border:1px solid rgba(91,158,201,.15);margin-bottom:6px}
.statrow:last-child{margin-bottom:0}
.statei{font-size:17px;flex-shrink:0;width:23px;text-align:center}
.statn{font-family:'Nunito',sans-serif;font-size:13px;font-weight:600;color:var(--tx);flex:1}
.statb{display:flex;align-items:center;gap:7px}
.statcnt{font-family:'Lora',serif;font-size:13px;font-weight:700;color:var(--seadeep);min-width:26px;text-align:right}
.statbar{height:4px;border-radius:2px;background:var(--sea);opacity:.55;min-width:2px;max-width:80px;transition:width .3s}

/* â”€â”€ MAP MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#mmap{position:fixed;inset:0;z-index:200;background:var(--bg);display:none;flex-direction:column}
#mmap.on{display:flex}
#mmh{padding:13px 15px;display:flex;align-items:center;justify-content:space-between;background:rgba(250,246,238,.97);border-bottom:1px solid var(--bord);flex-shrink:0}
#mmht{font-family:'Lora',serif;font-weight:700;font-size:16px;color:var(--tx)}
#mmhs{font-family:'Nunito',sans-serif;font-size:10px;font-weight:600;color:var(--mu);margin-top:2px}
#mmcl{font-family:'Nunito',sans-serif;font-size:12px;font-weight:700;background:none;border:1px solid var(--bord);color:var(--txlight);border-radius:9px;padding:6px 12px;cursor:pointer}
#lmap{flex:1;z-index:1}
#mmf{padding:11px 15px;background:rgba(250,246,238,.97);border-top:1px solid var(--bord);display:flex;gap:9px;align-items:center;flex-shrink:0}
#mmc{font-family:'Nunito',sans-serif;font-size:11px;font-weight:600;color:var(--mu);flex:1}
#mmgps{font-family:'Nunito',sans-serif;font-size:12px;font-weight:700;background:rgba(200,148,58,.12);border:1px solid rgba(200,148,58,.4);color:var(--hull);border-radius:10px;padding:8px 13px;cursor:pointer;transition:opacity .15s;white-space:nowrap}
#mmgps:disabled{opacity:.35;cursor:not-allowed}
#mmok{font-family:'Nunito',sans-serif;font-size:13px;font-weight:800;background:var(--seadeep);color:#fff;border:none;border-radius:10px;padding:10px 19px;cursor:pointer;transition:opacity .15s;white-space:nowrap}
#mmok:disabled{opacity:.35;cursor:not-allowed}
#mmok:not(:disabled):active{opacity:.8}

/* â”€â”€ COMPASS CALIBRATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#calw{position:fixed;top:136px;left:50%;transform:translateX(-50%);z-index:25;display:none;gap:6px;align-items:center;background:var(--card);border:1px solid var(--bord);border-radius:20px;padding:6px 11px;backdrop-filter:blur(12px);box-shadow:var(--shadow)}
#calw.on{display:flex}
#calw span{font-family:'Nunito',sans-serif;font-size:10px;font-weight:600;color:var(--mu)}
#calw button{font-family:'Nunito',sans-serif;font-size:11px;font-weight:700;background:none;border:1px solid var(--bord);border-radius:10px;color:var(--seadeep);padding:3px 8px;cursor:pointer}
#offd{font-family:'Lora',serif;font-size:12px;font-style:italic;color:var(--seadeep);min-width:38px;text-align:center}
#cwarn{position:fixed;top:106px;left:50%;transform:translateX(-50%);z-index:25;background:rgba(200,148,58,.12);border:1px solid rgba(200,148,58,.5);border-radius:20px;padding:5px 14px;font-family:'Nunito',sans-serif;font-size:10px;font-weight:700;color:var(--hull);pointer-events:auto;cursor:pointer;display:none;box-shadow:var(--shadow)}

/* â”€â”€ STARTUP SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#startup{position:fixed;inset:0;z-index:100;background:linear-gradient(160deg,#daeef8 0%,#eef5f9 40%,#f5e9d0 100%);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:22px;padding:32px;overflow-y:auto}
.slogo{
font-family:'Lora',serif;
font-size:25px;
font-weight:700;
line-height:1;
text-align:center;
color:var(--tx);
letter-spacing:-.01em
}
.slogo span{color:var(--sea);font-style:italic}
.ssub{font-family:'Nunito',sans-serif;font-size:11px;font-weight:700;color:var(--mu);letter-spacing:.18em;text-align:center;text-transform:uppercase}
.sprm{display:flex;flex-direction:column;gap:8px;width:100%;max-width:340px}
.pi{display:flex;align-items:center;gap:11px;background:rgba(250,246,238,.8);border:1px solid var(--bord);border-radius:13px;padding:11px 14px;font-size:13px;font-weight:600;color:var(--txlight);backdrop-filter:blur(8px)}
.piic{font-size:20px;flex-shrink:0}
.pis{margin-left:auto;font-family:'Nunito',sans-serif;font-size:10px;font-weight:700;color:var(--mu)}
.pi.ok{border-color:rgba(74,158,106,.45);background:rgba(74,158,106,.07)}.pi.ok .pis{color:var(--gr)}
.pi.no{border-color:rgba(201,77,58,.45);background:rgba(201,77,58,.07)}.pi.no .pis{color:var(--red)}
#ghelp{display:none;width:100%;max-width:340px;background:rgba(201,77,58,.07);border:1px solid rgba(201,77,58,.3);border-radius:13px;padding:14px 15px}
#ghelp.on{display:block}
#ghelp h3{font-family:'Lora',serif;font-size:14px;color:var(--red);margin-bottom:7px;font-weight:600}
#ghelp p{font-family:'Nunito',sans-serif;font-size:11px;font-weight:600;color:var(--txlight);line-height:1.8;white-space:pre-line}
#gretrybtn{margin-top:9px;width:100%;background:rgba(201,77,58,.1);border:1px solid rgba(201,77,58,.35);border-radius:10px;padding:9px;font-family:'Nunito',sans-serif;font-size:13px;font-weight:700;color:var(--red);cursor:pointer}
#stbtn{width:100%;max-width:340px;background:var(--seadeep);color:#fff;border:none;border-radius:14px;padding:16px;font-family:'Lora',serif;font-size:17px;font-weight:700;font-style:italic;cursor:pointer;letter-spacing:.02em;box-shadow:0 4px 16px rgba(58,127,168,.35);transition:opacity .15s}
#stbtn:disabled{opacity:.4;cursor:not-allowed}
#stbtn:not(:disabled):active{opacity:.82}
#qbtn{background:none;border:none;font-family:'Nunito',sans-serif;font-size:11px;font-weight:600;color:var(--mu);cursor:pointer;text-decoration:underline;padding:2px}

/* â”€â”€ QUIT OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#qov{position:fixed;inset:0;z-index:300;background:rgba(238,245,249,.88);backdrop-filter:blur(12px);display:none;flex-direction:column;align-items:center;justify-content:center}
#qov.on{display:flex}
#qbox{background:rgba(250,246,238,.98);border:1.5px solid var(--bord);border-radius:20px;padding:28px 30px;text-align:center;max-width:280px;box-shadow:var(--shadow-md)}
#qbox h2{font-family:'Lora',serif;font-size:22px;font-weight:700;color:var(--tx);margin-bottom:6px}
#qbox p{font-family:'Nunito',sans-serif;font-size:12px;font-weight:600;color:var(--mu);margin-bottom:20px}
.qbs{display:flex;gap:9px}
.qb{flex:1;border:none;border-radius:12px;padding:12px;font-family:'Nunito',sans-serif;font-size:13px;font-weight:800;cursor:pointer}
#qno{background:rgba(91,158,201,.12);border:1.5px solid var(--bord) !important;color:var(--seadeep)}
#qyes{background:var(--red);color:white}

/* â”€â”€ LOADING SPINNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#ldr{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:25;display:none}
#ldr.on{display:block}
#ldr svg{animation:spin 1.2s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* â”€â”€ PERMISSION OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#permov{position:fixed;inset:0;z-index:150;background:linear-gradient(160deg,#daeef8 0%,#eef5f9 40%,#f5e9d0 100%);display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;padding:30px;overflow-y:auto}
#permov.gone{display:none}
.perm-logo{font-family:'Lora',serif;font-size:44px;font-weight:700;text-align:center;line-height:1;color:var(--tx)}
.perm-logo span{color:var(--sea);font-style:italic}
.perm-sub{font-family:'Nunito',sans-serif;font-size:10px;font-weight:700;color:var(--mu);letter-spacing:.18em;text-align:center;text-transform:uppercase}
.perm-title{font-family:'Lora',serif;font-size:14px;font-weight:600;color:var(--txlight);text-align:center;margin-top:4px;max-width:300px;line-height:1.5}
.perm-list{display:flex;flex-direction:column;gap:9px;width:100%;max-width:360px}
.perm-row{display:flex;align-items:center;gap:13px;background:rgba(250,246,238,.85);border:1px solid var(--bord);border-radius:13px;padding:13px 15px;backdrop-filter:blur(8px)}
.perm-row.ok{border-color:rgba(74,158,106,.5);background:rgba(74,158,106,.08)}
.perm-row.no{border-color:rgba(201,77,58,.45);background:rgba(201,77,58,.07)}
.perm-icon{font-size:21px;flex-shrink:0;width:28px;text-align:center}
.perm-info{flex:1}
.perm-name{font-family:'Nunito',sans-serif;font-size:13px;font-weight:700;color:var(--tx)}
.perm-desc{font-family:'Nunito',sans-serif;font-size:10px;font-weight:600;color:var(--mu);margin-top:2px}
.perm-status{font-family:'Nunito',sans-serif;font-size:10px;font-weight:800;flex-shrink:0}
.perm-status.ok{color:var(--gr)}.perm-status.no{color:var(--red)}.perm-status.wait{color:var(--hull)}
#permbtns{display:flex;flex-direction:column;gap:9px;width:100%;max-width:360px}
#permask{width:100%;background:var(--seadeep);color:#fff;border:none;border-radius:14px;padding:16px;font-family:'Lora',serif;font-size:16px;font-weight:700;font-style:italic;cursor:pointer;letter-spacing:.02em;box-shadow:0 4px 16px rgba(58,127,168,.35);transition:opacity .15s}
#permask:disabled{opacity:.38;cursor:not-allowed}
#permask:not(:disabled):active{opacity:.8}
#permskip{width:100%;background:none;border:1px solid var(--bord);border-radius:14px;padding:12px;font-family:'Nunito',sans-serif;font-size:11px;font-weight:600;color:var(--mu);cursor:pointer}
/* denied screen */
#deniedov{position:fixed;inset:0;z-index:160;background:linear-gradient(160deg,#daeef8 0%,#eef5f9 40%,#f5e9d0 100%);display:none;flex-direction:column;align-items:center;justify-content:center;gap:17px;padding:34px;text-align:center}
#deniedov.on{display:flex}
#deniedov .d-logo{font-family:'Lora',serif;font-size:38px;font-weight:700;color:var(--tx)}
#deniedov .d-logo span{color:var(--sea);font-style:italic}
#deniedov .d-icon{font-size:52px;margin:4px 0}
#deniedov h2{font-family:'Lora',serif;font-size:19px;font-weight:700;color:var(--red);line-height:1.35}
#deniedov p{font-family:'Nunito',sans-serif;font-size:12px;font-weight:600;color:var(--txlight);line-height:1.85;max-width:310px}
#deniedov .d-retry{width:100%;max-width:310px;background:rgba(201,77,58,.1);border:1.5px solid rgba(201,77,58,.4);border-radius:13px;padding:14px;font-family:'Nunito',sans-serif;font-size:13px;font-weight:800;color:var(--red);cursor:pointer;margin-top:6px}
#deniedov .d-continue{width:100%;max-width:310px;background:rgba(91,158,201,.1);border:1px solid var(--bord);border-radius:13px;padding:12px;font-family:'Nunito',sans-serif;font-size:11px;font-weight:600;color:var(--txlight);cursor:pointer}

/* â”€â”€ LOGO IMAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.d-logo-img{display:block;margin:0 auto 6px;width:400px;height:auto;object-fit:contain}
</style>
</head>
<body>

<!-- PERMISSION OVERLAY -->
<div id="permov">
  <div>
    <img src="/public/logo.png" alt="Mon Horizon" class="d-logo-img"/>
    <div class="perm-sub" style="margin-top:2px;font-size:9px;letter-spacing:.2em">CE QUI EST DEVANT VOUS</div>
  </div>
  <div class="perm-title">Cette application nÃ©cessite les accÃ¨s suivants pour fonctionner.</div>
  <div class="perm-list">
    <div class="perm-row" id="pr-cam">
      <span class="perm-icon">ğŸ“·</span>
      <div class="perm-info">
        <div class="perm-name">CamÃ©ra</div>
        <div class="perm-desc">Vue en rÃ©alitÃ© augmentÃ©e</div>
      </div>
      <span class="perm-status wait" id="ps-cam">EN ATTENTE</span>
    </div>
    <div class="perm-row" id="pr-gps">
      <span class="perm-icon">ğŸ“</span>
      <div class="perm-info">
        <div class="perm-name">Localisation GPS</div>
        <div class="perm-desc">Calcul des distances et directions</div>
      </div>
      <span class="perm-status wait" id="ps-gps">EN ATTENTE</span>
    </div>
    <div class="perm-row" id="pr-cmp">
      <span class="perm-icon">ğŸ§­</span>
      <div class="perm-info">
        <div class="perm-name">Boussole</div>
        <div class="perm-desc">Orientation en temps rÃ©el</div>
      </div>
      <span class="perm-status wait" id="ps-cmp">EN ATTENTE</span>
    </div>
  </div>
  <div id="permbtns">
    <button id="permask" onclick="requestAllPermissions()">Autoriser les accÃ¨s</button>
    <button id="permskip" onclick="launchWithoutPerms()">Continuer sans autoriser</button>
  </div>
</div>

<!-- DENIED SCREEN -->
<div id="deniedov">
  <img src="/public/logo.png" alt="Mon Horizon" class="d-logo-img"/>
  <div class="d-icon">ğŸ”’</div>
  <h2>AccÃ¨s requis</h2>
  <p id="deniedmsg">Cette application ne peut pas fonctionner sans l'accÃ¨s Ã  la camÃ©ra, Ã  la localisation GPS et Ã  la boussole. Ces donnÃ©es ne sont jamais partagÃ©es et restent sur votre appareil.</p>
  <button class="d-retry" onclick="retryPermissions()">â†º RÃ©essayer</button>
  <button class="d-continue" onclick="hideDenied()">Continuer en mode limitÃ©</button>
</div>

<!-- STARTUP -->
<div id="startup">
  <div style="text-align:center">
    <img src="/public/logo.png" alt="Mon Horizon" class="d-logo-img"/>
    <div class="ssub" style="margin-top:2px;font-size:9px;letter-spacing:.2em">CE QUI EST DEVANT VOUS</div>
  </div>
  <div class="sprm">
    <div class="pi" id="pcam"><span class="piic">ğŸ“·</span><span>CamÃ©ra</span><span class="pis">EN ATTENTE</span></div>
    <div class="pi" id="pgps"><span class="piic">ğŸ“</span><span>Localisation GPS</span><span class="pis">EN ATTENTE</span></div>
    <div class="pi" id="pcmp"><span class="piic">ğŸ§­</span><span>Boussole</span><span class="pis">EN ATTENTE</span></div>
  </div>
  <div id="ghelp">
    <h3>âš  Localisation refusÃ©e</h3>
    <p id="ghelpb"></p>
    <button id="gretrybtn" onclick="retryGPS()">â†º RÃ©essayer</button>
  </div>
  <button id="stbtn" onclick="initApp()">DÃ©marrer</button>
  <button id="qbtn" onclick="showQuit()">Quitter l'application</button>
</div>

<!-- CAMERA -->
<video id="cam" autoplay playsinline muted></video>
<div class="vig"></div>

<!-- AR OVERLAY -->
<div id="ar">
  <div class="hl"></div><div class="ch"></div><div class="cv"></div>
  <div id="poic"></div>
</div>

<!-- COMPASS -->
<div id="cbar"><div id="ctrack"><div id="cctr"></div></div></div>
<div id="hdg">---Â° N</div>
<button id="mbtn" onclick="goMenu()">â˜°</button>
<button id="backbtn" onclick="goMenu()">â† Menu</button>
<div id="cwarn" onclick="toggleCal()">âš  Boussole non calibrÃ©e Â· tap âœ•</div>
<div id="calw">
  <span>Offset:</span>
  <button onclick="chOff(-10)">âˆ’10Â°</button>
  <button onclick="chOff(-5)">âˆ’5Â°</button>
  <span id="offd">0Â°</span>
  <button onclick="chOff(+5)">+5Â°</button>
  <button onclick="chOff(+10)">+10Â°</button>
  <button onclick="toggleCal()">âœ•</button>
</div>

<!-- FILTERS -->
<div id="fw">
  <div class="frow" id="cfrow"></div>
  <div class="frow" id="dfrow"></div>
</div>

<!-- HUD -->
<div id="hud">
  <div id="gpstxt" onclick="openMap()">
    <span class="sdot" id="sdot"></span>
    <span id="gtxt">GPS inactif â€” tap pour position manuelle</span>
  </div>
  <div id="pcnt">â€”</div>
  <button class="hbtn g" onclick="openMap()">ğŸ“</button>
  <button class="hbtn" id="srchbtn" onclick="openStats()" title="Stats POIs">ğŸ”</button>
  <button class="hbtn" onclick="doRefresh()">â†»</button>
</div>

<!-- DEBUG TOAST -->
<div id="dbg"></div>

<!-- GPS MISSING POPUP -->
<div id="gpspopup">
  <span class="gpp-icon">ğŸ“</span>
  <div class="gpp-txt">
    <div class="gpp-title">Position GPS non disponible</div>
    <div class="gpp-desc">DÃ©finissez votre position manuellement pour voir les POIs.</div>
  </div>
  <button class="gpp-btn" onclick="document.getElementById('gpspopup').classList.remove('on');openMap()">DÃ©finir ğŸ“</button>
  <button class="gpp-close" onclick="document.getElementById('gpspopup').classList.remove('on')">âœ•</button>
</div>

<!-- LOADING -->
<div id="ldr"><svg width="36" height="36" viewBox="0 0 36 36">
  <circle cx="18" cy="18" r="14" fill="none" stroke="rgba(91,158,201,.2)" stroke-width="3"/>
  <circle cx="18" cy="18" r="14" fill="none" stroke="#5b9ec9" stroke-width="3" stroke-dasharray="20 68" stroke-linecap="round"/>
</svg></div>

<!-- DETAIL PANEL -->
<div id="det">
  <button id="detx" onclick="closeDet()">âœ•</button>
  <div id="deti">ğŸ“</div><div id="detn">â€”</div><div id="dett">â€”</div>
  <div id="detm">
    <div class="dmi"><span class="dml">Distance</span><span class="dmv" id="dmd">â€”</span></div>
    <div class="dmi"><span class="dml">Direction</span><span class="dmv" id="dmb">â€”</span></div>
    <div class="dmi"><span class="dml">Coords</span><span class="dmv" id="dmxy">â€”</span></div>
  </div>
  <div id="deta">
    <button class="dbtn" id="binfo" onclick="toggleInfo()">â„¹ï¸ Informations</button>
    <button class="dbtn" id="bnav" onclick="goGMaps()">ğŸ§­ ItinÃ©raire</button>
  </div>
  <div id="detinfo">
    <div id="infoloading">â³ Chargementâ€¦</div>
    <div id="infoerr"></div>
    <div id="infoimgw"><img id="infoimg" alt=""/></div>
    <div id="infoext"></div>
    <div id="infowl"><a id="infowlink" href="#" target="_blank">Voir sur WikipÃ©dia â†—</a></div>
  </div>
</div>

<!-- MAP MODAL -->
<div id="mmap">
  <div id="mmh">
    <div>
      <div id="mmht">ğŸ“ Choisir ma position</div>
      <div id="mmhs">Tap sur la carte Â· dÃ©place le marqueur Â· confirme</div>
    </div>
    <button id="mmcl" onclick="closeMap()">âœ• Annuler</button>
  </div>
  <div id="lmap"></div>
  <div id="mmf">
    <div id="mmc">Tap sur la carteâ€¦</div>
    <button id="mmgps" onclick="useGPSPos()" disabled>ğŸ“¡ GPS</button>
    <button id="mmok" onclick="confirmPos()" disabled>Confirmer</button>
  </div>
</div>

<!-- STATS OVERLAY -->
<div id="statsov" onclick="if(event.target===this)closeStats()">
  <div id="statsbox">
    <h2>Points d'intÃ©rÃªt dÃ©tectÃ©s <button onclick="closeStats()">âœ•</button></h2>
    <div id="stattot">â€”</div>
    <div id="statslist"></div>
  </div>
</div>

<!-- QUIT -->
<div id="qov">
  <div id="qbox">
    <h2>Quitter ?</h2>
    <p>L'app sera fermÃ©e.</p>
    <div class="qbs">
      <button class="qb" id="qno" onclick="hideQuit()">Annuler</button>
      <button class="qb" id="qyes" onclick="quitApp()">Quitter</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DISTS = [
  {l:'500m', v:500},   {l:'1km',  v:1000},
  {l:'2km',  v:2000},  {l:'5km',  v:5000},
  {l:'10km', v:10000}, {l:'25km', v:25000},
  {l:'50km', v:50000}, {l:'100km',v:100000},
];
const CATS = [
  {id:'all',  lb:'ğŸŒ Tout',       cc:'#00e5ff'},
  {id:'city', lb:'ğŸ™ Villes',      cc:'#a78bfa'},
  {id:'coast',lb:'ğŸ—º CÃ´tes',       cc:'#38bdf8'},
  {id:'isle', lb:'ğŸ Ãles',        cc:'#34d399'},
  {id:'mount',lb:'â›° Montagnes',   cc:'#fb923c'},
  {id:'wood', lb:'ğŸŒ² ForÃªts',      cc:'#4ade80'},
  {id:'lh',   lb:'ğŸ—¼ Phares',      cc:'#fbbf24'},
  {id:'site',  lb:'ğŸ“Œ Lieux-dits',  cc:'#f472b6'},
  {id:'beach', lb:'ğŸ– Plages',        cc:'#fcd34d'},
];
const FOV = 75, FOV2 = FOV/2;
const ALPHA = 0.6; // compass smoothing (higher = less lag)

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S = {
  lat:null, lng:null,
  hRaw:null, hSm:null, hOff:0,
  cSrc:null,
  gpsOk:false, gpsMan:false,
  allPOIs:[], pois:[],
  fetchLat:null, fetchLng:null,
  maxD:10000, band:false,  // band=false: montre de 0 Ã  maxD
  bandPct:0.20,            // Â±20% by default (e.g. 50km â†’ 40-60km)
  cat:'all',
  detPOI:null,
  centerPOI:null,          // POI closest to crosshair center
};
let lmap=null, lmk=null, pLat=null, pLng=null;
let cRelTimer=null;
const poiEls=new Map();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PERMISSIONS FLOW
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const permState = {cam:'wait', gps:'wait', cmp:'wait'};

function setPermRow(id, state){
  permState[id] = state;
  const row = document.getElementById('pr-'+id);
  const st  = document.getElementById('ps-'+id);
  if(!row||!st) return;
  row.classList.remove('ok','no');
  if(state==='ok'){row.classList.add('ok');st.className='perm-status ok';st.textContent='AUTORISÃ‰';}
  else if(state==='no'){row.classList.add('no');st.className='perm-status no';st.textContent='REFUSÃ‰';}
  else{st.className='perm-status wait';st.textContent='EN ATTENTE';}
}

async function requestAllPermissions(){
  const btn = document.getElementById('permask');
  btn.disabled = true; btn.textContent = 'Autorisation en coursâ€¦';

  // iOS : DeviceOrientationEvent.requestPermission DOIT Ãªtre appelÃ©
  // SYNCHRONIQUEMENT dans le handler de clic, avant tout await.
  let compassPromise = null;
  if(typeof DeviceOrientationEvent !== 'undefined' &&
     typeof DeviceOrientationEvent.requestPermission === 'function'){
    try{ compassPromise = DeviceOrientationEvent.requestPermission(); }
    catch(e){ compassPromise = Promise.resolve('denied'); }
  }

  // â”€â”€ CamÃ©ra â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(navigator.mediaDevices?.getUserMedia){
    try{
      const stream = await navigator.mediaDevices.getUserMedia(
        {video:{facingMode:{ideal:'environment'}},audio:false}
      );
      document.getElementById('cam').srcObject = stream;
      setPermRow('cam','ok');
    }catch(e){ setPermRow('cam','no'); }
  } else { setPermRow('cam','no'); }

  // â”€â”€ GPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // On tente mais on ne bloque PAS si Ã§a Ã©choue â€” position manuelle possible
  if(navigator.geolocation){
    await new Promise(resolve=>{
      navigator.geolocation.getCurrentPosition(
        pos=>{ onGPS(pos); setPermRow('gps','ok'); resolve(); },
        ()=>{
          // Fallback sans haute prÃ©cision
          navigator.geolocation.getCurrentPosition(
            pos2=>{ onGPS(pos2); setPermRow('gps','ok'); resolve(); },
            ()=>{ setPermRow('gps','no'); resolve(); },
            {enableHighAccuracy:false, timeout:8000, maximumAge:60000}
          );
        },
        {enableHighAccuracy:true, timeout:10000, maximumAge:30000}
      );
    });
  } else { setPermRow('gps','no'); }

  // â”€â”€ Boussole â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(compassPromise){
    try{
      const res = await compassPromise;
      if(res === 'granted'){
        window.addEventListener('deviceorientation', onOri, true);
        setPermRow('cmp','ok');
      } else { setPermRow('cmp','no'); }
    }catch(e){ setPermRow('cmp','no'); }
  } else {
    // Android/desktop : pas de permission requise
    window.addEventListener('deviceorientationabsolute', onOriAbs, true);
    window.addEventListener('deviceorientation', onOri, true);
    setPermRow('cmp','ok');
  }

  btn.disabled = false; btn.textContent = 'Autoriser les accÃ¨s';

  // On lance TOUJOURS â€” les perms manquantes sont gÃ©rÃ©es dans l'app
  _doLaunch();
}

// Lance l'app directement, ferme tous les Ã©crans d'accueil
function _doLaunch(){
  document.getElementById('permov').classList.add('gone');
  document.getElementById('deniedov').classList.remove('on');
  document.getElementById('startup').style.display = 'none';
  initApp();
}

function showDenied(msg){
  if(msg) document.getElementById('deniedmsg').textContent = msg;
  document.getElementById('deniedov').classList.add('on');
}
function hideDenied(){ _doLaunch(); }
function retryPermissions(){ document.getElementById('deniedov').classList.remove('on'); }
function launchWithoutPerms(){ _doLaunch(); }
// Alias pour compatibilitÃ©
function launchApp(){ _doLaunch(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT (appelÃ© aprÃ¨s permissions accordÃ©es)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initApp(){
  const btn = document.getElementById('stbtn');
  if(btn){ btn.disabled=true; btn.textContent='DÃ©marrageâ€¦'; }

  // Cache le startup
  const st = document.getElementById('startup');
  if(st){ st.style.transition='opacity .4s'; st.style.opacity='0'; setTimeout(()=>st.style.display='none',400); }

  // Affiche le bouton retour
  document.getElementById('backbtn').classList.add('on');

  buildFilters();
  renderLoop();

  // Popup GPS si la position n'est pas disponible aprÃ¨s 3 secondes
  setTimeout(()=>{
    if(!S.gpsOk && !S.gpsMan){
      document.getElementById('gpspopup').classList.add('on');
      // Auto-cacher aprÃ¨s 8 secondes
      setTimeout(()=>document.getElementById('gpspopup').classList.remove('on'), 8000);
    }
  }, 3000);

  // CamÃ©ra â€” dÃ©jÃ  dÃ©marrÃ©e si permission accordÃ©e, sinon tenter
  if(!document.getElementById('cam').srcObject){
    if(navigator.mediaDevices?.getUserMedia){
      navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}},audio:false})
        .then(s=>{document.getElementById('cam').srcObject=s; setPerm('cam','ok');})
        .catch(()=>setPerm('cam','no'));
    } else setPerm('cam','no');
  } else { setPerm('cam','ok'); }

  // GPS â€” watchPosition continue en arriÃ¨re-plan pour mise Ã  jour de position
  if(navigator.geolocation){
    navigator.geolocation.watchPosition(onGPS, onGPSErr,
      {enableHighAccuracy:true, maximumAge:5000, timeout:20000});
  }
  // Si GPS pas encore obtenu (ex: venu de launchWithoutPerms), tenter startGPS
  if(!S.gpsOk && permState.gps !== 'ok'){ startGPS(); }

  // Boussole Android â€” dÃ©jÃ  activÃ©e si requestAllPermissions a Ã©tÃ© appelÃ©
  // Si on arrive ici via le bouton DÃ©marrer direct (sans permission flow)
  if(permState.cmp === 'wait'){
    if(typeof DeviceOrientationEvent!=='undefined' &&
       typeof DeviceOrientationEvent.requestPermission==='function'){
      DeviceOrientationEvent.requestPermission()
        .then(p=>{
          if(p==='granted'){ window.addEventListener('deviceorientation',onOri,true); setPerm('cmp','ok'); }
          else setPerm('cmp','no');
        }).catch(()=>setPerm('cmp','no'));
    } else {
      window.addEventListener('deviceorientationabsolute',onOriAbs,true);
      window.addEventListener('deviceorientation',onOri,true);
      setPerm('cmp','ok');
    }
  }
}

function setPerm(id,s){
  const idMap={cam:'pcam',gps:'pgps',cmp:'pcmp'};
  const el=document.getElementById(idMap[id]);
  if(!el)return;
  el.classList.remove('ok','no');
  const st=el.querySelector('.pis');
  if(s==='ok'){el.classList.add('ok');st.textContent='OK';}
  else if(s==='no'){el.classList.add('no');st.textContent='REFUSÃ‰';}
  else st.textContent='EN ATTENTEâ€¦';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function startGPS(){
  if(navigator.permissions){
    try{
      const p=await navigator.permissions.query({name:'geolocation'});
      if(p.state==='denied'){setPerm('gps','no');showGPSHelp(1);setDot('err');gtxt('GPS refusÃ© Â· ğŸ“ position manuelle');return;}
    }catch(e){}
  }
  navigator.geolocation.getCurrentPosition(
    pos=>{onGPS(pos);setPerm('gps','ok');document.getElementById('ghelp').classList.remove('on');
      navigator.geolocation.watchPosition(onGPS,onGPSErr,{enableHighAccuracy:true,maximumAge:5000,timeout:20000});},
    err=>{setPerm('gps','no');showGPSHelp(err.code);setDot('err');gtxt(gpsmsg(err.code)+' Â· ğŸ“ tap');},
    {enableHighAccuracy:true,timeout:20000,maximumAge:0}
  );
}
function retryGPS(){document.getElementById('ghelp').classList.remove('on');setPerm('gps','wait');startGPS();}
function onGPS(pos){
  if(S.gpsMan)return;
  S.lat=pos.coords.latitude; S.lng=pos.coords.longitude; S.gpsOk=true;
  setDot('ok');
  const acc=Math.round(pos.coords.accuracy);
  gtxt(`${S.lat.toFixed(5)}, ${S.lng.toFixed(5)} Â±${acc}m`);
  document.getElementById('mmgps').disabled=false;
  const moved=S.fetchLat!=null?hav(S.lat,S.lng,S.fetchLat,S.fetchLng):Infinity;
  if(moved>150) fetchPOIs();
}
function onGPSErr(e){setDot('err');gtxt(gpsmsg(e.code));}
function gpsmsg(c){return{1:'GPS refusÃ©',2:'GPS indisponible',3:'DÃ©lai GPS'}[c]||'Erreur GPS';}
function setDot(s){const d=document.getElementById('sdot');d.classList.remove('ok','err','mn');d.classList.add(s);}
function gtxt(t){document.getElementById('gtxt').textContent=t;}

function showGPSHelp(c){
  const isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent);
  const isAnd=/Android/.test(navigator.userAgent);
  let m='';
  if(c===1||c==='denied'){
    if(isIOS) m='1. RÃ©glages â†’ ConfidentialitÃ© & SÃ©curitÃ©\n   â†’ Service de localisation â†’ Safari\n   â†’ Â« Lors de l\'utilisation Â»\n2. Reviens ici â†’ RÃ©essayer\n\nOu utilise la position manuelle ğŸ“';
    else if(isAnd) m='1. Tap sur ğŸ”’ dans la barre d\'adresse\n2. Autorisations â†’ Localisation â†’ Autoriser\n3. RÃ©essayer\n\nOu utilise la position manuelle ğŸ“';
    else m='Autorise la gÃ©olocalisation dans les\nparamÃ¨tres du navigateur, puis RÃ©essayer.\nOu utilise la position manuelle ğŸ“';
  } else if(c===2) m='GPS indisponible. VÃ©rifie que la\nlocalisation est activÃ©e sur l\'appareil.\nOu utilise la position manuelle ğŸ“';
  else if(c===3) m='DÃ©lai GPS dÃ©passÃ©. Va en extÃ©rieur\nsi possible, puis RÃ©essayer.\nOu utilise la position manuelle ğŸ“';
  else m='GPS non supportÃ©. Utilise la position manuelle ğŸ“';
  document.getElementById('ghelpb').textContent=m;
  document.getElementById('ghelp').classList.add('on');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMPASS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// COMPASS â€” prioritÃ© : iOS webkit â†’ absolute â†’ relatif
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Ordre de prioritÃ© des sources (plus Ã©levÃ© = meilleur)
const SRC_PRIORITY = {ios:3, abs:2, rel:1, null:0};

function onOriAbs(e){
  // deviceorientationabsolute : nord magnÃ©tique garanti
  if(e.alpha==null) return;
  const h = (360 - e.alpha + 360) % 360;
  // N'accepter que si meilleure ou Ã©gale Ã  la source actuelle
  if(SRC_PRIORITY['abs'] >= (SRC_PRIORITY[S.cSrc]||0)){
    updRaw(h);
    S.cSrc = 'abs';
    hideCWarn();
  }
}

function onOri(e){
  // â”€â”€ iOS : webkitCompassHeading â€” toujours prioritaire â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if(e.webkitCompassHeading != null && e.webkitCompassHeading >= 0){
    updRaw(e.webkitCompassHeading);
    S.cSrc = 'ios';
    hideCWarn();
    return;
  }
  // â”€â”€ Android : event.absolute=true Ã©quivaut Ã  deviceorientationabsolute â”€â”€
  if(e.absolute === true && e.alpha != null){
    const h = (360 - e.alpha + 360) % 360;
    if(SRC_PRIORITY['abs'] >= (SRC_PRIORITY[S.cSrc]||0)){
      updRaw(h);
      S.cSrc = 'abs';
      hideCWarn();
    }
    return;
  }
  // â”€â”€ Fallback relatif : uniquement si aucune source absolue disponible â”€â”€
  // (ne pas Ã©craser une source abs/ios avec un alpha non-rÃ©fÃ©rencÃ© nord)
  if(S.cSrc === 'abs' || S.cSrc === 'ios') return;
  if(e.alpha != null){
    updRaw((360 - e.alpha + 360) % 360);
    if(S.cSrc !== 'rel'){
      S.cSrc = 'rel';
      if(!cRelTimer) cRelTimer = setTimeout(()=>{
        if(S.cSrc === 'rel') document.getElementById('cwarn').style.display = 'block';
      }, 2000);
    }
  }
}

function updRaw(r){
  S.hRaw=r;
  if(S.hSm==null){S.hSm=r;return;}
  let d=r-S.hSm;
  if(d>180)d-=360; if(d<-180)d+=360;
  S.hSm=(S.hSm+ALPHA*d+360)%360;
}
function getH(){return S.hSm==null?null:(S.hSm+S.hOff+360)%360;}
function hideCWarn(){
  if(cRelTimer){clearTimeout(cRelTimer);cRelTimer=null;}
  document.getElementById('cwarn').style.display='none';
  document.getElementById('calw').classList.remove('on');
}
function toggleCal(){document.getElementById('calw').classList.toggle('on');}
function chOff(d){
  S.hOff=(S.hOff+d+360)%360;
  if(S.hOff>180)S.hOff-=360;
  document.getElementById('offd').textContent=(S.hOff>=0?'+':'')+S.hOff+'Â°';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILTERS BUILD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildFilters(){
  // Categories
  const cr=document.getElementById('cfrow'); cr.innerHTML='';
  CATS.forEach(c=>{
    const b=document.createElement('button');
    b.className='pill cpill'+(c.id===S.cat?' on':'');
    b.textContent=c.lb; b.style.setProperty('--cc',c.cc);
    b.onclick=()=>selCat(c.id);
    cr.appendChild(b);
  });
  // Distances
  const dr=document.getElementById('dfrow'); dr.innerHTML='';
  // Band width selector: strict or wide
  const bw=document.createElement('button');
  bw.className='pill on'; bw.id='bwpill';
  bw.textContent=S.bandPct===0.2?'Â±20%':'Â±10%';
  bw.title='Largeur de la fourchette de distance';
  bw.onclick=()=>{
    S.bandPct=S.bandPct===0.20?0.10:0.20;
    bw.textContent=S.bandPct===0.2?'Â±20%':'Â±10%';
    applyFilter();
  };
  dr.appendChild(bw);
  DISTS.forEach(d=>{
    const b=document.createElement('button');
    b.className='pill'+(d.v===S.maxD?' on':'');
    b.textContent=d.l;
    b.onclick=()=>{
      S.maxD=d.v;
      document.querySelectorAll('#dfrow .pill:not(#bwpill)').forEach((x,i)=>x.classList.toggle('on',DISTS[i].v===d.v));
      applyFilter();
    };
    dr.appendChild(b);
  });
}

function selCat(id){
  S.cat=id;
  document.querySelectorAll('.cpill').forEach((b,i)=>b.classList.toggle('on',CATS[i].id===id));
  applyFilter();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FILTER LOGIC
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function applyFilter(){
  // Band: for small distances (â‰¤2km) always show from 0
  // For larger: strict window around selected distance
  let dMin=0, dMax=S.maxD;
  if(S.band && S.maxD>2000){
    dMin = S.maxD*(1-S.bandPct);
    dMax = S.maxD*(1+S.bandPct);
  }

  const filtered=S.allPOIs.filter(p=>{
    if(p.dist<dMin||p.dist>dMax)return false;
    return S.cat==='all'||p.type.cat===S.cat;
  });

  // Max 25 POIs spread across the band (5 buckets Ã— 5)
  const bw=(dMax-dMin)/5;
  const buckets=[[],[],[],[],[]];
  filtered.forEach(p=>{
    const bi=Math.min(4,Math.floor((p.dist-dMin)/Math.max(bw,1)));
    if(buckets[bi].length<5) buckets[bi].push(p);
  });
  S.pois=buckets.flat();

  poiEls.forEach(e=>e.remove()); poiEls.clear();

  const rng=S.band&&S.maxD>2000
    ?`${fmt(dMin)} â€“ ${fmt(dMax)}`
    :`0 â€“ ${fmt(dMax)}`;
  document.getElementById('pcnt').textContent=
    `${S.pois.length} pts Â· ${rng}`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FETCH POIs â€” WikipÃ©dia (primaire) + Overpass allÃ©gÃ© (fallback)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Classifie un lieu d'aprÃ¨s son nom (pour WikipÃ©dia)
function classifyByName(name){
  const n=name.toLowerCase();
  if(/\bphare\b/.test(n))                                        return{emoji:'ğŸ—¼',label:'Phare',cat:'lh'};
  if(/\b(Ã®le|Ã®les|Ã®lot|ile |iles |ilot|island|atoll)/.test(n))  return{emoji:'ğŸï¸',label:'Ãle',cat:'isle'};
  if(/\b(mont|montagne|pic |sommet|volcan|puy |col |massif)/.test(n))return{emoji:'â›°ï¸',label:'Sommet',cat:'mount'};
  if(/(^cap |^cap-|\bcap\b|pointe |^raz |presqu.Ã®le|pÃ©ninsule|pointe-|headland)/.test(n))return{emoji:'ğŸ—ºï¸',label:'Cap / Pointe',cat:'coast'};
  if(/\b(baie|golfe|anse |rade |fjord)/.test(n))                 return{emoji:'ğŸŒŠ',label:'Baie',cat:'coast'};
  if(/\bdÃ©troit\b/.test(n))                                      return{emoji:'ã€°ï¸',label:'DÃ©troit',cat:'coast'};
  if(/\b(falaise|cliffs?)\b/.test(n))                            return{emoji:'ğŸª¨',label:'Falaise',cat:'coast'};
  if(/\b(forÃªt|bois |woods?|forest)/.test(n))                    return{emoji:'ğŸŒ²',label:'ForÃªt',cat:'wood'};
  if(/\b(plage|beach|spiaggia)/.test(n))                          return{emoji:'ğŸ–',label:'Plage',cat:'beach'};
  if(/\b(lieu-dit|lieudit|hameau|Ã©cart|lieu dit)/.test(n))       return{emoji:'ğŸ“Œ',label:'Lieu-dit',cat:'site'};
  return null; // inconnu â†’ sera classifiÃ© comme ville par dÃ©faut
}

// â”€â”€ Fetch helper avec timeout et log d'erreur â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function safeFetch(url, opts={}, timeoutMs=10000, label=''){
  const ctrl = new AbortController();
  const tid = setTimeout(()=>ctrl.abort(), timeoutMs);
  try{
    const r = await fetch(url, {...opts, signal:ctrl.signal});
    clearTimeout(tid);
    if(!r.ok){ showDbg(`âš  ${label} HTTP ${r.status}`); return null; }
    return await r.json();
  }catch(e){
    clearTimeout(tid);
    const reason = e.name==='AbortError'?'timeout':e.message||'erreur rÃ©seau';
    showDbg(`âš  ${label}: ${reason}`, 4000);
    return null;
  }
}

// Source 1 : Overpass â€” nodes "place" + natural (trÃ¨s prÃ©cis)
async function fetchOverpassLight(lat,lng,radiusM){
  const r = Math.min(radiusM*1.5, 100000);
  const q = `[out:json][timeout:20];(
node["place"~"^(city|town|village|hamlet|suburb|island|islet|locality)$"](around:${r},${lat},${lng});
node["natural"~"^(peak|volcano|cape|bay|beach|cliff)$"]["name"](around:${r},${lat},${lng});
node["man_made"="lighthouse"]["name"](around:${r},${lat},${lng});
);out 600;`;
  const APIS = [
    'https://overpass-api.de/api/interpreter',
    'https://overpass.kumi.systems/api/interpreter',
    'https://maps.mail.ru/osm/tools/overpass/api/interpreter'
  ];
  for(const api of APIS){
    showDbg(`â³ OSM: ${api.split('/')[2]}â€¦`);
    const data = await safeFetch(api, {method:'POST', body:q}, 22000, 'Overpass');
    if(data?.elements?.length){ showDbg(`âœ“ OSM: ${data.elements.length} Ã©lÃ©ments`); return data.elements; }
  }
  showDbg('âš  Overpass indisponible');
  return [];
}

// Source 2 : WikipÃ©dia GeoSearch (FR puis EN)
async function fetchWikipedia(lat,lng,radiusM){
  const WR = 10000;
  const seen = new Set(); const items = [];

  function anchorPoints(cLat,cLng,totalR){
    const pts=[{lat:cLat,lng:cLng}];
    if(totalR<=WR) return pts;
    const step=0.125;
    const cols=Math.ceil(totalR/1000/14);
    for(let dx=-cols;dx<=cols;dx++)
      for(let dy=-cols;dy<=cols;dy++){
        if(dx===0&&dy===0) continue;
        const aLat=cLat+dy*step;
        const aLng=cLng+dx*step/Math.cos(cLat*Math.PI/180);
        if(hav(cLat,cLng,aLat,aLng)<totalR) pts.push({lat:aLat,lng:aLng});
      }
    return pts.slice(0,9);
  }

  for(const lang of ['fr','en']){
    const anchors = anchorPoints(lat,lng,radiusM);
    showDbg(`â³ Wikipedia ${lang} (${anchors.length} zones)â€¦`);
    const fetches = anchors.map(a=>{
      const url=`https://${lang}.wikipedia.org/w/api.php?action=query&list=geosearch`+
        `&gsradius=${WR}&gslatitude=${a.lat}&gslongitude=${a.lng}&gslimit=500`+
        `&format=json&origin=*`;
      return safeFetch(url, {}, 12000, `Wiki-${lang}`);
    });
    const results = await Promise.all(fetches);
    let added=0;
    for(const data of results){
      for(const p of data?.query?.geosearch||[]){
        if(seen.has(p.pageid)) continue;
        seen.add(p.pageid);
        const realDist=hav(lat,lng,p.lat,p.lon);
        if(realDist>radiusM*1.1) continue;
        items.push({name:p.title,lat:p.lat,lng:p.lon,dist:realDist});
        added++;
      }
    }
    if(added>0){ showDbg(`âœ“ Wiki-${lang}: ${added} lieux`); break; }
    showDbg(`âš  Wiki-${lang}: 0 rÃ©sultats, essai suivantâ€¦`);
  }
  return items;
}

// Source 3 : Nominatim (OpenStreetMap geocoder) â€” fallback trÃ¨s fiable
async function fetchNominatim(lat,lng,radiusM){
  // Nominatim search dans une bounding box
  const deg = radiusM/111000;
  const bbox = `${lng-deg},${lat-deg},${lng+deg},${lat+deg}`;
  const url = `https://nominatim.openstreetmap.org/search`+
    `?format=json&limit=200&bounded=1&viewbox=${bbox}`+
    `&featuretype=settlement&accept-language=fr`;
  showDbg('â³ Nominatimâ€¦');
  const data = await safeFetch(url, {headers:{'User-Agent':'HorizonAR/1.0'}}, 12000, 'Nominatim');
  if(!data?.length){ showDbg('âš  Nominatim: 0 rÃ©sultats'); return []; }
  showDbg(`âœ“ Nominatim: ${data.length} lieux`);
  return data.filter(e=>e.lat&&e.lon&&e.display_name).map(e=>({
    name: e.name || e.display_name.split(',')[0],
    lat: parseFloat(e.lat), lng: parseFloat(e.lon),
    dist: hav(lat,lng,parseFloat(e.lat),parseFloat(e.lon)),
    tags: {place: e.type||e.class}
  }));
}

async function fetchPOIs(){
  if(!S.lat) return;
  showDbg('ğŸ” Recherche POIsâ€¦', 60000);
  document.getElementById('ldr').classList.add('on');
  const lat=S.lat, lng=S.lng;
  const radiusM=Math.min(100000, Math.max(5000, S.maxD*1.5));

  // Lancer Overpass + Wikipedia en parallÃ¨le
  const [ovItems, wikiItems] = await Promise.all([
    fetchOverpassLight(lat, lng, radiusM),
    fetchWikipedia(lat, lng, radiusM)
  ]);

  // Fallback Nominatim si les deux sources principales sont vides
  let nomItems = [];
  if(!ovItems.length && !wikiItems.length){
    nomItems = await fetchNominatim(lat, lng, radiusM);
  }

  document.getElementById('ldr').classList.remove('on');

  const total = wikiItems.length + ovItems.length + nomItems.length;
  if(!total){
    showDbg('âŒ Aucune source disponible â€“ rÃ©seau ou APIs inaccessibles', 8000);
    return;
  }
  showDbg(`âœ“ OSM:${ovItems.length} Wiki:${wikiItems.length} Nom:${nomItems.length}`);
  processPOIs(wikiItems, [...ovItems, ...nomItems], lat, lng);
  S.fetchLat=lat; S.fetchLng=lng;
}

function processPOIs(wikiItems, ovEls, ulat, ulng){
  const seen=new Set(), res=[];

  // Traiter les donnÃ©es Overpass (ground truth : tags OSM prÃ©cis)
  for(const el of ovEls){
    const eLat=el.lat??el.center?.lat;
    const eLng=el.lon??el.center?.lon;
    if(!eLat||!eLng) continue;
    const name=el.tags?.name||el.tags?.['name:fr'];
    if(!name) continue;
    const key=name.toLowerCase().trim();
    if(seen.has(key)) continue;
    seen.add(key);
    const dist=hav(ulat,ulng,eLat,eLng);
    if(dist<30) continue;
    res.push({name,lat:eLat,lng:eLng,dist,bearing:brg(ulat,ulng,eLat,eLng),type:classifyOSM(el.tags,name)});
  }

  // ComplÃ©ter avec WikipÃ©dia (lieux non dÃ©jÃ  prÃ©sents via Overpass)
  for(const w of wikiItems){
    const key=w.name.toLowerCase().trim();
    if(seen.has(key)) continue;
    seen.add(key);
    const dist=hav(ulat,ulng,w.lat,w.lng);
    if(dist<30) continue;
    const typeGuess=classifyByName(w.name);
    const type=typeGuess||{emoji:'ğŸ™ï¸',label:'Ville',cat:'city'};
    res.push({name:w.name,lat:w.lat,lng:w.lng,dist,bearing:brg(ulat,ulng,w.lat,w.lng),type});
  }

  res.sort((a,b)=>a.dist-b.dist);
  S.allPOIs=res;
  showDbg(`âœ“ ${res.length} POIs traitÃ©s`);
  applyFilter();
}

// Classifie via tags OSM (source Overpass)
function classifyOSM(t,name){
  if(!t)return{emoji:'ğŸ“',label:'Lieu',cat:'all'};
  const p=t.place,n=t.natural,m=t.man_made,lu=t.landuse;
  const nm=(name||'').toLowerCase();
  if(n==='wood'||lu==='forest')return{emoji:'ğŸŒ²',label:'ForÃªt',cat:'wood'};
  if(m==='lighthouse')return{emoji:'ğŸ—¼',label:'Phare',cat:'lh'};
  if(p==='island'||p==='islet')return{emoji:'ğŸï¸',label:'Ãle',cat:'isle'};
  if(n==='peak'||n==='volcano')return{emoji:'â›°ï¸',label:'Sommet',cat:'mount'};
  if(n==='cape'||n==='peninsula'||n==='headland'||
     nm.startsWith('pointe')||nm.startsWith('cap ')||nm.startsWith('cap-')||
     nm.includes("presqu'Ã®le"))
    return{emoji:'ğŸ—ºï¸',label:'Cap / Pointe',cat:'coast'};
  if(n==='bay')return{emoji:'ğŸŒŠ',label:'Baie',cat:'coast'};
  if(n==='strait')return{emoji:'ã€°ï¸',label:'DÃ©troit',cat:'coast'};
  if(n==='cliff')return{emoji:'ğŸª¨',label:'Falaise',cat:'coast'};
  if(p==='city')return{emoji:'ğŸ™ï¸',label:'Ville',cat:'city'};
  if(p==='town')return{emoji:'ğŸ˜ï¸',label:'Bourg',cat:'city'};
  if(p==='village'||p==='hamlet'||p==='suburb')return{emoji:'ğŸ¡',label:'Village',cat:'city'};
  if(p==='locality'||p==='isolated_dwelling')return{emoji:'ğŸ“Œ',label:'Lieu-dit',cat:'site'};
  if(n==='beach'||t?.leisure==='beach_resort'||t?.tourism==='beach')return{emoji:'ğŸ–',label:'Plage',cat:'beach'};
  return{emoji:'ğŸ“',label:'Lieu',cat:'all'};
}

// Alias pour compatibilitÃ© (classify reste utilisÃ© nulle part mais on garde)
function classify(t,n){return classifyOSM(t,n);}

function doRefresh(){
  S.fetchLat=null;
  if(S.gpsOk) fetchPOIs();
  else showDbg('ğŸ“ Position non dÃ©finie â€” utilise la carte');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAP MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openMap(){
  document.getElementById('mmap').classList.add('on');
  // Enable GPS button if we have coords
  document.getElementById('mmgps').disabled=!S.gpsOk;
  setTimeout(()=>{
    if(!lmap){
      const initLat=S.lat||48.0, initLng=S.lng||-2.0;
      lmap=L.map('lmap',{zoomControl:true}).setView([initLat,initLng],S.gpsOk?12:6);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
        attribution:'Â© OpenStreetMap',maxZoom:19
      }).addTo(lmap);

      lmap.on('click',e=>{
        pLat=e.latlng.lat; pLng=e.latlng.lng;
        setMapMarker(pLat,pLng);
        document.getElementById('mmok').disabled=false;
      });
    } else {
      lmap.invalidateSize();
    }
    // If we have a position, show it
    if(S.lat&&!lmk){
      setMapMarker(S.lat,S.lng);
      pLat=S.lat; pLng=S.lng;
      document.getElementById('mmok').disabled=false;
    }
  },120);
}

function setMapMarker(lat,lng){
  if(lmk){lmk.setLatLng([lat,lng]);}
  else{
    lmk=L.marker([lat,lng],{draggable:true}).addTo(lmap);
    lmk.on('dragend',e=>{
      const ll=e.target.getLatLng();
      pLat=ll.lat; pLng=ll.lng;
      document.getElementById('mmc').textContent=`${pLat.toFixed(5)}, ${pLng.toFixed(5)}`;
    });
  }
  document.getElementById('mmc').textContent=`${lat.toFixed(5)}, ${lng.toFixed(5)}`;
  if(lmap) lmap.setView([lat,lng],Math.max(lmap.getZoom(),10));
}

function useGPSPos(){
  if(!S.lat)return;
  pLat=S.lat; pLng=S.lng;
  setMapMarker(pLat,pLng);
  document.getElementById('mmok').disabled=false;
}

function closeMap(){
  document.getElementById('mmap').classList.remove('on');
}

function confirmPos(){
  if(pLat==null)return;
  S.lat=pLat; S.lng=pLng; S.gpsOk=true; S.gpsMan=true;
  setDot('mn');
  gtxt(`ğŸ“ Manuel : ${S.lat.toFixed(4)}, ${S.lng.toFixed(4)}`);
  closeMap();
  // Recalculate all POI distances from new position
  S.allPOIs.forEach(p=>{
    p.dist=hav(S.lat,S.lng,p.lat,p.lng);
    p.bearing=brg(S.lat,S.lng,p.lat,p.lng);
  });
  S.allPOIs.sort((a,b)=>a.dist-b.dist);
  S.fetchLat=null;
  fetchPOIs();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER LOOP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const CPS=[
  {d:0,l:'N'},{d:22.5,l:'NNE'},{d:45,l:'NE'},{d:67.5,l:'ENE'},
  {d:90,l:'E'},{d:112.5,l:'ESE'},{d:135,l:'SE'},{d:157.5,l:'SSE'},
  {d:180,l:'S'},{d:202.5,l:'SSO'},{d:225,l:'SO'},{d:247.5,l:'OSO'},
  {d:270,l:'O'},{d:292.5,l:'ONO'},{d:315,l:'NO'},{d:337.5,l:'NNO'},
];
let cpBuilt=false;
const TOPS=[28,35,42,22,48];

function renderLoop(){
  const h=getH();
  if(!cpBuilt){
    const tr=document.getElementById('ctrack');
    CPS.forEach(p=>{
      const e=document.createElement('div');
      e.className='clbl'+([0,90,180,270].includes(p.d)?' card':'');
      e.textContent=p.l; e.dataset.d=p.d;
      tr.appendChild(e);
    });
    cpBuilt=true;
  }
  if(h!==null){
    const W=document.getElementById('ctrack').offsetWidth;
    document.querySelectorAll('.clbl').forEach(e=>{
      const df=ndeg(parseFloat(e.dataset.d)-h);
      let x=W/2+df/FOV*W;

      if(x<0)x=0;
      if(x>W)x=W;
      if(x<-40||x>W+40){e.style.display='none';return;}
      e.style.display=''; e.style.left=x+'px';
      e.style.opacity=Math.max(0,1-Math.abs(df)/FOV2*.8);
    });
    const hi=Math.round(h);
    const srcLabel={'ios':'ğŸ§­','abs':'ğŸ§­','rel':'âš ï¸',null:'?'}[S.cSrc]||'?';
    const poiVis=poiEls.size;
    document.getElementById('hdg').textContent=`${hi.toString().padStart(3,'0')}Â° ${card(hi)} ${srcLabel}${poiVis?' Â· '+poiVis+'â†‘':''}`;
    if(S.pois.length) updPOIs(h);
  } else if(S.pois.length) {
    // Pas de boussole : afficher les POIs triÃ©s par distance
    updPOIs(null);
  }
  requestAnimationFrame(renderLoop);
}

function updPOIs(h){
  const W=document.getElementById('ctrack').offsetWidth;
  const vis=[];
  let bestDf=Infinity, bestPOI=null;  // FIX: was undefined â†’ ReferenceError
  // If no compass, show all POIs centered (sorted by distance)
  const useHeading = h !== null;
  const effectiveH = useHeading ? h : 0;
  for(const p of S.pois){
    const df = useHeading ? ndeg(p.bearing - effectiveH) : 0;
    if(useHeading && Math.abs(df)>FOV2*1.2) continue;
    vis.push({p, df});
  }
  // Remove POIs that left the FOV (safe iteration)
  const _toRm=[];
  for(const[n]of poiEls){ if(!vis.find(v=>v.p.name===n)) _toRm.push(n); }
  _toRm.forEach(n=>{ poiEls.get(n).remove(); poiEls.delete(n); });
  for(const{p,df}of vis){
    let e=poiEls.get(p.name);
    if(!e){e=buildPOI(p);document.getElementById('poic').appendChild(e);poiEls.set(p.name,e);}
    // position:fixed â†’ coordonnÃ©es VIEWPORT directes, recalculÃ©es chaque frame
   let xPx  = W / 2 + (df / FOV2) * (W / 2);

    if(xPx < 0) xPx = 0;
    if(xPx > W) xPx = W;
    const topPx = (parseFloat(e.dataset.topPct) / 100) * window.innerHeight;
    e.style.left = xPx  + 'px';
    e.style.top  = topPx + 'px';
    const a=Math.abs(df);
    e.dataset.f=a>FOV2*.7?3:a>FOV2*.4?2:1;
    const ch=Math.max(18,Math.round(55*(1-Math.min(p.dist/S.maxD,1))));
    e.querySelector('.poc').style.height=ch+'px';
    if(a<bestDf&&a<12){bestDf=a;bestPOI=p;}
  }
  // Center badge â€” "what's in front of me"
  const badge=document.getElementById('cfocus');
  if(bestPOI){
    document.getElementById('cfn').textContent=bestPOI.name;
    document.getElementById('cfd').textContent=fmt(bestPOI.dist);
    document.getElementById('cft').textContent=bestPOI.type.label.toUpperCase()+' Â· '+Math.round(bestPOI.bearing)+'Â° '+card(bestPOI.bearing);
    badge.classList.add('on');
  } else {
    badge.classList.remove('on');
  }
}

function buildPOI(p){
  const e=document.createElement('div');
  e.className='poi';
  const hash=p.name.split('').reduce((a,c)=>a+c.charCodeAt(0),0);
  e.dataset.topPct = TOPS[hash % TOPS.length];
  // Initialiser left/top pour Ã©viter un flash au premier frame
  e.style.left = '-9999px';
  e.style.top  = '50%';
  e.innerHTML=`<div class="poc" style="height:40px"></div>
<div class="pob">
  <span class="pii">${p.type.emoji}</span>
  <div class="pin">${p.name}</div>
  <div class="pid">${fmt(p.dist)}</div>
</div>`;
  e.addEventListener('click',()=>openDet(p));
  return e;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DETAIL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openDet(p){
  S.detPOI=p;
  document.getElementById('deti').textContent=p.type.emoji;
  document.getElementById('detn').textContent=p.name;
  document.getElementById('dett').textContent=p.type.label.toUpperCase();
  document.getElementById('dmd').textContent=fmt(p.dist);
  document.getElementById('dmb').textContent=Math.round(p.bearing)+'Â° '+card(p.bearing);
  document.getElementById('dmxy').textContent=p.lat.toFixed(4)+', '+p.lng.toFixed(4);
  // Reset info panel
  document.getElementById('detinfo').classList.remove('on');
  document.getElementById('binfo').classList.remove('active');
  document.getElementById('infoloading').classList.remove('on');
  document.getElementById('infoerr').classList.remove('on');
  document.getElementById('infoimgw').classList.remove('on');
  document.getElementById('infoext').textContent='';
  document.getElementById('infowlink').href='#';
  document.getElementById('det').classList.add('on');
}
function closeDet(){document.getElementById('det').classList.remove('on');}
function goGMaps(){
  const p=S.detPOI;if(!p)return;
  window.open(`https://www.google.com/maps/dir/?api=1&origin=${S.lat},${S.lng}&destination=${p.lat},${p.lng}&travelmode=driving`,'_blank');
}

// â”€â”€â”€ INFO PANEL (Wikipedia) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleInfo(){
  const panel=document.getElementById('detinfo');
  const btn=document.getElementById('binfo');
  const isOpen=panel.classList.contains('on');
  if(isOpen){panel.classList.remove('on');btn.classList.remove('active');return;}
  panel.classList.add('on');
  btn.classList.add('active');
  loadWikiInfo(S.detPOI);
}

async function loadWikiInfo(p){
  if(!p) return;
  const loading=document.getElementById('infoloading');
  const err=document.getElementById('infoerr');
  const imgw=document.getElementById('infoimgw');
  const ext=document.getElementById('infoext');
  const wlink=document.getElementById('infowlink');
  // Reset
  loading.classList.add('on'); err.classList.remove('on');
  imgw.classList.remove('on'); ext.textContent='';
  // Try FR then EN
  const langs=['fr','en'];
  let found=false;
  for(const lang of langs){
    const url=`https://${lang}.wikipedia.org/w/api.php?action=query`+
      `&titles=${encodeURIComponent(p.name)}`+
      `&prop=extracts|pageimages|info`+
      `&exintro=1&explaintext=1&exsentences=6`+
      `&piprop=thumbnail&pithumbsize=600`+
      `&inprop=url&format=json&origin=*`;
    try{
      const ctrl=new AbortController();
      setTimeout(()=>ctrl.abort(),9000);
      const data=await fetch(url,{signal:ctrl.signal}).then(r=>r.json());
      const pages=data?.query?.pages||{};
      const page=Object.values(pages)[0];
      if(!page||page.missing!=null) continue;
      loading.classList.remove('on');
      found=true;
      // Image
      if(page.thumbnail?.source){
        document.getElementById('infoimg').src=page.thumbnail.source;
        imgw.classList.add('on');
      }
      // Extract
      const rawExt=(page.extract||'').trim();
      if(rawExt) ext.textContent=rawExt;
      else ext.textContent='Aucune description disponible.';
      // Link
      const pageUrl=page.fullurl||`https://${lang}.wikipedia.org/wiki/${encodeURIComponent(p.name)}`;
      wlink.href=pageUrl;
      break;
    }catch(e){}
  }
  loading.classList.remove('on');
  if(!found){
    err.textContent='Aucune information trouvÃ©e sur WikipÃ©dia.';
    err.classList.add('on');
    ext.textContent='';
  }
}

// â”€â”€â”€ STATS OVERLAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openStats(){
  const box=document.getElementById('statslist');
  const tot=document.getElementById('stattot');
  const allP=S.allPOIs;
  if(!allP.length){
    tot.textContent='Aucun POI chargÃ©.';
    box.innerHTML='';
    document.getElementById('statsov').classList.add('on');
    return;
  }
  // Count by category
  const counts={};
  allP.forEach(p=>{
    const k=p.type.cat;
    if(!counts[k]) counts[k]={cat:p.type.cat,emoji:p.type.emoji,label:p.type.label,n:0};
    counts[k].n++;
  });
  const rows=Object.values(counts).sort((a,b)=>b.n-a.n);
  const maxN=rows[0]?.n||1;
  tot.textContent=`${allP.length} POI total Â· ${S.pois.length} affichÃ©s (filtre actif)`;
  box.innerHTML='';
  rows.forEach(r=>{
    const barW=Math.round((r.n/maxN)*80);
    const div=document.createElement('div');
    div.className='statrow';
    div.innerHTML=`<span class="statei">${r.emoji}</span>`+
      `<span class="statn">${r.label}</span>`+
      `<span class="statb"><span class="statbar" style="width:${barW}px"></span>`+
      `<span class="statcnt">${r.n}</span></span>`;
    box.appendChild(div);
  });
  document.getElementById('statsov').classList.add('on');
}
function closeStats(){document.getElementById('statsov').classList.remove('on');}
// loadNearby removed â€” replaced by loadWikiInfo

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MENU / QUIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goMenu(){
  const s=document.getElementById('startup');
  s.style.display='flex'; s.style.opacity='0'; s.style.transition='opacity .3s';
  const b=document.getElementById('stbtn');b.disabled=false;b.textContent='â†© Reprendre';
  requestAnimationFrame(()=>s.style.opacity='1');
  // Hide back button while in menu
  document.getElementById('backbtn').classList.remove('on');
}
function showQuit(){document.getElementById('qov').classList.add('on');}
function hideQuit(){document.getElementById('qov').classList.remove('on');}
function quitApp(){
  const v=document.getElementById('cam');
  if(v.srcObject){v.srcObject.getTracks().forEach(t=>t.stop());v.srcObject=null;}
  window.close();
  setTimeout(()=>{
    document.body.innerHTML='<div style="display:flex;align-items:center;justify-content:center;height:100dvh;background:#020d1a;font-family:Syne,sans-serif;color:#e0f4ff;flex-direction:column;gap:10px"><div style="font-size:32px;font-weight:800">HORIZON</div><div style="font-family:monospace;font-size:11px;color:rgba(180,220,240,.5)">Fermez cet onglet</div></div>';
  },200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DEBUG TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let dbgTimer=null;
function showDbg(msg,dur=3000){
  const el=document.getElementById('dbg');
  el.textContent=msg; el.style.display='block';
  if(dbgTimer)clearTimeout(dbgTimer);
  dbgTimer=setTimeout(()=>el.style.display='none',dur);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GEO UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function hav(a,b,c,d){
  const R=6371000,da=(c-a)*Math.PI/180,db=(d-b)*Math.PI/180;
  const x=Math.sin(da/2)**2+Math.cos(a*Math.PI/180)*Math.cos(c*Math.PI/180)*Math.sin(db/2)**2;
  return R*2*Math.atan2(Math.sqrt(x),Math.sqrt(1-x));
}
function brg(a,b,c,d){
  const f1=a*Math.PI/180,f2=c*Math.PI/180,dl=(d-b)*Math.PI/180;
  return(Math.atan2(Math.sin(dl)*Math.cos(f2),Math.cos(f1)*Math.sin(f2)-Math.sin(f1)*Math.cos(f2)*Math.cos(dl))*180/Math.PI+360)%360;
}
function ndeg(d){d=((d%360)+360)%360;return d>180?d-360:d;}
function card(g){return['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSO','SO','OSO','O','ONO','NO','NNO'][Math.round(g/22.5)%16];}
function fmt(m){return m<1000?Math.round(m)+' m':(m/1000).toFixed(m<10000?1:0)+' km';}

window.addEventListener('resize',()=>{poiEls.forEach(e=>e.remove());poiEls.clear();});
</script>
</body>
</html>
