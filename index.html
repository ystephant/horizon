<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="theme-color" content="#020d1a" />
  <title>Horizon ‚Äî Ce qui est devant vous</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --cyan: #00e5ff;
      --cyan-dim: rgba(0,229,255,0.15);
      --cyan-border: rgba(0,229,255,0.35);
      --gold: #fbbf24;
      --bg: #020d1a;
      --surface: rgba(2,18,34,0.88);
      --text: #e0f4ff;
      --muted: rgba(180,220,240,0.5);
      --red: #ff4d6d;
      --green: #22d3a0;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Syne', sans-serif;
      overflow: hidden;
      height: 100dvh;
      width: 100dvw;
      user-select: none;
    }

    /* ‚îÄ‚îÄ CAMERA ‚îÄ‚îÄ */
    #camera-feed {
      position: fixed; inset: 0;
      width: 100%; height: 100%;
      object-fit: cover; z-index: 0;
    }

    /* ‚îÄ‚îÄ AR OVERLAY ‚îÄ‚îÄ */
    #ar-overlay {
      position: fixed; inset: 0;
      z-index: 10; pointer-events: none;
    }

    .vignette {
      position: fixed; inset: 0; z-index: 5;
      background: radial-gradient(ellipse at center, transparent 45%, rgba(2,13,26,0.65) 100%);
      pointer-events: none;
    }

    .horizon-line {
      position: absolute; left: 0; right: 0; top: 50%;
      height: 1px;
      background: linear-gradient(to right, transparent, var(--cyan-border), transparent);
      transform: translateY(-50%);
    }

    .grid-line-h, .grid-line-v {
      position: absolute; background: rgba(0,229,255,0.04); pointer-events: none;
    }
    .grid-line-h { left: 0; right: 0; height: 1px; top: 33%; }
    .grid-line-h:nth-child(2) { top: 66%; }
    .grid-line-v { top: 0; bottom: 0; width: 1px; left: 33%; }
    .grid-line-v:nth-child(4) { left: 66%; }

    .crosshair-h {
      position: absolute; top: 50%; left: calc(50% - 20px);
      width: 40px; height: 1px;
      background: rgba(0,229,255,0.35); transform: translateY(-50%);
    }
    .crosshair-v {
      position: absolute; left: 50%; top: calc(50% - 20px);
      width: 1px; height: 40px;
      background: rgba(0,229,255,0.35); transform: translateX(-50%);
    }

    /* ‚îÄ‚îÄ COMPASS BAR ‚îÄ‚îÄ */
    #compass-bar {
      position: fixed; top: 0; left: 0; right: 0;
      z-index: 20; height: 52px;
      background: linear-gradient(to bottom, rgba(2,13,26,0.92), transparent);
      pointer-events: none; overflow: hidden;
    }
    #compass-track {
      position: relative; width: 100%; height: 52px;
      display: flex; align-items: center; overflow: hidden;
    }
    .compass-label {
      position: absolute; top: 50%;
      transform: translateX(-50%) translateY(-50%);
      font-family: 'Space Mono', monospace;
      font-size: 10px; color: var(--muted); letter-spacing: 0.05em;
    }
    .compass-label.cardinal { font-size: 12px; font-weight: 700; color: var(--cyan); }
    #compass-center {
      position: absolute; left: 50%; top: 0; bottom: 0;
      width: 1px; background: var(--cyan);
      transform: translateX(-50%); z-index: 2;
    }
    #compass-center::before {
      content: ''; position: absolute; bottom: 0; left: 50%;
      transform: translateX(-50%);
      width: 5px; height: 5px; background: var(--cyan); border-radius: 50%;
    }

    /* ‚îÄ‚îÄ HEADING ‚îÄ‚îÄ */
    #heading-display {
      position: fixed; top: 56px; left: 50%; transform: translateX(-50%);
      z-index: 20;
      font-family: 'Space Mono', monospace; font-size: 13px;
      color: var(--cyan); background: var(--surface);
      border: 1px solid var(--cyan-border); border-radius: 20px;
      padding: 4px 14px; letter-spacing: 0.1em;
      backdrop-filter: blur(10px); pointer-events: none;
    }

    /* ‚îÄ‚îÄ POI LABELS ‚îÄ‚îÄ */
    .poi-label {
      position: absolute;
      transform: translateX(-50%) translateY(-50%);
      display: flex; flex-direction: column; align-items: center;
      pointer-events: auto; cursor: pointer;
      transition: opacity 0.35s;
    }
    .poi-connector {
      width: 1px; height: 36px;
      background: linear-gradient(to bottom, var(--cyan-border), transparent);
      margin-bottom: 4px;
    }
    .poi-card {
      background: var(--surface);
      border: 1px solid var(--cyan-border);
      border-radius: 10px; padding: 7px 11px;
      backdrop-filter: blur(14px);
      min-width: 85px; max-width: 130px;
      text-align: center; transition: border-color 0.15s;
    }
    .poi-label:active .poi-card { border-color: var(--cyan); }
    .poi-type-icon { font-size: 13px; margin-bottom: 2px; display: block; }
    .poi-name {
      font-family: 'Syne', sans-serif; font-weight: 600;
      font-size: 11px; color: var(--text); line-height: 1.25;
    }
    .poi-distance {
      font-family: 'Space Mono', monospace; font-size: 9px;
      color: var(--cyan); margin-top: 3px; letter-spacing: 0.06em;
    }
    .poi-label[data-fade="1"] { opacity: 0.9; }
    .poi-label[data-fade="2"] { opacity: 0.6; }
    .poi-label[data-fade="3"] { opacity: 0.3; }

    /* ‚îÄ‚îÄ FILTER BARS ‚îÄ‚îÄ */
    #filter-wrap {
      position: fixed;
      bottom: 52px; left: 0; right: 0;
      z-index: 21;
      display: flex; flex-direction: column; gap: 4px;
      padding-bottom: 4px;
      pointer-events: auto;
    }
    .filter-row {
      display: flex; gap: 5px;
      overflow-x: auto; -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      padding: 0 12px;
    }
    .filter-row::-webkit-scrollbar { display: none; }

    /* Category row background */
    #cat-filter-row { padding-top: 5px; }

    /* Distance row */
    #dist-filter-row {
      background: linear-gradient(to top, rgba(2,13,26,0.75), transparent);
      padding-top: 2px; padding-bottom: 3px;
    }

    .dist-pill, .cat-pill {
      flex-shrink: 0;
      font-family: 'Space Mono', monospace; font-size: 10px;
      letter-spacing: 0.04em;
      padding: 4px 10px; border-radius: 20px;
      border: 1px solid rgba(0,229,255,0.18);
      background: rgba(2,13,26,0.55);
      color: var(--muted); cursor: pointer;
      backdrop-filter: blur(8px);
      transition: all 0.15s;
    }
    .dist-pill:active, .cat-pill:active { transform: scale(0.93); }
    .dist-pill.active {
      border-color: var(--cyan);
      background: var(--cyan-dim);
      color: var(--cyan);
    }
    .cat-pill.active {
      border-color: var(--cat-color, var(--cyan));
      background: color-mix(in srgb, var(--cat-color, var(--cyan)) 15%, transparent);
      color: var(--cat-color, var(--cyan));
    }

    /* ‚îÄ‚îÄ DETAIL ACTION BUTTONS ‚îÄ‚îÄ */
    #detail-actions {
      display: flex; gap: 8px; margin-top: 14px; flex-wrap: wrap;
    }
    .detail-btn {
      flex: 1; min-width: 100px;
      font-family: 'Syne', sans-serif; font-size: 12px; font-weight: 700;
      border-radius: 10px; padding: 9px 10px; cursor: pointer;
      text-align: center; transition: opacity 0.15s; border: none;
      display: flex; align-items: center; justify-content: center; gap: 6px;
    }
    .detail-btn:active { opacity: 0.75; }
    #btn-gmaps {
      background: #1a73e8; color: white;
    }
    #btn-poi {
      background: var(--cyan-dim); color: var(--cyan);
      border: 1px solid var(--cyan-border);
    }

    /* ‚îÄ‚îÄ NEARBY POIs LOADER ‚îÄ‚îÄ */
    #nearby-list {
      margin-top: 12px; display: none;
    }
    #nearby-list.visible { display: block; }
    #nearby-title {
      font-family: 'Space Mono', monospace; font-size: 9px;
      color: var(--muted); letter-spacing: 0.08em; text-transform: uppercase;
      margin-bottom: 8px;
    }
    #nearby-items {
      display: flex; flex-direction: column; gap: 5px;
      max-height: 160px; overflow-y: auto;
    }
    .nearby-item {
      display: flex; align-items: center; gap: 8px;
      padding: 7px 10px; border-radius: 8px;
      background: rgba(0,229,255,0.05);
      border: 1px solid rgba(0,229,255,0.1);
      cursor: pointer; transition: background 0.15s;
    }
    .nearby-item:active { background: rgba(0,229,255,0.12); }
    .nearby-item-icon { font-size: 14px; flex-shrink: 0; }
    .nearby-item-name {
      font-size: 12px; font-weight: 600; color: var(--text); flex: 1;
    }
    .nearby-item-type {
      font-family: 'Space Mono', monospace; font-size: 9px; color: var(--muted);
    }

    /* ‚îÄ‚îÄ BOTTOM HUD ‚îÄ‚îÄ */
    #bottom-hud {
      position: fixed; bottom: 0; left: 0; right: 0;
      z-index: 20; padding: 6px 14px;
      padding-bottom: max(6px, env(safe-area-inset-bottom));
      background: rgba(2,13,26,0.88);
      display: flex; align-items: center;
      justify-content: space-between; gap: 8px;
    }
    #gps-status {
      font-family: 'Space Mono', monospace; font-size: 9px;
      color: var(--muted); display: flex; align-items: center; gap: 5px;
      flex: 1; min-width: 0; overflow: hidden;
    }
    #gps-text { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .status-dot {
      width: 6px; height: 6px; border-radius: 50%;
      background: var(--muted); flex-shrink: 0;
    }
    .status-dot.active { background: var(--green); box-shadow: 0 0 6px var(--green); }
    .status-dot.error   { background: var(--red);   box-shadow: 0 0 6px var(--red); }

    #poi-count {
      font-family: 'Space Mono', monospace; font-size: 9px;
      color: var(--muted); white-space: nowrap; flex-shrink: 0;
    }
    #refresh-btn {
      font-family: 'Space Mono', monospace; font-size: 12px;
      color: var(--cyan); background: var(--cyan-dim);
      border: 1px solid var(--cyan-border); border-radius: 16px;
      padding: 4px 12px; cursor: pointer;
      backdrop-filter: blur(8px); transition: background 0.15s; flex-shrink: 0;
    }
    #refresh-btn:active { background: rgba(0,229,255,0.3); }

    /* ‚îÄ‚îÄ DETAIL PANEL ‚îÄ‚îÄ */
    #detail-panel {
      position: fixed; bottom: 100px; left: 14px; right: 14px;
      z-index: 30; background: rgba(2,18,34,0.96);
      border: 1px solid var(--cyan-border); border-radius: 16px;
      padding: 16px 18px; backdrop-filter: blur(20px);
      display: none; pointer-events: auto;
    }
    #detail-panel.visible { display: block; }
    #detail-close {
      position: absolute; top: 10px; right: 14px;
      font-family: 'Space Mono', monospace; font-size: 16px;
      background: none; border: none; color: var(--muted); cursor: pointer;
    }
    #detail-icon { font-size: 26px; margin-bottom: 5px; }
    #detail-name { font-size: 19px; font-weight: 800; color: var(--text); margin-bottom: 3px; }
    #detail-type {
      font-family: 'Space Mono', monospace; font-size: 10px;
      color: var(--cyan); letter-spacing: 0.1em;
      text-transform: uppercase; margin-bottom: 10px;
    }
    #detail-meta { display: flex; gap: 16px; flex-wrap: wrap; }
    .detail-meta-item { display: flex; flex-direction: column; gap: 2px; }
    .detail-meta-label {
      font-family: 'Space Mono', monospace; font-size: 9px;
      color: var(--muted); letter-spacing: 0.08em; text-transform: uppercase;
    }
    .detail-meta-value {
      font-family: 'Space Mono', monospace; font-size: 13px;
      color: var(--text); font-weight: 700;
    }

    /* ‚îÄ‚îÄ STARTUP ‚îÄ‚îÄ */
    #startup {
      position: fixed; inset: 0; z-index: 100;
      background: var(--bg);
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      gap: 24px; padding: 36px;
      overflow-y: auto;
    }
    .startup-logo {
      font-family: 'Syne', sans-serif; font-size: 48px; font-weight: 800;
      color: var(--text); letter-spacing: -0.03em; line-height: 1;
    }
    .startup-logo span { color: var(--cyan); }
    .startup-subtitle {
      font-family: 'Space Mono', monospace; font-size: 11px;
      color: var(--muted); letter-spacing: 0.15em; text-align: center;
    }
    .startup-perms { display: flex; flex-direction: column; gap: 8px; width: 100%; }

    .perm-item {
      display: flex; align-items: center; gap: 12px;
      background: rgba(0,229,255,0.05); border: 1px solid var(--cyan-border);
      border-radius: 12px; padding: 11px 14px; font-size: 13px; color: var(--muted);
    }
    .perm-item .perm-icon { font-size: 20px; flex-shrink: 0; }
    .perm-item .perm-status {
      margin-left: auto; font-family: 'Space Mono', monospace;
      font-size: 10px; color: var(--muted);
    }
    .perm-item.ok     { border-color: rgba(34,211,160,0.45); }
    .perm-item.ok .perm-status { color: var(--green); }
    .perm-item.denied { border-color: rgba(255,77,109,0.45); }
    .perm-item.denied .perm-status { color: var(--red); }

    /* GPS error help */
    #gps-help {
      display: none; width: 100%;
      background: rgba(255,77,109,0.07);
      border: 1px solid rgba(255,77,109,0.3);
      border-radius: 12px; padding: 14px 16px;
    }
    #gps-help.visible { display: block; }
    #gps-help-title {
      font-weight: 700; font-size: 13px; color: var(--red); margin-bottom: 8px;
    }
    #gps-help-body {
      font-family: 'Space Mono', monospace; font-size: 10px;
      color: var(--muted); line-height: 1.9; white-space: pre-line;
    }
    #gps-retry-btn {
      margin-top: 10px; width: 100%;
      background: rgba(255,77,109,0.12);
      border: 1px solid rgba(255,77,109,0.4);
      border-radius: 10px; padding: 9px;
      font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 700;
      color: var(--red); cursor: pointer; transition: background 0.15s;
    }
    #gps-retry-btn:active { background: rgba(255,77,109,0.28); }

    #start-btn {
      width: 100%; background: var(--cyan); color: var(--bg);
      border: none; border-radius: 14px; padding: 15px;
      font-family: 'Syne', sans-serif; font-size: 16px; font-weight: 800;
      cursor: pointer; letter-spacing: 0.05em; transition: opacity 0.2s;
    }
    #start-btn:disabled { opacity: 0.45; cursor: not-allowed; }
    #start-btn:not(:disabled):active { opacity: 0.8; }

    /* ‚îÄ‚îÄ LOADING ‚îÄ‚îÄ */
    #loading-ring {
      position: fixed; top: 50%; left: 50%;
      transform: translate(-50%, -50%); z-index: 25; display: none;
    }
    #loading-ring.on { display: block; }
    #loading-ring svg { animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    #compass-warning {
      position: fixed; top: 108px; left: 50%; transform: translateX(-50%);
      z-index: 25; background: rgba(251,191,36,0.13);
      border: 1px solid rgba(251,191,36,0.45); border-radius: 20px;
      padding: 5px 14px; font-family: 'Space Mono', monospace;
      font-size: 10px; color: var(--gold); pointer-events: auto; cursor: pointer; display: none;
    }
  </style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     STARTUP
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="startup">
  <div style="text-align:center">
    <div class="startup-logo">HORI<span>ZON</span></div>
    <div class="startup-subtitle" style="margin-top:6px">CE QUI EST DEVANT VOUS</div>
  </div>

  <div class="startup-perms">
    <div class="perm-item" id="perm-camera">
      <span class="perm-icon">üì∑</span>
      <span>Cam√©ra</span>
      <span class="perm-status">EN ATTENTE</span>
    </div>
    <div class="perm-item" id="perm-gps">
      <span class="perm-icon">üìç</span>
      <span>Localisation GPS</span>
      <span class="perm-status">EN ATTENTE</span>
    </div>
    <div class="perm-item" id="perm-compass">
      <span class="perm-icon">üß≠</span>
      <span>Boussole / Orientation</span>
      <span class="perm-status">EN ATTENTE</span>
    </div>
  </div>

  <!-- GPS help block (shown on error) -->
  <div id="gps-help">
    <div id="gps-help-title">‚ö† Localisation refus√©e</div>
    <div id="gps-help-body"></div>
    <button id="gps-retry-btn" onclick="retryGPS()">‚Ü∫ R√©essayer</button>
  </div>

  <button id="start-btn" onclick="initApp()">D√©marrer</button>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     CAMERA + OVERLAYS
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<video id="camera-feed" autoplay playsinline muted></video>
<div class="vignette"></div>

<div id="ar-overlay">
  <div class="grid-line-h"></div>
  <div class="grid-line-h"></div>
  <div class="grid-line-v"></div>
  <div class="grid-line-v"></div>
  <div class="crosshair-h"></div>
  <div class="crosshair-v"></div>
  <div class="horizon-line"></div>
  <div id="poi-container"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     COMPASS + HEADING
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="compass-bar">
  <div id="compass-track">
    <div id="compass-center"></div>
  </div>
</div>
<div id="heading-display">---¬∞ N</div>
<div id="compass-warning" onclick="hideCompassWarning()" title="Toucher pour fermer">‚ö† Calibrez la boussole ‚Äî tournez en 8 &nbsp; ‚úï</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     DISTANCE FILTER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="filter-wrap">
  <div class="filter-row" id="cat-filter-row"></div>
  <div class="filter-row" id="dist-filter-row"></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     BOTTOM HUD
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="bottom-hud">
  <div id="gps-status">
    <div class="status-dot" id="gps-dot"></div>
    <span id="gps-text">GPS inactif</span>
  </div>
  <div id="poi-count">‚Äî pts</div>
  <button id="refresh-btn" onclick="refreshPOIs()">‚Üª</button>
</div>

<!-- LOADING -->
<div id="loading-ring">
  <svg width="38" height="38" viewBox="0 0 38 38">
    <circle cx="19" cy="19" r="15" fill="none" stroke="rgba(0,229,255,0.12)" stroke-width="3"/>
    <circle cx="19" cy="19" r="15" fill="none" stroke="#00e5ff" stroke-width="3"
      stroke-dasharray="22 72" stroke-linecap="round"/>
  </svg>
</div>

<!-- DETAIL PANEL -->
<div id="detail-panel">
  <button id="detail-close" onclick="closeDetail()">‚úï</button>
  <div id="detail-icon">üìç</div>
  <div id="detail-name">‚Äî</div>
  <div id="detail-type">‚Äî</div>
  <div id="detail-meta">
    <div class="detail-meta-item">
      <span class="detail-meta-label">Distance</span>
      <span class="detail-meta-value" id="detail-dist">‚Äî</span>
    </div>
    <div class="detail-meta-item">
      <span class="detail-meta-label">Direction</span>
      <span class="detail-meta-value" id="detail-bearing">‚Äî</span>
    </div>
    <div class="detail-meta-item">
      <span class="detail-meta-label">Coordonn√©es</span>
      <span class="detail-meta-value" id="detail-coords">‚Äî</span>
    </div>
  </div>

  <!-- Action buttons -->
  <div id="detail-actions">
    <button class="detail-btn" id="btn-gmaps" onclick="openGoogleMaps()">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
      Google Maps
    </button>
    <button class="detail-btn" id="btn-poi" onclick="loadNearbyPOIs()">
      üîç Lieux √† voir
    </button>
  </div>

  <!-- Nearby POIs list -->
  <div id="nearby-list">
    <div id="nearby-title">LIEUX √Ä PROXIMIT√â</div>
    <div id="nearby-items"></div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  CONFIG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DISTANCES = [
  { label: '500m',  value: 500 },
  { label: '1km',   value: 1000 },
  { label: '2km',   value: 2000 },
  { label: '5km',   value: 5000 },
  { label: '10km',  value: 10000 },
  { label: '25km',  value: 25000 },
  { label: '50km',  value: 50000 },
];

const CATEGORIES = [
  { id: 'all',       label: 'üåê Tout',        color: '#00e5ff' },
  { id: 'city',      label: 'üèô Villes',       color: '#a78bfa' },
  { id: 'coast',     label: 'üó∫ C√¥te & Caps',  color: '#38bdf8' },
  { id: 'island',    label: 'üèù √éles',         color: '#34d399' },
  { id: 'mountain',  label: '‚õ∞ Montagnes',    color: '#fb923c' },
  { id: 'forest',    label: 'üå≤ For√™ts',       color: '#4ade80' },
  { id: 'lighthouse',label: 'üóº Phares',       color: '#fbbf24' },
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const state = {
  userLat: null, userLng: null,
  heading: null,
  allPois: [],
  pois: [],
  compassSource: null,
  gpsReady: false,
  lastFetchLat: null, lastFetchLng: null,
  maxDist: 50000,
  activeCat: 'all',
  detailPoi: null,
};

const FOV = 75;
const FOV_HALF = FOV / 2;

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FILTERS ‚Äî distance + category
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildFilters() {
  // Category pills
  const catBar = document.getElementById('cat-filter-row');
  catBar.innerHTML = '';
  CATEGORIES.forEach(c => {
    const btn = document.createElement('button');
    btn.className = 'cat-pill' + (c.id === state.activeCat ? ' active' : '');
    btn.textContent = c.label;
    btn.style.setProperty('--cat-color', c.color);
    btn.addEventListener('click', () => selectCat(c.id));
    catBar.appendChild(btn);
  });

  // Distance pills
  const distBar = document.getElementById('dist-filter-row');
  distBar.innerHTML = '';
  DISTANCES.forEach(d => {
    const btn = document.createElement('button');
    btn.className = 'dist-pill' + (d.value === state.maxDist ? ' active' : '');
    btn.textContent = d.label;
    btn.addEventListener('click', () => selectDist(d.value));
    distBar.appendChild(btn);
  });
}

function selectCat(id) {
  state.activeCat = id;
  document.querySelectorAll('.cat-pill').forEach((btn, i) => {
    btn.classList.toggle('active', CATEGORIES[i].id === id);
  });
  applyFilter();
}

function selectDist(m) {
  state.maxDist = m;
  document.querySelectorAll('.dist-pill').forEach((btn, i) => {
    btn.classList.toggle('active', DISTANCES[i].value === m);
  });
  const needFetch = !state.lastFetchLat || m > 50000;
  if (needFetch) {
    state.lastFetchLat = null;
    if (state.gpsReady) fetchPOIs();
  } else {
    applyFilter();
  }
}

function applyFilter() {
  state.pois = state.allPois.filter(p => {
    if (p.dist > state.maxDist) return false;
    if (state.activeCat === 'all') return true;
    return p.type.cat === state.activeCat;
  });
  poiElements.forEach(el => el.remove());
  poiElements.clear();
  updatePoiCount();
}

function updatePoiCount() {
  document.getElementById('poi-count').textContent =
    `${state.pois.length} pt${state.pois.length !== 1 ? 's' : ''}`;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function initApp() {
  const btn = document.getElementById('start-btn');
  btn.disabled = true;
  btn.textContent = 'Initialisation‚Ä¶';

  // 1. Camera
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } },
      audio: false
    });
    document.getElementById('camera-feed').srcObject = stream;
    setPermStatus('camera', 'ok');
  } catch(e) {
    setPermStatus('camera', 'denied');
    alert('Cam√©ra non disponible : ' + e.message);
    btn.disabled = false; btn.textContent = 'D√©marrer';
    return;
  }

  // 2. GPS
  if (!navigator.geolocation) {
    setPermStatus('gps', 'denied');
    showGPSHelp('not_supported');
  } else {
    setPermStatus('gps', 'waiting');
    startGPS();
  }

  // 3. Compass
  if (typeof DeviceOrientationEvent !== 'undefined' &&
      typeof DeviceOrientationEvent.requestPermission === 'function') {
    try {
      const p = await DeviceOrientationEvent.requestPermission();
      if (p === 'granted') {
        window.addEventListener('deviceorientation', onOrientation, true);
        setPermStatus('compass', 'ok');
      } else {
        setPermStatus('compass', 'denied');
      }
    } catch(e) { setPermStatus('compass', 'denied'); }
  } else {
    window.addEventListener('deviceorientationabsolute', onOrientationAbsolute, true);
    window.addEventListener('deviceorientation', onOrientation, true);
    setPermStatus('compass', 'ok');
  }

  buildFilters();

  // Fade out startup
  const startup = document.getElementById('startup');
  startup.style.transition = 'opacity 0.5s';
  startup.style.opacity = '0';
  setTimeout(() => startup.style.display = 'none', 500);

  renderLoop();
}

// ‚îÄ‚îÄ GPS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function startGPS() {
  // 1. Check permission state before asking (avoids silent denial)
  if (navigator.permissions) {
    try {
      const perm = await navigator.permissions.query({ name: 'geolocation' });
      if (perm.state === 'denied') {
        // Already blocked ‚Äî can't re-prompt, must go to settings
        setPermStatus('gps', 'denied');
        showGPSHelp(1); // code 1 = PERMISSION_DENIED
        document.getElementById('gps-dot').classList.add('error');
        document.getElementById('gps-text').textContent = 'GPS refus√© ‚Äî voir aide';
        return;
      }
      // If 'granted' or 'prompt', continue normally
    } catch(e) { /* permissions API not fully supported, continue anyway */ }
  }

  // 2. Actually request position
  navigator.geolocation.getCurrentPosition(
    pos => {
      onGPS(pos);
      setPermStatus('gps', 'ok');
      document.getElementById('gps-help').classList.remove('visible');
      // Keep watching
      navigator.geolocation.watchPosition(onGPS, onGPSWatchError, {
        enableHighAccuracy: true, maximumAge: 5000, timeout: 20000
      });
    },
    err => {
      setPermStatus('gps', 'denied');
      showGPSHelp(err.code);
      document.getElementById('gps-dot').classList.add('error');
      document.getElementById('gps-text').textContent = gpsErrMsg(err.code);
    },
    { enableHighAccuracy: true, timeout: 20000, maximumAge: 0 }
  );
}

function retryGPS() {
  document.getElementById('gps-help').classList.remove('visible');
  setPermStatus('gps', 'waiting');
  startGPS();
}

function onGPS(pos) {
  state.userLat = pos.coords.latitude;
  state.userLng = pos.coords.longitude;
  state.gpsReady = true;
  document.getElementById('gps-dot').classList.remove('error');
  document.getElementById('gps-dot').classList.add('active');
  const acc = Math.round(pos.coords.accuracy);
  document.getElementById('gps-text').textContent =
    `${state.userLat.toFixed(5)}, ${state.userLng.toFixed(5)} ¬±${acc}m`;
  const moved = state.lastFetchLat !== null
    ? haversine(state.userLat, state.userLng, state.lastFetchLat, state.lastFetchLng)
    : Infinity;
  if (moved > 200) fetchPOIs();
}

function onGPSWatchError(err) {
  document.getElementById('gps-dot').classList.remove('active');
  document.getElementById('gps-dot').classList.add('error');
  document.getElementById('gps-text').textContent = gpsErrMsg(err.code);
}

function gpsErrMsg(code) {
  return { 1: 'GPS refus√©', 2: 'GPS indisponible', 3: 'GPS : d√©lai d√©pass√©' }[code] || 'Erreur GPS';
}

function showGPSHelp(code) {
  const panel = document.getElementById('gps-help');
  const body  = document.getElementById('gps-help-body');
  const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
  const isAndroid = /Android/.test(navigator.userAgent);

  let msg = '';
  if (code === 1 || code === 'denied') {
    if (isIOS) {
      msg =
        'La localisation a √©t√© refus√©e. Pour corriger :\n\n' +
        '1. Ouvre l\'app R√©glages (‚öôÔ∏è)\n' +
        '2. Confidentialit√© & S√©curit√©\n' +
        '   ‚Üí Service de localisation\n' +
        '3. Trouve Safari dans la liste\n' +
        '   ‚Üí choisis ¬´ Lors de l\'utilisation ¬ª\n' +
        '4. Reviens sur cette page et\n' +
        '   appuie sur ‚Ü∫ R√©essayer';
    } else if (isAndroid) {
      msg =
        'La localisation a √©t√© refus√©e. Pour corriger :\n\n' +
        'Option 1 ‚Äî Barre d\'adresse :\n' +
        '  Appuie sur üîí ou ‚ìò ‚Üí Autorisations\n' +
        '  ‚Üí Localisation ‚Üí Autoriser\n\n' +
        'Option 2 ‚Äî R√©glages Android :\n' +
        '  Applis ‚Üí Chrome/navigateur\n' +
        '  ‚Üí Autorisations ‚Üí Localisation\n\n' +
        'Puis recharge la page et R√©essayer.';
    } else {
      msg =
        'La localisation a √©t√© refus√©e.\n\n' +
        'Clique sur l\'ic√¥ne üîí ou ‚ìò dans\n' +
        'la barre d\'adresse de ton navigateur,\n' +
        'puis autorise la localisation.\nEnsuite appuie sur R√©essayer.';
    }
  } else if (code === 2) {
    msg = 'Signal GPS indisponible.\n\nV√©rifie que la localisation est\nactiv√©e dans les r√©glages de\nton t√©l√©phone, puis R√©essayer.';
  } else if (code === 3) {
    msg = 'D√©lai GPS d√©pass√©.\n\nAssure-toi d\'√™tre en ext√©rieur\navec le GPS activ√©, puis R√©essayer.';
  } else {
    msg = 'GPS non support√© par ce navigateur.\nEssaie avec Safari (iOS) ou Chrome (Android).';
  }
  body.textContent = msg;
  panel.classList.add('visible');
}

function setPermStatus(perm, status) {
  const el = document.getElementById('perm-' + perm);
  const st = el.querySelector('.perm-status');
  el.classList.remove('ok', 'denied');
  if (status === 'ok') {
    el.classList.add('ok'); st.textContent = 'OK';
  } else if (status === 'denied') {
    el.classList.add('denied'); st.textContent = 'REFUS√â';
  } else {
    st.textContent = 'EN ATTENTE‚Ä¶';
  }
}

// ‚îÄ‚îÄ Compass ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function onOrientationAbsolute(e) {
  if (e.alpha === null) return;
  state.heading = (360 - e.alpha + 360) % 360;
  state.compassSource = 'absolute';
}
let relativeWarningTimer = null;

function onOrientation(e) {
  if (state.compassSource === 'absolute') {
    hideCompassWarning();
    return;
  }
  if (e.webkitCompassHeading != null) {
    state.heading = e.webkitCompassHeading;
    state.compassSource = 'ios';
    hideCompassWarning();
    return;
  }
  if (e.alpha !== null) {
    state.heading = (360 - e.alpha + 360) % 360;
    if (!state.compassSource) {
      state.compassSource = 'relative';
      // Wait 4s before showing warning ‚Äî absolute source may still kick in
      if (!relativeWarningTimer) {
        relativeWarningTimer = setTimeout(() => {
          if (state.compassSource === 'relative') {
            const w = document.getElementById('compass-warning');
            w.style.display = 'block';
            // Auto-hide after 8s
            setTimeout(() => { w.style.display = 'none'; }, 8000);
          }
        }, 4000);
      }
    }
  }
}

function hideCompassWarning() {
  if (relativeWarningTimer) { clearTimeout(relativeWarningTimer); relativeWarningTimer = null; }
  document.getElementById('compass-warning').style.display = 'none';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FETCH POIs ‚Äî always fetches 50km max radius
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function fetchPOIs() {
  if (!state.userLat) return;
  document.getElementById('loading-ring').classList.add('on');

  const lat = state.userLat, lng = state.userLng;
  const radius = 50000; // always fetch max, filter client-side

  const query = `
[out:json][timeout:30];
(
  node["place"~"^(island|islet|city|town|village|hamlet|suburb)$"](around:${radius},${lat},${lng});
  node["natural"~"^(peak|volcano|cliff|cape|bay|strait|peninsula)$"](around:${radius},${lat},${lng});
  node["natural"="wood"]["name"](around:${radius},${lat},${lng});
  node["landuse"="forest"]["name"](around:${radius},${lat},${lng});
  node["man_made"="lighthouse"](around:${radius},${lat},${lng});
  way["place"~"^(island|islet)$"](around:${radius},${lat},${lng});
  way["natural"="wood"]["name"](around:${radius},${lat},${lng});
  way["landuse"="forest"]["name"](around:${radius},${lat},${lng});
  relation["place"~"^(island|islet)$"](around:${radius},${lat},${lng});
  relation["natural"="wood"]["name"](around:${radius},${lat},${lng});
);
out center 400;
  `.trim();

  try {
    const resp = await fetch('https://overpass-api.de/api/interpreter', {
      method: 'POST', body: query
    });
    const data = await resp.json();
    processPOIs(data.elements, lat, lng);
    state.lastFetchLat = lat;
    state.lastFetchLng = lng;
  } catch(e) {
    console.warn('Overpass error:', e);
    document.getElementById('poi-count').textContent = 'Erreur r√©seau';
  } finally {
    document.getElementById('loading-ring').classList.remove('on');
  }
}

function processPOIs(elements, userLat, userLng) {
  const seen = new Set(), results = [];
  for (const el of elements) {
    const eLat = el.lat ?? el.center?.lat;
    const eLng = el.lon ?? el.center?.lon;
    if (!eLat || !eLng) continue;
    const name = el.tags?.name || el.tags?.['name:fr'];
    if (!name || seen.has(name)) continue;
    seen.add(name);
    const dist = haversine(userLat, userLng, eLat, eLng);
    if (dist < 50) continue;
    results.push({
      name, lat: eLat, lng: eLng, dist,
      bearing: calcBearing(userLat, userLng, eLat, eLng),
      type: classifyPOI(el.tags, name)
    });
  }
  results.sort((a, b) => a.dist - b.dist);
  state.allPois = results.slice(0, 300);
  applyFilter();
}

function classifyPOI(tags, name) {
  if (!tags) return { emoji: 'üìç', label: 'Lieu', cat: 'all' };
  const p = tags.place, n = tags.natural, m = tags.man_made, lu = tags.landuse;
  const nm = (name || '').toLowerCase();

  // Forest
  if (n === 'wood' || lu === 'forest')
    return { emoji: 'üå≤', label: 'For√™t', cat: 'forest' };

  // Lighthouse
  if (m === 'lighthouse')
    return { emoji: 'üóº', label: 'Phare', cat: 'lighthouse' };

  // Islands
  if (p === 'island' || p === 'islet')
    return { emoji: 'üèùÔ∏è', label: '√éle', cat: 'island' };

  // Coastal features ‚Äî detect "pointe", "pointe de", "tas de", "presqu'√Æle" by name too
  if (n === 'cape' || n === 'peninsula' ||
      nm.startsWith('pointe') || nm.startsWith('cap ') || nm.startsWith('cap-') ||
      nm.startsWith('raz ') || nm === 'pointe du raz' ||
      nm.includes("presqu'√Æle") || nm.includes('presquile') ||
      nm.includes('tas de'))
    return { emoji: 'üó∫Ô∏è', label: 'Cap / Pointe', cat: 'coast' };

  if (n === 'bay')   return { emoji: 'üåä', label: 'Baie', cat: 'coast' };
  if (n === 'strait') return { emoji: '„Ä∞Ô∏è', label: 'D√©troit', cat: 'coast' };
  if (n === 'cliff') return { emoji: 'ü™®', label: 'Falaise', cat: 'coast' };

  // Mountains
  if (n === 'peak' || n === 'volcano')
    return { emoji: '‚õ∞Ô∏è', label: 'Sommet', cat: 'mountain' };

  // Cities / towns
  if (p === 'city')   return { emoji: 'üèôÔ∏è', label: 'Ville', cat: 'city' };
  if (p === 'town')   return { emoji: 'üèòÔ∏è', label: 'Bourg', cat: 'city' };
  if (p === 'village' || p === 'hamlet' || p === 'suburb')
    return { emoji: 'üè°', label: 'Village', cat: 'city' };

  return { emoji: 'üìç', label: 'Lieu', cat: 'all' };
}

function refreshPOIs() {
  state.lastFetchLat = null;
  if (state.gpsReady) fetchPOIs();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  RENDER LOOP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const COMPASS_POINTS = [
  { deg:   0, label:'N'   }, { deg:  22.5, label:'NNE' },
  { deg:  45, label:'NE'  }, { deg:  67.5, label:'ENE' },
  { deg:  90, label:'E'   }, { deg: 112.5, label:'ESE' },
  { deg: 135, label:'SE'  }, { deg: 157.5, label:'SSE' },
  { deg: 180, label:'S'   }, { deg: 202.5, label:'SSO' },
  { deg: 225, label:'SO'  }, { deg: 247.5, label:'OSO' },
  { deg: 270, label:'O'   }, { deg: 292.5, label:'ONO' },
  { deg: 315, label:'NO'  }, { deg: 337.5, label:'NNO' },
];
let compassBuilt = false;

function renderLoop() {
  if (!compassBuilt) {
    const track = document.getElementById('compass-track');
    COMPASS_POINTS.forEach(p => {
      const el = document.createElement('div');
      el.className = 'compass-label' + ([0,90,180,270].includes(p.deg) ? ' cardinal' : '');
      el.textContent = p.label;
      el.dataset.deg = p.deg;
      track.appendChild(el);
    });
    compassBuilt = true;
  }

  if (state.heading !== null) {
    // Compass bar
    const W = document.getElementById('compass-track').offsetWidth;
    document.querySelectorAll('.compass-label').forEach(el => {
      const diff = normalizeDeg(parseFloat(el.dataset.deg) - state.heading);
      const x = W / 2 + diff / FOV * W;
      if (x < -40 || x > W + 40) { el.style.display = 'none'; return; }
      el.style.display = '';
      el.style.left = x + 'px';
      el.style.opacity = Math.max(0, 1 - Math.abs(diff) / FOV_HALF * 0.8);
    });

    // Heading label
    const h = Math.round(state.heading);
    document.getElementById('heading-display').textContent =
      `${h.toString().padStart(3,'0')}¬∞ ${cardinal(h)}`;

    // POI labels
    if (state.gpsReady) updatePOILabels();
  }

  requestAnimationFrame(renderLoop);
}

// ‚îÄ‚îÄ POI labels ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const poiContainer = document.getElementById('poi-container');
const poiElements  = new Map();
const POI_TOPS = [28, 35, 42, 22, 48];

function updatePOILabels() {
  const W = window.innerWidth;
  const visible = [];

  for (const poi of state.pois) {
    const diff = normalizeDeg(poi.bearing - state.heading);
    if (Math.abs(diff) > FOV_HALF * 1.2) continue;
    visible.push({ poi, diff });
  }

  // Remove invisible
  for (const [name, el] of poiElements) {
    if (!visible.find(v => v.poi.name === name)) { el.remove(); poiElements.delete(name); }
  }

  // Add / move
  for (const { poi, diff } of visible) {
    let el = poiElements.get(poi.name);
    if (!el) {
      el = buildPOIEl(poi);
      poiContainer.appendChild(el);
      poiElements.set(poi.name, el);
    }
    el.style.left = (W / 2 + (diff / FOV_HALF) * (W / 2)) + 'px';
    const abs = Math.abs(diff);
    el.dataset.fade = abs > FOV_HALF * 0.7 ? 3 : abs > FOV_HALF * 0.4 ? 2 : 1;
  }
}

function buildPOIEl(poi) {
  const el = document.createElement('div');
  el.className = 'poi-label';
  const hash = poi.name.split('').reduce((a, c) => a + c.charCodeAt(0), 0);
  el.style.top = POI_TOPS[hash % POI_TOPS.length] + '%';

  el.innerHTML = `
    <div class="poi-connector"></div>
    <div class="poi-card">
      <span class="poi-type-icon">${poi.type.emoji}</span>
      <div class="poi-name">${poi.name}</div>
      <div class="poi-distance">${fmtDist(poi.dist)}</div>
    </div>
  `;
  el.addEventListener('click', () => openDetail(poi));
  return el;
}

function openDetail(poi) {
  state.detailPoi = poi;
  document.getElementById('detail-icon').textContent    = poi.type.emoji;
  document.getElementById('detail-name').textContent    = poi.name;
  document.getElementById('detail-type').textContent    = poi.type.label.toUpperCase();
  document.getElementById('detail-dist').textContent    = fmtDist(poi.dist);
  document.getElementById('detail-bearing').textContent = Math.round(poi.bearing) + '¬∞ ' + cardinal(poi.bearing);
  document.getElementById('detail-coords').textContent  = poi.lat.toFixed(4) + ', ' + poi.lng.toFixed(4);

  // Show "Lieux √† voir" only for cities/towns/villages
  const showPoi = ['city'].includes(poi.type.cat);
  document.getElementById('btn-poi').style.display = showPoi ? '' : 'none';

  // Reset nearby list
  document.getElementById('nearby-list').classList.remove('visible');
  document.getElementById('nearby-items').innerHTML = '';
  document.getElementById('detail-panel').classList.add('visible');
}

function closeDetail() {
  document.getElementById('detail-panel').classList.remove('visible');
  document.getElementById('nearby-list').classList.remove('visible');
}

function openGoogleMaps() {
  const poi = state.detailPoi;
  if (!poi) return;
  // Opens directions from user location to the POI
  const url = `https://www.google.com/maps/dir/?api=1&origin=${state.userLat},${state.userLng}&destination=${poi.lat},${poi.lng}&travelmode=driving`;
  window.open(url, '_blank');
}

async function loadNearbyPOIs() {
  const poi = state.detailPoi;
  if (!poi) return;
  const btn = document.getElementById('btn-poi');
  btn.textContent = '‚è≥ Chargement‚Ä¶';
  btn.disabled = true;

  const radius = 3000; // 3km around the city
  const query = `
[out:json][timeout:20];
(
  node["tourism"~"^(attraction|museum|viewpoint|artwork|gallery|zoo|theme_park|monument|castle)$"](around:${radius},${poi.lat},${poi.lng});
  node["historic"~"^(castle|monument|ruins|church|manor|archaeological_site|memorial)$"](around:${radius},${poi.lat},${poi.lng});
  node["amenity"~"^(place_of_worship|theatre|cinema|library)$"]["name"](around:${radius},${poi.lat},${poi.lng});
  node["leisure"~"^(park|garden|nature_reserve|beach_resort)$"]["name"](around:${radius},${poi.lat},${poi.lng});
  node["natural"~"^(beach|cliff|peak|cape)$"]["name"](around:${radius},${poi.lat},${poi.lng});
);
out 30;
  `.trim();

  try {
    const resp = await fetch('https://overpass-api.de/api/interpreter', { method:'POST', body:query });
    const data = await resp.json();
    const items = data.elements
      .filter(e => e.tags?.name)
      .map(e => ({ name: e.tags.name, tags: e.tags }))
      .filter((e, i, arr) => arr.findIndex(x => x.name === e.name) === i)
      .slice(0, 15);

    const container = document.getElementById('nearby-items');
    container.innerHTML = '';

    if (items.length === 0) {
      container.innerHTML = '<div style="font-family:Space Mono,monospace;font-size:10px;color:var(--muted);padding:8px">Aucun lieu r√©f√©renc√© trouv√©.</div>';
    } else {
      items.forEach(item => {
        const { emoji, label } = classifyNearbyTags(item.tags);
        const div = document.createElement('div');
        div.className = 'nearby-item';
        div.innerHTML = `
          <span class="nearby-item-icon">${emoji}</span>
          <span class="nearby-item-name">${item.name}</span>
          <span class="nearby-item-type">${label}</span>
        `;
        // Tap ‚Üí open in Google Maps search
        div.addEventListener('click', () => {
          window.open(`https://www.google.com/maps/search/${encodeURIComponent(item.name + ' ' + poi.name)}`, '_blank');
        });
        container.appendChild(div);
      });
    }

    document.getElementById('nearby-list').classList.add('visible');
  } catch(e) {
    document.getElementById('nearby-items').innerHTML =
      '<div style="font-family:Space Mono,monospace;font-size:10px;color:var(--red);padding:8px">Erreur r√©seau.</div>';
    document.getElementById('nearby-list').classList.add('visible');
  } finally {
    btn.textContent = 'üîç Lieux √† voir';
    btn.disabled = false;
  }
}

function classifyNearbyTags(tags) {
  const t = tags.tourism, h = tags.historic, a = tags.amenity, l = tags.leisure, n = tags.natural;
  if (t === 'museum')           return { emoji: 'üèõ', label: 'Mus√©e' };
  if (t === 'viewpoint')        return { emoji: 'üëÅ', label: 'Panorama' };
  if (t === 'attraction' || t === 'monument') return { emoji: '‚≠ê', label: 'Attraction' };
  if (t === 'artwork')          return { emoji: 'üé®', label: 'Art' };
  if (t === 'castle' || h === 'castle' || h === 'manor') return { emoji: 'üè∞', label: 'Ch√¢teau' };
  if (h === 'church' || a === 'place_of_worship') return { emoji: '‚õ™', label: 'Religieux' };
  if (h === 'ruins' || h === 'archaeological_site') return { emoji: 'üèö', label: 'Ruines' };
  if (h === 'memorial' || h === 'monument') return { emoji: 'üóø', label: 'Monument' };
  if (l === 'park' || l === 'garden')       return { emoji: 'üå≥', label: 'Parc' };
  if (l === 'nature_reserve')               return { emoji: 'üåø', label: 'R√©serve' };
  if (n === 'beach')            return { emoji: 'üèñ', label: 'Plage' };
  if (n === 'peak')             return { emoji: '‚õ∞', label: 'Sommet' };
  if (a === 'theatre' || a === 'cinema')    return { emoji: 'üé≠', label: 'Culture' };
  return { emoji: 'üìç', label: 'Lieu' };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GEO UTILS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2)**2 +
    Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) * Math.sin(dLon/2)**2;
  return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
}
function calcBearing(lat1, lon1, lat2, lon2) {
  const œÜ1 = lat1*Math.PI/180, œÜ2 = lat2*Math.PI/180;
  const ŒîŒª = (lon2-lon1)*Math.PI/180;
  return (Math.atan2(
    Math.sin(ŒîŒª)*Math.cos(œÜ2),
    Math.cos(œÜ1)*Math.sin(œÜ2) - Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(ŒîŒª)
  ) * 180/Math.PI + 360) % 360;
}
function normalizeDeg(d) {
  d = ((d % 360) + 360) % 360;
  return d > 180 ? d - 360 : d;
}
function cardinal(deg) {
  return ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSO','SO','OSO','O','ONO','NO','NNO']
    [Math.round(deg / 22.5) % 16];
}
function fmtDist(m) {
  return m < 1000 ? Math.round(m) + ' m' : (m/1000).toFixed(1) + ' km';
}
</script>
</body>
</html>
